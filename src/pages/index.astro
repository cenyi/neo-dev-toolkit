---
import BaseLayout from '../layouts/BaseLayout.astro';
import Sidebar from '../components/Sidebar.astro';
import { locales } from '../i18n/locales.js';

// è·å–è¯­è¨€å‚æ•°
const url = new URL(Astro.request.url);
const lang = url.searchParams.get('lang') || 'en';
const t = locales[lang] || locales.en;

// JSON ç¤ºä¾‹æ•°æ®
const sampleJson = {
  "name": "JSON Formatter",
  "version": "1.0.0",
  "features": [
    "Format JSON",
    "Convert from XML/YAML",
    "Extract fields with JS functions"
  ],
  "author": {
    "name": "Dev Team",
    "email": "team@example.com"
  }
};
---

<BaseLayout title={`${t.title} | ${t.description}`} lang={lang}>
  <Sidebar slot="sidebar" t={t} />

  <div class="json-formatter-container"
       data-enter-extraction-fn={t.enterExtractionFn}
       data-enter-data={t.enterData}
       data-extraction-error={t.extractionError}
       data-parsing-error={t.parsingError}
       data-compress-success={t.compressSuccess}
       data-escape-success={t.escapeSuccess}
       data-xml-success={t.xmlSuccess}
       data-ts-success={t.tsSuccess}>

    <div class="editor-workspace">
      <!-- å·¦ä¾§è¾“å…¥åŒºåŸŸ -->
      <div class="input-area">
        <div class="input-section">
          <div class="section-label">JSON viewer All in one</div>
          <div class="input-editor-wrapper">
            <div class="line-numbers" id="line-numbers"></div>
            <textarea
              id="json-input"
              class="json-input"
              placeholder={t.inputPlaceholder}
            ></textarea>
          </div>
        </div>

        <div class="extraction-section">
          <div class="extraction-controls">
            <label for="extract-fn">ğŸ“Š {t.extractionLabel}</label>
            <input
              type="text"
              id="extract-fn"
              placeholder={t.extractionPlaceholder}
            />
            <button id="apply-extract">{t.apply}</button>
          </div>
        </div>

        <div class="output-controls">
          <button id="collapse-all">{t.collapseAll}</button>
          <button id="expand-all">{t.expandAll}</button>
          <button id="remove-comments">{t.removeComments}</button>
          <button id="compress-copy">{t.compressCopy}</button>
          <button id="escape-copy">{t.escapeCopy}</button>
          <button id="json-to-xml">{t.jsonToXml}</button>
          <button id="json-to-ts">{t.jsonToTs}</button>
          <button id="clear-btn">{t.clear}</button>
          <button id="history-btn">History</button>
        </div>
      </div>

      <!-- å³ä¾§è¾“å‡ºåŒºåŸŸ -->
      <div class="output-area" id="output-area">
        <div class="output-header">
          <span class="output-title" id="output-title">è¾“å‡ºç»“æœ</span>
          <button class="close-output-btn" id="close-output" title="å…³é—­">Ã—</button>
        </div>
        <div class="output-content" id="output-content">
          <div class="output-editor-wrapper">
            <div class="output-line-numbers" id="output-line-numbers"></div>
            <div id="output-json"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .json-formatter-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 12px;
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
  }

  /* ä¸»å·¥ä½œåŒº - å·¦å³å¸ƒå±€ */
  .editor-workspace {
    display: flex;
    gap: 0;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* å·¦ä¾§è¾“å…¥åŒºåŸŸ */
  .input-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0 auto;
    max-width: 50%;
  }

  /* å½“è¾“å‡ºåŒºåŸŸå±•å¼€æ—¶ï¼Œè°ƒæ•´å¸ƒå±€ */
  .output-area.expanded {
    flex: 1;
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  /* å½“è¾“å‡ºåŒºåŸŸå±•å¼€æ—¶ï¼Œè¾“å…¥åŒºåŸŸä¹Ÿè°ƒæ•´ä¸º50% */
  .editor-workspace:has(.output-area.expanded) .input-area {
    flex: 1;
    max-width: 100%;
    margin: 0;
  }

  .input-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .section-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .input-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    overflow: hidden;
    flex: 1;
  }

  .line-numbers {
    background: #f6f8fa;
    padding: 12px 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    color: #6b7280;
    user-select: none;
    border-right: 1px solid #e1e4e8;
    min-width: 40px;
    text-align: right;
    overflow: hidden;
    white-space: pre;
  }

  .json-input {
    flex: 1;
    width: 100%;
    min-height: 300px;
    padding: 12px;
    border: none;
    border-radius: 0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    resize: none;
    background: #fafbfc;
    color: var(--text-color);
    transition: all 0.2s;
  }

  .json-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    background: #fff;
  }

  /* æå–åŒºåŸŸ */
  .extraction-section {
    padding: 10px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }

  .extraction-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .extraction-controls label {
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    font-size: 0.85rem;
  }

  .extraction-controls input {
    flex: 1;
    min-width: 200px;
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 13px;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: all 0.2s;
  }

  .extraction-controls input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .extraction-controls button {
    padding: 6px 14px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
  }

  .extraction-controls button:hover {
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    transform: translateY(-1px);
  }

  /* æŒ‰é’®ç»„ */
  .output-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .output-controls button {
    padding: 6px 10px;
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .output-controls button:hover {
    background: linear-gradient(135deg, #475569 0%, #334155 100%);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  #clear-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  #clear-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  }

  /* å³ä¾§è¾“å‡ºåŒºåŸŸ */
  .output-area {
    width: 0;
    opacity: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 1px solid transparent;
  }

  .output-area.expanded {
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px 6px 0 0;
    border: 1px solid #e9ecef;
    border-bottom: none;
  }

  .output-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .close-output-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #9ca3af;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
    line-height: 1;
  }

  .close-output-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  /* è¾“å‡ºå†…å®¹åŒºåŸŸï¼Œä¸è¾“å…¥æ¡†ç›¸åŒæ ·å¼ */
  .output-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .output-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
    flex: 1;
    background: linear-gradient(to bottom, #fafbfc 0%, #f5f6f8 100%);
  }

  .output-line-numbers {
    background: #f6f8fa;
    padding: 12px 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    color: #6b7280;
    user-select: none;
    border-right: 1px solid #e1e4e8;
    min-width: 40px;
    text-align: right;
    overflow: hidden;
    white-space: pre;
  }

  #output-json {
    flex: 1;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow: auto;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    min-height: 0;
  }

  /* JSONæ ‘å½¢æŸ¥çœ‹å™¨æ ·å¼ */
  .json-root {
    padding: 5px 0;
  }

  .json-bracket {
    padding: 0 5px;
  }

  .json-node {
    margin-left: 18px;
  }

  .json-property {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 2px 0;
    border-radius: 3px;
    transition: background 0.1s;
  }

  .json-property:hover {
    background: rgba(59, 130, 246, 0.05);
  }

  .json-toggle {
    display: inline-block;
    width: 14px;
    height: 14px;
    text-align: center;
    line-height: 12px;
    cursor: pointer;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    margin-right: 6px;
    font-size: 10px;
    user-select: none;
    background: #fff;
    color: #6b7280;
    transition: all 0.15s;
  }

  .json-toggle:hover {
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .json-key {
    color: #7c3aed;
    margin-right: 6px;
    font-weight: 500;
  }

  .json-separator {
    margin-right: 6px;
    color: #94a3b8;
  }

  .json-value-string {
    color: #059669;
  }

  .json-value-number {
    color: #dc2626;
  }

  .json-value-boolean {
    color: #2563eb;
  }

  .json-value-null {
    color: #9ca3af;
  }

  .json-value-object,
  .json-value-array {
    color: #1f2937;
  }

  .collapsed > .json-node {
    display: none;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1200px) {
    .output-area.expanded {
      width: 60%;
    }
  }

  @media (max-width: 768px) {
    .json-formatter-container {
      padding: 8px;
      height: calc(100vh - 32px);
    }

    .editor-workspace {
      flex-direction: column;
    }

    .input-area {
      gap: 8px;
    }

    .extraction-controls {
      flex-wrap: wrap;
    }

    .extraction-controls input {
      min-width: 100%;
    }

    .json-input {
      min-height: 200px;
    }

    .output-controls {
      gap: 5px;
    }

    .output-controls button {
      padding: 6px 10px;
      font-size: 11px;
    }

    .output-area.expanded {
      width: 100%;
      border-left: none;
      padding-left: 0;
      margin-top: 12px;
      height: 300px;
    }
  }

  @media (max-width: 480px) {
    .json-formatter-container {
      padding: 6px;
    }

    .output-controls {
      gap: 4px;
    }

    .output-controls button {
      flex: 1;
      min-width: 0;
      padding: 6px 8px;
      font-size: 11px;
    }

    .json-action-group {
      flex: 1;
    }

    .json-input {
      min-height: 150px;
      font-size: 12px;
    }

    .extraction-section {
      padding: 8px;
    }
  }
</style>

<script>
  // å…¨å±€ç¿»è¯‘å¯¹è±¡
  let translations = {};

  // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // ä»DOMå…ƒç´ è·å–ç¿»è¯‘æ–‡æœ¬
    const container = document.querySelector('.json-formatter-container');
    translations = {
      enterExtractionFn: container.dataset.enterExtractionFn,
      enterData: container.dataset.enterData,
      extractionError: container.dataset.extractionError,
      parsingError: container.dataset.parsingError,
      compressSuccess: container.dataset.compressSuccess,
      escapeSuccess: container.dataset.escapeSuccess,
      xmlSuccess: container.dataset.xmlSuccess,
      tsSuccess: container.dataset.tsSuccess
    };

    initializeJsonFormatter();
  });

  // è·å–ç¼–è¾‘å™¨å…ƒç´ 
  function getInputEditorElement() {
    return document.getElementById('json-input');
  }

  // è¡Œå·æ›´æ–°å‡½æ•°
  function updateLineNumbers() {
    const textarea = document.getElementById('json-input');
    const lineNumbers = document.getElementById('line-numbers');
    const lines = textarea.value.split('\n').length;
    
    let lineNumbersHTML = '';
    for (let i = 1; i <= lines; i++) {
      lineNumbersHTML += `${i}\n`;
    }
    
    lineNumbers.textContent = lineNumbersHTML;
  }

  // è¾“å‡ºæ¡†è¡Œå·æ›´æ–°å‡½æ•°
  function updateOutputLineNumbers() {
    const outputJson = document.getElementById('output-json');
    const lineNumbers = document.getElementById('output-line-numbers');
    
    // è®¡ç®—è¾“å‡ºå†…å®¹çš„è¡Œæ•°
    const text = outputJson.textContent || outputJson.innerText;
    const lines = text.split('\n').length;
    
    let lineNumbersHTML = '';
    for (let i = 1; i <= lines; i++) {
      lineNumbersHTML += `${i}\n`;
    }
    
    lineNumbers.textContent = lineNumbersHTML;
    
    // åŒæ­¥æ»šåŠ¨
    outputJson.addEventListener('scroll', () => {
      lineNumbers.scrollTop = outputJson.scrollTop;
    });
  }

  // è‡ªåŠ¨æ ¼å¼åŒ–å‡½æ•°
  function autoFormatJson() {
    const textarea = document.getElementById('json-input');
    const inputText = textarea.value.trim();
    
    if (!inputText) {
      return;
    }
    
    try {
      // å°è¯•è§£æJSON
      const parsed = JSON.parse(inputText);
      // æ ¼å¼åŒ–JSONå¹¶æ›´æ–°è¾“å…¥æ¡†
      const formatted = JSON.stringify(parsed, null, 2);
      
      // ä¿å­˜å…‰æ ‡ä½ç½®
      const cursorPos = textarea.selectionStart;
      const beforeCursor = inputText.substring(0, cursorPos);
      
      textarea.value = formatted;
      updateLineNumbers();
    } catch (e) {
      // å¦‚æœè§£æå¤±è´¥ï¼Œä¸è¿›è¡Œæ ¼å¼åŒ–
      return;
    }
  }

  // åˆå§‹åŒ–è¡Œå·åŠŸèƒ½å’Œè‡ªåŠ¨æ ¼å¼åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const textarea = document.getElementById('json-input');
    const lineNumbers = document.getElementById('line-numbers');
    
    // åˆå§‹æ›´æ–°è¡Œå·
    updateLineNumbers();
    
    // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œæ›´æ–°è¡Œå·å’Œè‡ªåŠ¨æ ¼å¼åŒ–
    textarea.addEventListener('input', () => {
      updateLineNumbers();
      // ä½¿ç”¨é˜²æŠ–å‡½æ•°ï¼Œå»¶è¿Ÿ500msæ‰§è¡Œè‡ªåŠ¨æ ¼å¼åŒ–
      clearTimeout(window.autoFormatTimeout);
      window.autoFormatTimeout = setTimeout(autoFormatJson, 500);
    });
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼ŒåŒæ­¥è¡Œå·æ»šåŠ¨
    textarea.addEventListener('scroll', () => {
      lineNumbers.scrollTop = textarea.scrollTop;
    });
  });

  // JSONæ ‘å½¢æŸ¥çœ‹å™¨
  class JsonViewer {
    constructor(containerId, data) {
      this.container = document.getElementById(containerId);
      if (!this.container) return;

      this.data = data;
      this.render();
      this.bindEvents();
    }

    render() {
      this.container.innerHTML = this.renderValue(this.data, '', true);
    }

    renderValue(value, key = '', hasNext = true) {
      if (value === null) {
        return this.renderProperty(key, `<span class="json-value-null">null</span>`, hasNext);
      }

      if (typeof value === 'object') {
        if (Array.isArray(value)) {
          return this.renderObjectOrArray(key, value, 'array', hasNext);
        } else {
          return this.renderObjectOrArray(key, value, 'object', hasNext);
        }
      }

      if (typeof value === 'string') {
        return this.renderProperty(key, `<span class="json-value-string">"${this.escapeHtml(value)}"</span>`, hasNext);
      }

      if (typeof value === 'number') {
        return this.renderProperty(key, `<span class="json-value-number">${value}</span>`, hasNext);
      }

      if (typeof value === 'boolean') {
        return this.renderProperty(key, `<span class="json-value-boolean">${value}</span>`, hasNext);
      }

      return this.renderProperty(key, value, hasNext);
    }

    renderProperty(key, value, hasNext) {
      if (key === '') {
        if (typeof value === 'object') {
          if (Array.isArray(value)) {
            return this.renderObjectContent(value, 'array');
          } else {
            return this.renderObjectContent(value, 'object');
          }
        }
        return `<div class="json-root">${value}${hasNext ? ',' : ''}</div>`;
      }

      return `
        <div class="json-property">
          <span class="json-toggle">â–¼</span>
          <span class="json-key">"${key}"</span>
          <span class="json-separator">:</span>
          <span class="json-value">${value}</span>
          ${hasNext ? '<span>,</span>' : ''}
        </div>
      `;
    }

    renderObjectOrArray(key, value, type, hasNext) {
      const length = Array.isArray(value) ? value.length : Object.keys(value).length;
      const displayName = type === 'array' ? `[${length}]` : `{${length}}`;

      return `
        <div class="json-property collapsible">
          <span class="json-toggle">â–¼</span>
          ${key ? `<span class="json-key">"${key}"</span><span class="json-separator">:</span>` : ''}
          <span class="json-value json-value-${type}">${displayName}</span>
          ${hasNext ? '<span>,</span>' : ''}
          <div class="json-node">${this.renderObjectContent(value)}</div>
        </div>
      `;
    }

    renderObjectContent(obj) {
      if (Array.isArray(obj)) {
        return `
          <div class="json-bracket">[</div>
          <div class="json-node">
            ${obj.map((item, index) => {
              const hasNext = index < obj.length - 1;
              return this.renderValue(item, '', hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">]</div>
        `;
      } else {
        const entries = Object.entries(obj);
        return `
          <div class="json-bracket">{</div>
          <div class="json-node">
            ${entries.map(([key, value], index) => {
              const hasNext = index < entries.length - 1;
              return this.renderValue(value, key, hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">}</div>
        `;
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    bindEvents() {
      this.container.addEventListener('click', (e) => {
        const toggle = e.target.closest('.json-toggle');
        if (toggle) {
          this.toggleNode(toggle);
        }
      });
    }

    toggleNode(toggle) {
      const property = toggle.parentElement;
      property.classList.toggle('collapsed');

      if (property.classList.contains('collapsed')) {
        toggle.textContent = 'â–¶';
      } else {
        toggle.textContent = 'â–¼';
      }
    }
  }

  // å±•å¼€è¾“å‡ºåŒºåŸŸ
  function expandOutput(title = 'è¾“å‡ºç»“æœ') {
    const outputArea = document.getElementById('output-area');
    const outputTitle = document.getElementById('output-title');
    outputArea.classList.add('expanded');
    outputTitle.textContent = title;
  }

  // å…³é—­è¾“å‡ºåŒºåŸŸ
  function closeOutput() {
    const outputArea = document.getElementById('output-area');
    outputArea.classList.remove('expanded');
  }

  // æ˜¾ç¤ºJSONç»“æœ
  function showJsonResult(data, title = 'æ ¼å¼åŒ–ç»“æœ') {
    const outputEl = document.getElementById('output-json');

    outputEl.innerHTML = '<div id="json-viewer-output"></div>';

    if (window.JsonViewer) {
      new window.JsonViewer('json-viewer-output', data);
    } else {
      outputEl.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    expandOutput(title);
    
    // æ›´æ–°è¾“å‡ºæ¡†è¡Œå·
    setTimeout(updateOutputLineNumbers, 100);
  }

  function initializeJsonFormatter() {
    const inputEl = getInputEditorElement();

    // å®æ—¶æ ¼å¼åŒ–è¾“å…¥
    inputEl.addEventListener('input', debounce(() => {
      try {
        const data = parseJson(inputEl.value);
        showJsonResult(data, 'æ ¼å¼åŒ–ç»“æœ');
      } catch (e) {
        // å¿½ç•¥è¾“å…¥æ—¶çš„è§£æé”™è¯¯
      }
    }, 800));

    // åº”ç”¨æå–å‡½æ•°
    document.getElementById('apply-extract').addEventListener('click', () => {
      applyExtractFunction();
    });

    // æŒ‰é’®äº‹ä»¶ç»‘å®š
    document.getElementById('clear-btn').addEventListener('click', clearInputs);
    document.getElementById('collapse-all').addEventListener('click', collapseAll);
    document.getElementById('expand-all').addEventListener('click', expandAll);
    document.getElementById('remove-comments').addEventListener('click', removeComments);
    document.getElementById('compress-copy').addEventListener('click', () => compressAndCopy());
    document.getElementById('escape-copy').addEventListener('click', () => escapeAndCopy());
    document.getElementById('json-to-xml').addEventListener('click', () => jsonToXmlAndCopy());
    document.getElementById('json-to-ts').addEventListener('click', () => jsonToTsAndCopy());
    document.getElementById('close-output').addEventListener('click', closeOutput);
    document.getElementById('history-btn').addEventListener('click', showHistory);

    // ç§»é™¤äº†åˆå§‹æ ¼å¼åŒ–ï¼Œä½¿ç”¨è‡ªåŠ¨æ ¼å¼åŒ–æ›¿ä»£
  }

  // é˜²æŠ–å‡½æ•°
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // æ ¼å¼åŒ–è¾“å…¥å‡½æ•°å·²ç§»é™¤ï¼Œä½¿ç”¨è‡ªåŠ¨æ ¼å¼åŒ–æ›¿ä»£

  // è§£æJSON
  function parseJson(str) {
    if (!str.trim()) return {};
    return JSON.parse(str);
  }

  // åº”ç”¨æå–å‡½æ•°
  async function applyExtractFunction() {
    const inputEl = getInputEditorElement();
    const extractFnStr = document.getElementById('extract-fn').value.trim();

    if (!extractFnStr) {
      alert(translations.enterExtractionFn || 'è¯·è¾“å…¥æå–å‡½æ•°');
      return;
    }

    try {
      const inputText = inputEl.value;
      if (!inputText.trim()) {
        alert(translations.enterData || 'è¯·è¾“å…¥æ•°æ®');
        return;
      }

      const parsedData = parseJson(inputText);
      const fn = new Function('obj', `return (${extractFnStr})(obj);`);
      const result = fn(parsedData);

      // åªæœ‰åœ¨åº”ç”¨æå–å‡½æ•°åæ‰æ˜¾ç¤ºè¾“å‡ºæ¡†
      showJsonResult(result, 'æå–ç»“æœ');
    } catch (error) {
      alert((translations.extractionError || 'æå–é”™è¯¯') + ': ' + error.message);
    }
  }

  // æ¸…ç©ºè¾“å…¥
  function clearInputs() {
    getInputEditorElement().value = '';
    document.getElementById('extract-fn').value = '';
    document.getElementById('output-json').innerHTML = '';
    closeOutput();
  }

  // æŠ˜å æ‰€æœ‰
  function collapseAll() {
    const outputEl = document.getElementById('output-json');
    const collapsibles = outputEl.querySelectorAll('.collapsible');
    collapsibles.forEach(node => {
      node.classList.add('collapsed');
      const toggle = node.querySelector('.json-toggle');
      if (toggle) toggle.textContent = 'â–¶';
    });
  }

  // å±•å¼€æ‰€æœ‰
  function expandAll() {
    const outputEl = document.getElementById('output-json');
    const collapsibles = outputEl.querySelectorAll('.collapsible');
    collapsibles.forEach(node => {
      node.classList.remove('collapsed');
      const toggle = node.querySelector('.json-toggle');
      if (toggle) toggle.textContent = 'â–¼';
    });
  }

  // å»é™¤æ³¨é‡Š
  function removeComments() {
    const inputEl = getInputEditorElement();
    let value = inputEl.value;
    value = value.replace(/\/\*[\s\S]*?\*\//g, '');
    value = value.replace(/\/\/.*/g, '');
    inputEl.value = value;
    formatInput();
  }

  // å‹ç¼©å¹¶å¤åˆ¶
  async function compressAndCopy() {
    const inputEl = getInputEditorElement();
    try {
      const parsedData = parseJson(inputEl.value);
      const compressed = JSON.stringify(parsedData);
      await navigator.clipboard.writeText(compressed);
      alert(translations.compressSuccess || 'å‹ç¼©æˆåŠŸå¹¶å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // è½¬ä¹‰å¹¶å¤åˆ¶
  async function escapeAndCopy() {
    const inputEl = getInputEditorElement();
    try {
      const parsedData = parseJson(inputEl.value);
      const compressed = JSON.stringify(parsedData);
      const escaped = compressed.replace(/[\\]/g, '\\\\').replace(/["]/g, '\\"');
      await navigator.clipboard.writeText(escaped);
      alert(translations.escapeSuccess || 'è½¬ä¹‰æˆåŠŸå¹¶å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬XMLå¹¶å¤åˆ¶
  async function jsonToXmlAndCopy() {
    const inputEl = getInputEditorElement();
    try {
      const parsedData = parseJson(inputEl.value);
      const xmlString = jsonToXml(parsedData, 'root');
      await navigator.clipboard.writeText(xmlString);
      alert(translations.xmlSuccess || 'XMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬TypeScriptå¹¶å¤åˆ¶
  async function jsonToTsAndCopy() {
    const inputEl = getInputEditorElement();
    try {
      const parsedData = parseJson(inputEl.value);
      const tsInterface = jsonToTsInterface(parsedData, 'DataType');
      await navigator.clipboard.writeText(tsInterface);
      alert(translations.tsSuccess || 'TypeScriptæ¥å£å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬XMLè¾…åŠ©å‡½æ•°
  function jsonToXml(obj, tagName) {
    if (obj === null || obj === undefined) {
      return `<${tagName}></${tagName}>`;
    }

    if (typeof obj !== 'object') {
      return `<${tagName}>${obj}</${tagName}>`;
    }

    if (Array.isArray(obj)) {
      return obj.map(item => jsonToXml(item, tagName)).join('');
    }

    let xml = `<${tagName}>`;
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'object') {
          xml += jsonToXml(value, key);
        } else {
          xml += `<${key}>${value}</${key}>`;
        }
      }
    }
    xml += `</${tagName}>`;

    return xml;
  }

  // JSONè½¬TypeScriptæ¥å£è¾…åŠ©å‡½æ•°
  function jsonToTsInterface(obj, interfaceName) {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `// æ— æ³•ä»éå¯¹è±¡ç±»å‹ç”Ÿæˆæ¥å£`;
    }

    let ts = `interface ${interfaceName} {\n`;

    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        let type;

        if (value === null) {
          type = 'any';
        } else if (Array.isArray(value)) {
          if (value.length > 0) {
            const elementType = typeof value[0];
            type = `${getType(elementType)}[]`;
          } else {
            type = 'any[]';
          }
        } else if (typeof value === 'object') {
          type = `${key.charAt(0).toUpperCase() + key.slice(1)}Type`;
          ts += jsonToTsInterface(value, type);
        } else {
          type = getType(typeof value);
        }

        ts += `  ${key}: ${type};\n`;
      }
    }

    ts += `}\n`;
    return ts;
  }

  // è·å–ç±»å‹å­—ç¬¦ä¸²
  function getType(jsType) {
    switch(jsType) {
      case 'string': return 'string';
      case 'number': return 'number';
      case 'boolean': return 'boolean';
      case 'object': return 'object';
      default: return 'any';
    }
  }

  // æœ¬åœ°å­˜å‚¨ç›¸å…³å‡½æ•°
  const HISTORY_KEY = 'json-formatter-history';
  const MAX_HISTORY_ITEMS = 10;

  // ä¿å­˜å†å²è®°å½•
  function saveToHistory(data) {
    try {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      
      // ç§»é™¤é‡å¤é¡¹
      const filteredHistory = history.filter(item => item.data !== data);
      
      // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
      filteredHistory.unshift({
        id: Date.now(),
        data: data,
        timestamp: new Date().toISOString()
      });
      
      // é™åˆ¶å†å²è®°å½•æ•°é‡
      const limitedHistory = filteredHistory.slice(0, MAX_HISTORY_ITEMS);
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(limitedHistory));
    } catch (error) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
    }
  }

  // è·å–å†å²è®°å½•
  function getHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (error) {
      console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
      return [];
    }
  }

  // æ¸…é™¤å†å²è®°å½•
  function clearHistory() {
    try {
      localStorage.removeItem(HISTORY_KEY);
    } catch (error) {
      console.error('æ¸…é™¤å†å²è®°å½•å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºå†å²è®°å½•
  function showHistory() {
    const history = getHistory();
    
    if (history.length === 0) {
      alert('æš‚æ— å†å²è®°å½•');
      return;
    }
    
    // åˆ›å»ºå†å²è®°å½•å¼¹çª—
    const historyContainer = document.createElement('div');
    historyContainer.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
    `;
    
    // åˆ›å»ºæ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'å†å²è®°å½•';
    title.style.cssText = `
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 18px;
    `;
    historyContainer.appendChild(title);
    
    // åˆ›å»ºå†å²è®°å½•åˆ—è¡¨
    const historyList = document.createElement('ul');
    historyList.style.cssText = `
      list-style: none;
      padding: 0;
      margin: 0;
    `;
    
    history.forEach(item => {
      const listItem = document.createElement('li');
      listItem.style.cssText = `
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      `;
      
      listItem.onmouseenter = () => {
        listItem.style.backgroundColor = '#f5f5f5';
      };
      
      listItem.onmouseleave = () => {
        listItem.style.backgroundColor = 'transparent';
      };
      
      // åˆ›å»ºå†å²è®°å½•å†…å®¹
      const historyContent = document.createElement('div');
      historyContent.style.cssText = `
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 500px;
      `;
      historyContent.textContent = item.data.substring(0, 100) + (item.data.length > 100 ? '...' : '');
      
      // åˆ›å»ºæ—¶é—´æˆ³
      const timestamp = document.createElement('div');
      timestamp.style.cssText = `
        font-size: 10px;
        color: #999;
        margin-top: 5px;
      `;
      timestamp.textContent = new Date(item.timestamp).toLocaleString();
      
      // ç‚¹å‡»å†å²è®°å½•æ¢å¤æ•°æ®
      listItem.onclick = () => {
        const textarea = document.getElementById('json-input');
        textarea.value = item.data;
        updateLineNumbers();
        document.body.removeChild(overlay);
        document.body.removeChild(historyContainer);
      };
      
      listItem.appendChild(historyContent);
      listItem.appendChild(timestamp);
      historyList.appendChild(listItem);
    });
    
    historyContainer.appendChild(historyList);
    
    // åˆ›å»ºæ¸…é™¤å†å²è®°å½•æŒ‰é’®
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'æ¸…é™¤å†å²è®°å½•';
    clearBtn.style.cssText = `
      margin-top: 15px;
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    `;
    
    clearBtn.onclick = () => {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        clearHistory();
        document.body.removeChild(overlay);
        document.body.removeChild(historyContainer);
        alert('å†å²è®°å½•å·²æ¸…é™¤');
      }
    };
    
    historyContainer.appendChild(clearBtn);
    
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    `;
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
    overlay.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(historyContainer);
    };
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(overlay);
    document.body.appendChild(historyContainer);
  }
</script>
