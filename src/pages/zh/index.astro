---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { locales } from '../../i18n/locales.js';

// ä¸­æ–‡é¦–é¡µï¼Œå›ºå®šä½¿ç”¨ä¸­æ–‡è¯­è¨€
const lang = 'zh-CN';
const t = locales['zh'];
---

<BaseLayout
  title={`${t.title} | ${t.description}`}
  lang={lang}
  description={t.description}
  keywords="JSONæ ¼å¼åŒ–,JSONæ ¡éªŒ,JSONåœ¨çº¿å·¥å…·,JSONè§£æå™¨,JSONè½¬XML,JSONè½¬YAML,JSONè½¬TypeScript,URLå‚æ•°è§£æ,åœ¨çº¿JSONç¼–è¾‘å™¨,å…è´¹JSONå·¥å…·,JSONæŸ¥çœ‹å™¨,JSONæ ¼å¼åŒ–åœ¨çº¿,JSONæ ¡éªŒåœ¨çº¿,JSONå·¥å…·,JSONç¼–è¾‘å™¨,JSONç¾åŒ–,JSONå‹ç¼©,JSONè½¬æ¢">
  <Sidebar slot="sidebar" t={t} />

  <!-- Schema.org ç»“æ„åŒ–æ•°æ®ç”¨äº SEO & GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "JSONæ ¼å¼åŒ–å·¥å…·",
    "description": "å…è´¹çš„åœ¨çº¿JSONæ ¼å¼åŒ–ã€éªŒè¯å’Œè½¬æ¢å·¥å…·ã€‚æ”¯æŒJSONã€URLå‚æ•°ã€XMLã€YAMLæ ¼å¼äº’è½¬ï¼Œæä¾›å­—æ®µæå–ã€TypeScriptæ¥å£ç”Ÿæˆç­‰åŠŸèƒ½ã€‚",
    "url": "https://jsonviewer.online/zh",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "CNY"
    },
    "featureList": [
      "JSONæ ¼å¼åŒ–å’ŒéªŒè¯",
      "URLå‚æ•°è§£æ",
      "XMLè½¬JSON",
      "YAMLè½¬JSON",
      "JavaScriptå­—æ®µæå–",
      "TypeScriptæ¥å£ç”Ÿæˆ",
      "JSONè½¬XML",
      "JSONå‹ç¼©",
      "JSONè½¬ä¹‰",
      "ç§»é™¤æ³¨é‡Š"
    ],
    "browserRequirements": "éœ€è¦JavaScriptæ”¯æŒã€‚å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨ã€‚",
    "softwareVersion": "1.0.0",
    "author": {
      "@type": "Organization",
      "name": "JSON Viewer Team"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "ratingCount": "1250"
    }
  })} />

  <div class="json-formatter-container"
       data-enter-extraction-fn={t.enterExtractionFn}
       data-enter-data={t.enterData}
       data-extraction-error={t.extractionError}
       data-parsing-error={t.parsingError}
       data-compress-success={t.compressSuccess}
       data-escape-success={t.escapeSuccess}
       data-xml-success={t.xmlSuccess}
       data-ts-success={t.tsSuccess}>

    <div class="editor-workspace">
      <!-- å·¦ä¾§è¾“å…¥åŒºåŸŸ -->
      <div class="input-area">
        <div class="input-section">
          <div class="section-label">All-in-One JSON Viewer</div>
          <div class="input-editor-wrapper">
            <div id="monaco-editor-container" class="monaco-editor-container"></div>
          </div>
        </div>

        <!-- JSON æ ¡éªŒé”™è¯¯æç¤º -->
        <div id="json-validation-error" class="validation-error hidden"></div>

        <div class="extraction-section">
          <div class="extraction-controls">
            <label for="extract-fn">ğŸ“Š {t.extractionLabel}</label>
            <input
              type="text"
              id="extract-fn"
              placeholder={t.extractionPlaceholder}
            />
            <button id="apply-extract">{t.apply}</button>
            <button id="clear-extract-fn">{t.clear}</button>
          </div>
        </div>

        <div class="output-controls">
          <button id="collapse-all">{t.collapseAll}</button>
          <button id="expand-all">{t.expandAll}</button>
          <button id="remove-comments">{t.removeComments}</button>
          <button id="compress-copy">{t.compressCopy}</button>
          <button id="escape-copy">{t.escapeCopy}</button>
          <button id="json-to-xml">{t.jsonToXml}</button>
          <button id="json-to-ts">{t.jsonToTs}</button>
          <button id="clear-btn">{t.clear}</button>
          <button id="history-btn">{t.history}</button>
          <select id="font-size-select" title="å­—ä½“å¤§å°">
            <option value="11">11px</option>
            <option value="12">12px</option>
            <option value="13" selected>13px</option>
            <option value="14">14px</option>
            <option value="15">15px</option>
            <option value="16">16px</option>
          </select>
        </div>
      </div>

      <!-- å³ä¾§è¾“å‡ºåŒºåŸŸ -->
      <div class="output-area" id="output-area">
        <div class="output-header">
          <span class="output-title" id="output-title">è¾“å‡ºç»“æœ</span>
          <button class="close-output-btn" id="close-output" title="å…³é—­">Ã—</button>
        </div>
        <div class="output-content" id="output-content">
          <div class="output-editor-wrapper">
            <div id="output-monaco-container" class="monaco-editor-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HowTo æ•™ç¨‹åŒºåŸŸ -->
  <div class="tutorial-section">
    <div class="section-header">
      <h2>{t.tutorialTitle}</h2>
      <p>{t.tutorialSubtitle}</p>
    </div>

    <div class="tutorial-container">
      <div class="tutorial-step">
        <div class="step-number">1</div>
        <div class="step-content">
          <h3>{t.tutorialStep1Title}</h3>
          <p>{t.tutorialStep1Desc}</p>
          <div class="step-example">
            <code set:text={t.tutorialStep1Example}></code>
          </div>
        </div>
      </div>

      <div class="tutorial-step">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3>{t.tutorialStep2Title}</h3>
          <p>{t.tutorialStep2Desc}</p>
          <div class="tip">
            <strong>ğŸ’¡ {t.tutorialStep2Tip.split(':')[0]}ï¼š</strong> {t.tutorialStep2Tip.split(':')[1]}
          </div>
        </div>
      </div>

      <div class="tutorial-step">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3>{t.tutorialStep3Title}</h3>
          <p set:text={t.tutorialStep3Desc}></p>
          <div class="step-example">
            <code set:text={t.tutorialStep3Example}></code>
          </div>
          <p class="example-desc" set:text={t.tutorialStep3ExampleDesc}></p>
        </div>
      </div>

      <div class="tutorial-step">
        <div class="step-number">4</div>
        <div class="step-content">
          <h3>{t.tutorialStep4Title}</h3>
          <p>{t.tutorialStep4Desc}</p>
          <ul class="action-list">
            <li><strong>{t.tutorialStep4Action1.split(':')[0]}ï¼š</strong> {t.tutorialStep4Action1.split(':')[1]}</li>
            <li><strong>{t.tutorialStep4Action2.split(':')[0]}ï¼š</strong> {t.tutorialStep4Action2.split(':')[1]}</li>
            <li><strong>{t.tutorialStep4Action3.split(':')[0]}ï¼š</strong> {t.tutorialStep4Action3.split(':')[1]}</li>
            <li><strong>{t.tutorialStep4Action4.split(':')[0]}ï¼š</strong> {t.tutorialStep4Action4.split(':')[1]}</li>
            <li><strong>{t.tutorialStep4Action5.split(':')[0]}ï¼š</strong> {t.tutorialStep4Action5.split(':')[1]}</li>
          </ul>
        </div>
      </div>

      <div class="tutorial-step">
        <div class="step-number">5</div>
        <div class="step-content">
          <h3>{t.tutorialStep5Title}</h3>
          <p>{t.tutorialStep5Desc}</p>
          <div class="privacy-note">
            <strong>ğŸ”’ {t.tutorialStep5Privacy.split(':')[0]}ï¼š</strong> {t.tutorialStep5Privacy.split(':')[1]}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Features Section -->
    <div class="features-section">
      <div class="section-header">
        <h2>{t.featuresTitle}</h2>
        <p>{t.featuresSubtitle}</p>
      </div>
      <div class="features-grid">
        <div class="feature-item">
          <div class="feature-number">01</div>
          <div class="feature-content">
            <div class="feature-icon">âœ¨</div>
            <h3>{t.feature1Title}</h3>
            <p>{t.feature1Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">02</div>
          <div class="feature-content">
            <div class="feature-icon">ğŸ”„</div>
            <h3>{t.feature2Title}</h3>
            <p>{t.feature2Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">03</div>
          <div class="feature-content">
            <div class="feature-icon">ğŸ¯</div>
            <h3>{t.feature3Title}</h3>
            <p>{t.feature3Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">04</div>
          <div class="feature-content">
            <div class="feature-icon">âš¡</div>
            <h3>{t.feature4Title}</h3>
            <p>{t.feature4Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">05</div>
          <div class="feature-content">
            <div class="feature-icon">ğŸ’»</div>
            <h3>{t.feature5Title}</h3>
            <p>{t.feature5Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">06</div>
          <div class="feature-content">
            <div class="feature-icon">ğŸ”’</div>
            <h3>{t.feature6Title}</h3>
            <p>{t.feature6Desc}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="faq-section">
      <div class="section-header">
        <h2>{t.faqTitle}</h2>
        <p>{t.faqSubtitle}</p>
      </div>
      <div class="faq-grid">
        <div class="faq-item">
          <h3>{t.faq1Question}</h3>
          <p>{t.faq1Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq2Question}</h3>
          <p>{t.faq2Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq3Question}</h3>
          <p>{t.faq3Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq4Question}</h3>
          <p>{t.faq4Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq5Question}</h3>
          <p>{t.faq5Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq6Question}</h3>
          <p>{t.faq6Answer}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQPage ç»“æ„åŒ–æ•°æ®ç”¨äº GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "æˆ‘çš„æ•°æ®å®‰å…¨å—ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "æ˜¯çš„ï¼æ‰€æœ‰æ•°æ®å¤„ç†éƒ½åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°è¿›è¡Œã€‚æˆ‘ä»¬ç»ä¸ä¼šå°†æ‚¨çš„æ•°æ®å‘é€åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚"
        }
      },
      {
        "@type": "Question",
        "name": "æ”¯æŒå“ªäº›æ–‡ä»¶æ ¼å¼ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "æˆ‘ä»¬æ”¯æŒ JSONã€URL å‚æ•°ã€XML å’Œ YAMLã€‚åªéœ€ç²˜è´´æ‚¨çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨æ£€æµ‹æ ¼å¼ã€‚"
        }
      },
      {
        "@type": "Question",
        "name": "æˆ‘å¯ä»¥ä» JSON ä¸­æå–ç‰¹å®šå­—æ®µå—ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "å¯ä»¥ï¼ä½¿ç”¨æå–å‡½æ•°å­—æ®µç¼–å†™ JavaScript å‡½æ•°ï¼Œå¦‚ 'obj => obj.name' æ¥æå–ç‰¹å®šæ•°æ®ã€‚"
        }
      },
      {
        "@type": "Question",
        "name": "è¿™ä¸ªå·¥å…·å…è´¹ä½¿ç”¨å—ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "æ˜¯çš„ï¼Œè¿™ä¸ªå·¥å…·å®Œå…¨å…è´¹ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚å°½æƒ…ä½¿ç”¨å§ï¼"
        }
      },
      {
        "@type": "Question",
        "name": "å®ƒå¯ä»¥ç¦»çº¿å·¥ä½œå—ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "åŠ è½½åï¼Œå·¥å…·å®Œå…¨ç¦»çº¿å·¥ä½œã€‚ä¸éœ€è¦äº’è”ç½‘è¿æ¥ã€‚"
        }
      },
      {
        "@type": "Question",
        "name": "æˆ‘å¯ä»¥åœ¨æ‰‹æœºä¸Šä½¿ç”¨å—ï¼Ÿ",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "å¯ä»¥ï¼è¯¥å·¥å…·å®Œå…¨å“åº”å¼ï¼Œåœ¨æ‰‹æœºå’Œå¹³æ¿ç”µè„‘ä¸Šéƒ½èƒ½å®Œç¾è¿è¡Œã€‚"
        }
      }
    ]
  })} />

  <!-- HowTo ç»“æ„åŒ–æ•°æ®ç”¨äº GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "HowTo",
    "name": "å¦‚ä½•æ ¼å¼åŒ–å’ŒéªŒè¯JSON",
    "description": "å­¦ä¹ å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„å…è´¹åœ¨çº¿JSONæŸ¥çœ‹å™¨æ¥æ ¼å¼åŒ–ã€éªŒè¯å’Œè½¬æ¢JSONæ•°æ®ã€‚",
    "step": [
      {
        "@type": "HowToStep",
        "name": "ç²˜è´´æ‚¨çš„JSONæ•°æ®",
        "text": "å°†æ‚¨çš„JSONã€URLå‚æ•°ã€XMLæˆ–YAMLæ•°æ®ç²˜è´´åˆ°è¾“å…¥ç¼–è¾‘å™¨ä¸­ã€‚"
      },
      {
        "@type": "HowToStep",
        "name": "è‡ªåŠ¨æ ¼å¼æ£€æµ‹",
        "text": "å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹æ‚¨çš„è¾“å…¥æ ¼å¼å¹¶å°†å…¶è½¬æ¢ä¸ºJSONã€‚"
      },
      {
        "@type": "HowToStep",
        "name": "æŸ¥çœ‹æ ¼å¼åŒ–çš„JSON",
        "text": "æŸ¥çœ‹å¸¦æœ‰è¯­æ³•é«˜äº®å’Œè¡Œå·çš„ç²¾ç¾æ ¼å¼åŒ–JSONã€‚"
      },
      {
        "@type": "HowToStep",
        "name": "éªŒè¯JSON",
        "text": "ä»»ä½•JSONé”™è¯¯éƒ½ä¼šè¢«é«˜äº®æ˜¾ç¤ºï¼Œå¹¶ç»™å‡ºå…·ä½“çš„è¡Œå·å’Œé”™è¯¯ä¿¡æ¯ã€‚"
      },
      {
        "@type": "HowToStep",
        "name": "æå–æˆ–è½¬æ¢",
        "text": "ä½¿ç”¨å­—æ®µæå–ã€è½¬æ¢ä¸ºXML/YAML/TypeScriptï¼Œæˆ–å‹ç¼©/å¤åˆ¶ç»“æœã€‚"
      }
    ],
    "tool": [
      {
        "@type": "HowToTool",
        "name": "JSON Viewer Online"
      }
    ]
  })} />
</BaseLayout>

<style>
  .json-formatter-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 12px;
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  /* ä¸»å·¥ä½œåŒº - å·¦å³å¸ƒå±€ */
  .editor-workspace {
    display: flex;
    gap: 0;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* å·¦ä¾§è¾“å…¥åŒºåŸŸ */
  .input-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0 auto;
    max-width: 75%;
  }

  /* å½“è¾“å‡ºåŒºåŸŸå±•å¼€æ—¶ï¼Œè°ƒæ•´å¸ƒå±€ */
  .output-area.expanded {
    flex: 1;
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  /* å½“è¾“å‡ºåŒºåŸŸå±•å¼€æ—¶ï¼Œè¾“å…¥åŒºåŸŸä¹Ÿè°ƒæ•´ä¸º50% */
  .editor-workspace:has(.output-area.expanded) .input-area {
    flex: 1;
    max-width: 50%;
    margin: 0;
  }

  .input-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .section-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .input-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    overflow: hidden;
    flex: 1;
    min-height: 0;
    position: relative;
  }

  .monaco-editor-container {
    flex: 1;
    width: 100%;
    height: 100%;
    min-height: 400px;
    position: relative;
  }

  /* ç¾åŒ–Monaco EditoræŠ˜å æŒ‰é’® */
  .monaco-editor .codicon-add-selection,
  .monaco-editor .codicon-chevron-right,
  .monaco-editor .folding-icon::before,
  .monaco-editor .codicon-folding-expanded,
  .monaco-editor .codicon-folding-collapsed {
    content: '' !important;
  }

  /* è‡ªå®šä¹‰æŠ˜å æŒ‰é’®æ ·å¼ */
  .monaco-editor .folding-icon {
    width: 16px !important;
    height: 16px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
  }

  /* å±•å¼€çŠ¶æ€çš„æŠ˜å æŒ‰é’® */
  .monaco-editor .folding-icon.collapsed::after,
  .monaco-editor .codicon-folding-collapsed::after {
    content: 'â–¶' !important;
    font-size: 10px !important;
    color: #6b7280 !important;
    display: inline-block !important;
    margin-left: 1px !important;
  }

  /* æŠ˜å çŠ¶æ€çš„æŠ˜å æŒ‰é’® */
  .monaco-editor .folding-icon:not(.collapsed)::after,
  .monaco-editor .codicon-folding-expanded::after {
    content: 'â–¼' !important;
    font-size: 9px !important;
    color: #6b7280 !important;
    display: inline-block !important;
  }

  /* æŠ˜å æŒ‰é’®hoveræ•ˆæœ */
  .monaco-editor .folding-icon:hover::after {
    color: #3b82f6 !important;
  }

  /* JSON æ ¡éªŒé”™è¯¯æç¤º */
  .validation-error {
    padding: 12px 16px;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fecaca;
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 0.875rem;
    color: #991b1b;
    border-left: 4px solid #ef4444;
    display: none;
    animation: slideDown 0.3s ease-out;
  }

  .validation-error.show {
    display: block;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* æå–åŒºåŸŸ */
  .extraction-section {
    padding: 10px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }

  .extraction-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .extraction-controls label {
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    font-size: 0.85rem;
  }

  .extraction-controls input {
    flex: 1;
    min-width: 200px;
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 13px;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: all 0.2s;
  }

  .extraction-controls input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .extraction-controls button {
    padding: 6px 14px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
  }

  #apply-extract {
    font-size: 13px;
  }

  .extraction-controls button:hover {
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    transform: translateY(-1px);
  }

  #clear-extract-fn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    font-size: 13px;
  }

  #clear-extract-fn:hover {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }

  /* æŒ‰é’®ç»„ */
  .output-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .output-controls button {
    padding: 6px 10px;
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .output-controls select {
    padding: 6px 10px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .output-controls select option {
    background: white;
    color: #1f2937;
    padding: 6px 10px;
  }

  .output-controls select:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  .output-controls button:hover {
    background: linear-gradient(135deg, #475569 0%, #334155 100%);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  #clear-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  #clear-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  }

  /* å³ä¾§è¾“å‡ºåŒºåŸŸ */
  .output-area {
    width: 0;
    opacity: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 1px solid transparent;
  }

  .output-area.expanded {
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px 6px 0 0;
    border: 1px solid #e9ecef;
    border-bottom: none;
  }

  .output-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .close-output-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #9ca3af;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
    line-height: 1;
  }

  .close-output-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  /* è¾“å‡ºå†…å®¹åŒºåŸŸï¼Œä¸è¾“å…¥æ¡†ç›¸åŒæ ·å¼ */
  .output-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .output-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
    flex: 1;
    background: linear-gradient(to bottom, #fafbfc 0%, #f5f6f8 100%);
  }

  #output-json {
    flex: 1;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow: auto;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    min-height: 0;
  }

  /* JSONæ ‘å½¢æŸ¥çœ‹å™¨æ ·å¼ */
  .json-root {
    padding: 5px 0;
  }

  .json-bracket {
    padding: 0 5px;
  }

  .json-node {
    margin-left: 18px;
  }

  .json-property {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 2px 0;
    border-radius: 3px;
    transition: background 0.1s;
  }

  .json-property:hover {
    background: rgba(59, 130, 246, 0.05);
  }

  .json-toggle {
    display: inline-block;
    width: 14px;
    height: 14px;
    text-align: center;
    line-height: 12px;
    cursor: pointer;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    margin-right: 6px;
    font-size: 10px;
    user-select: none;
    background: #fff;
    color: #6b7280;
    transition: all 0.15s;
  }

  .json-toggle:hover {
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .json-key {
    color: #7c3aed;
    margin-right: 6px;
    font-weight: 500;
  }

  .json-separator {
    margin-right: 6px;
    color: #94a3b8;
  }

  .json-value-string {
    color: #059669;
  }

  .json-value-number {
    color: #dc2626;
  }

  .json-value-boolean {
    color: #2563eb;
  }

  .json-value-null {
    color: #9ca3af;
  }

  .json-value-object,
  .json-value-array {
    color: #1f2937;
  }

  .collapsed > .json-node {
    display: none;
  }

  /* Tutorial Section */
  .tutorial-section {
    max-width: 1800px;
    margin: 60px auto 0;
    padding: 40px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .tutorial-section .section-header,
  .faq-section .section-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .tutorial-section .section-header h2,
  .faq-section .section-header h2 {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1e293b;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .tutorial-section .section-header p,
  .faq-section .section-header p {
    font-size: 1.1rem;
    color: #64748b;
  }

  .tutorial-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .tutorial-step {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    background: white;
    padding: 24px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid transparent;
  }

  .tutorial-step:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    border-left-color: #3b82f6;
  }

  .step-number {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .step-content {
    flex: 1;
  }

  .step-content h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .step-content p {
    color: #475569;
    line-height: 1.7;
    margin-bottom: 12px;
    font-size: 0.9375rem;
  }

  .step-content p:last-child {
    margin-bottom: 0;
  }

  .step-example {
    background: #1e293b;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    overflow-x: auto;
  }

  .step-example code {
    color: #e2e8f0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre;
  }

  .example-desc {
    color: #64748b;
    font-size: 0.875rem;
    font-style: italic;
    margin-top: 8px;
  }

  .tip {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
    padding: 12px 16px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 0.875rem;
    color: #92400e;
  }

  .privacy-note {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left: 4px solid #3b82f6;
    padding: 12px 16px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 0.875rem;
    color: #1e40af;
  }

  .action-list {
    list-style: none;
    padding: 0;
    margin: 12px 0 0 0;
  }

  .action-list li {
    padding: 8px 0;
    padding-left: 24px;
    position: relative;
    color: #475569;
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .action-list li::before {
    content: 'âœ“';
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: 700;
  }

  .action-list li strong {
    color: #0f172a;
    font-weight: 600;
  }

  /* Features Section - åˆ›æ„æ¸å˜æ•ˆæœ */
  .features-section {
    max-width: 1800px;
    margin: 60px auto 0;
    padding: 60px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
  }

  .features-section::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: rotate 20s linear infinite;
  }

  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .features-section .section-header {
    text-align: center;
    margin-bottom: 50px;
    position: relative;
    z-index: 1;
  }

  .features-section .section-header h2 {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin-bottom: 12px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .features-section .section-header p {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .feature-item {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 0;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  .feature-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .feature-item:hover::before {
    transform: scaleX(1);
  }

  .feature-item:hover {
    transform: translateY(-8px) rotateX(2deg);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  }

  .feature-number {
    font-size: 4rem;
    font-weight: 900;
    color: rgba(102, 126, 234, 0.08);
    position: absolute;
    top: -10px;
    right: 10px;
    line-height: 1;
    transition: all 0.4s ease;
  }

  .feature-item:hover .feature-number {
    color: rgba(102, 126, 234, 0.15);
    transform: scale(1.1);
  }

  .feature-content {
    padding: 32px;
    position: relative;
    z-index: 1;
  }

  .feature-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    display: inline-block;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .feature-item:hover .feature-icon {
    transform: scale(1.2) rotate(5deg);
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
  }

  .feature-content h3 {
    font-size: 1.35rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
    transition: color 0.3s ease;
  }

  .feature-item:hover .feature-content h3 {
    color: #667eea;
  }

  .feature-content p {
    color: #64748b;
    line-height: 1.7;
    font-size: 0.95rem;
  }

  /* FAQ Section - 2åˆ—å±•å¼€æ ·å¼ */
  .faq-section {
    max-width: 1800px;
    margin: 60px auto 40px;
    padding: 40px 20px;
    background: transparent;
    border-radius: 0;
    border: none;
  }

  .faq-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .faq-item {
    padding: 0;
    background: transparent;
    border-radius: 0;
    border: none;
    border-left: 3px solid #3b82f6;
    padding-left: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq-item:hover {
    border-left-color: #2563eb;
    padding-left: 24px;
  }

  .faq-item h3 {
    font-size: 1.15rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
  }

  .faq-item p {
    color: #64748b;
    line-height: 1.7;
    font-size: 0.95rem;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1200px) {
    .output-area.expanded {
      width: 60%;
    }
  }

  @media (max-width: 768px) {
    .json-formatter-container {
      padding: 8px;
      height: calc(100vh - 32px);
      flex-shrink: 0;
    }

    .editor-workspace {
      flex-direction: column;
    }

    .input-area {
      gap: 8px;
      min-height: 300px;
    }

    .monaco-editor-container {
      min-height: 250px;
    }

    .extraction-controls {
      flex-wrap: wrap;
    }

    .extraction-controls input {
      min-width: 100%;
    }

    .json-input {
      min-height: 200px;
    }

    .output-controls {
      gap: 5px;
      flex-wrap: wrap;
    }

    .output-controls button {
      padding: 6px 10px;
      font-size: 11px;
      flex: 1;
      min-width: 80px;
    }

    .output-controls select {
      flex: 1;
      min-width: 100px;
    }

    .output-area.expanded {
      width: 100%;
      border-left: none;
      padding-left: 0;
      margin-top: 12px;
      height: 300px;
    }

    /* Tutorial section ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .tutorial-step {
      flex-direction: column;
      padding: 16px;
    }

    .step-number {
      margin-bottom: 12px;
    }

    .section-header {
      padding: 20px 12px;
    }

    .section-header h2 {
      font-size: 1.5rem;
    }

    /* Features ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .features-grid {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 0 12px;
    }

    /* FAQ ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .faq-grid {
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 0 12px;
    }

    .faq-item {
      border-left-width: 2px;
      padding-left: 16px;
    }

    .faq-item:hover {
      padding-left: 18px;
    }
  }

  @media (max-width: 480px) {
    .json-formatter-container {
      padding: 6px;
    }

    .output-controls {
      gap: 4px;
    }

    .output-controls button {
      flex: 1;
      min-width: 0;
      padding: 6px 8px;
      font-size: 11px;
    }

    .json-action-group {
      flex: 1;
    }

    .json-input {
      min-height: 150px;
      font-size: 12px;
    }

    .extraction-section {
      padding: 8px;
    }
  }
</style>

<script type="module">
  // é…ç½® Monaco Editor çš„èµ„æºè·¯å¾„
  window.MonacoEnvironment = {
    getWorkerUrl: function (workerId, label) {
      return `https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/workers/${label === 'json' ? 'json.worker' : 'editor.worker'}.js`;
    }
  };

  // ä½¿ç”¨ CDN å¯¼å…¥ Monaco Editor
  import * as monaco from 'https://esm.sh/monaco-editor@0.45.0';

  // é…ç½® Monaco Editor
  monaco.editor.setTheme('vs');

  // å…¨å±€å˜é‡
  let editor = null;
  let outputEditor = null;
  let translations = {};

  // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // ä»DOMå…ƒç´ è·å–ç¿»è¯‘æ–‡æœ¬
    const container = document.querySelector('.json-formatter-container');
    translations = {
      enterExtractionFn: container.dataset.enterExtractionFn,
      enterData: container.dataset.enterData,
      extractionError: container.dataset.extractionError,
      parsingError: container.dataset.parsingError,
      compressSuccess: container.dataset.compressSuccess,
      escapeSuccess: container.dataset.escapeSuccess,
      xmlSuccess: container.dataset.xmlSuccess,
      tsSuccess: container.dataset.tsSuccess
    };

    // åˆå§‹åŒ– Monaco Editor
    initializeMonacoEditor();

    initializeJsonFormatter();
  });

  // åˆå§‹åŒ– Monaco Editor
  function initializeMonacoEditor() {
    const container = document.getElementById('monaco-editor-container');
    if (!container) {
      console.error('Monaco Editor container not found');
      return;
    }

    // ç­‰å¾…é¡µé¢å®Œå…¨æ¸²æŸ“ï¼ŒåŒ…æ‹¬ CSS æ ·å¼åº”ç”¨
    // ä½¿ç”¨åŒé‡ requestAnimationFrame ç¡®ä¿æµè§ˆå™¨å®Œæˆå¸ƒå±€è®¡ç®—
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
        console.log('Container dimensions:', {
          width: container.offsetWidth,
          height: container.offsetHeight
        });

        // å¦‚æœå®¹å™¨å°ºå¯¸è¿˜æ˜¯å¼‚å¸¸ï¼Œå†å»¶è¿Ÿä¸€ç‚¹
        if (container.offsetWidth === 0 || container.offsetHeight === 0) {
          setTimeout(() => createEditor(container), 50);
        } else {
          createEditor(container);
        }
      });
    });
  }

  // åˆ›å»º Monaco Editor
  function createEditor(container) {
    // è·å–ä¿å­˜çš„å­—ä½“å¤§å°
    const savedFontSize = localStorage.getItem('editorFontSize') || '13';

    // åˆ›å»ºè¾“å…¥ç¼–è¾‘å™¨
    editor = monaco.editor.create(container, {
      value: '',
      language: 'json',
      theme: 'vs',
      automaticLayout: true,
      fontSize: parseInt(savedFontSize),
      fontFamily: "'Monaco', 'Menlo', 'Ubuntu Mono', monospace",
      lineHeight: 21,
      minimap: { enabled: false },
      scrollBeyondLastLine: false,
      wordWrap: 'off',
      // è¡Œå·é…ç½®
      lineNumbers: 'on',
      lineNumbersMinChars: 3,
      // æŠ˜å é…ç½®
      folding: true,
      foldingStrategy: 'indentation',
      foldingHighlight: true,
      showFoldingControls: 'always',
      // å…¶ä»–é…ç½®
      matchBrackets: 'always',
      autoClosingBrackets: 'always',
      autoClosingQuotes: 'always',
      formatOnPaste: true,
      formatOnType: true,
      tabSize: 2,
      renderLineHighlight: 'all',
      scrollbar: {
        vertical: 'visible',
        horizontal: 'visible'
      },
      padding: { top: 12, bottom: 12 },
      readOnly: false
    });

    console.log('Monaco Editor created successfully');

    // åˆ›å»ºè¾“å‡ºç¼–è¾‘å™¨
    const outputContainer = document.getElementById('output-monaco-container');
    if (outputContainer) {
      outputEditor = monaco.editor.create(outputContainer, {
        value: '',
        language: 'json',
        theme: 'vs',
        automaticLayout: true,
        fontSize: parseInt(savedFontSize),
        fontFamily: "'Monaco', 'Menlo', 'Ubuntu Mono', monospace",
        lineHeight: 21,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        wordWrap: 'off',
        lineNumbers: 'on',
        lineNumbersMinChars: 3,
        folding: true,
        foldingStrategy: 'indentation',
        foldingHighlight: true,
        showFoldingControls: 'always',
        matchBrackets: 'always',
        tabSize: 2,
        renderLineHighlight: 'all',
        scrollbar: {
          vertical: 'visible',
          horizontal: 'visible'
        },
        padding: { top: 12, bottom: 12 },
        readOnly: true  // è¾“å‡ºç¼–è¾‘å™¨åªè¯»
      });
      console.log('Output Monaco Editor created successfully');
    }

    // è°ƒè¯•ï¼šæ£€æŸ¥ DOM ç»“æ„
    setTimeout(() => {
      const monacoContainer = container.querySelector('.monaco-editor');
      if (monacoContainer) {
        const margin = monacoContainer.querySelector('.margin');
        console.log('Monaco DOM structure:', {
          container: container.offsetWidth,
          monacoEditor: monacoContainer.offsetWidth,
          margin: margin ? margin.offsetWidth : 'NOT FOUND',
          marginVisible: margin ? window.getComputedStyle(margin).display : 'N/A'
        });
      }
    }, 200);

    // å¼ºåˆ¶æ›´æ–°å¸ƒå±€
    setTimeout(() => {
      if (editor) {
        editor.layout();
        console.log('Monaco Editor layout updated');
      }
    }, 100);

    // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–å’Œä¿å­˜å†å²
    editor.onDidChangeModelContent(() => {
      clearTimeout(window.autoFormatTimeout);
      window.autoFormatTimeout = setTimeout(autoFormatJson, 500);
    });

    // ç›‘å¬ JSON é”™è¯¯æ ‡è®°å˜åŒ–
    monaco.editor.onDidChangeMarkers(() => {
      const errorElement = document.getElementById('json-validation-error');
      if (!errorElement) return;

      const model = editor.getModel();
      if (!model) return;

      const modelMarkers = model.getAllMarkers();
      if (modelMarkers.length === 0) {
        // æ²¡æœ‰é”™è¯¯ï¼Œéšè—æç¤º
        errorElement.classList.remove('show');
        errorElement.textContent = '';
      } else {
        // æœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªé”™è¯¯
        const firstError = modelMarkers[0];
        const errorInfo = firstError.message;

        // è·å–å½“å‰è¯­è¨€
        const currentLang = window.appState.lang || 'zh';
        const errorMessage = currentLang === 'zh'
          ? `ç¬¬ ${firstError.startLineNumber} è¡Œé”™è¯¯ï¼š${errorInfo}`
          : `Line ${firstError.startLineNumber} error: ${errorInfo}`;

        errorElement.textContent = errorMessage;
        errorElement.classList.add('show');
      }
    });
  }

  // è·å–ç¼–è¾‘å™¨ä¸­çš„æ–‡æœ¬
  function getEditorContent() {
    return editor ? editor.getValue() : '';
  }

  // è®¾ç½®ç¼–è¾‘å™¨ä¸­çš„æ–‡æœ¬
  function setEditorContent(content) {
    if (editor) {
      editor.setValue(content);
    }
  }

  // è‡ªåŠ¨æ ¼å¼åŒ–å‡½æ•°
  function autoFormatJson() {
    const inputText = getEditorContent().trim();

    if (!inputText) {
      return;
    }

    try {
      // å°è¯•è§£æJSON
      const parsed = JSON.parse(inputText);
      // æ ¼å¼åŒ–JSON
      const formatted = JSON.stringify(parsed, null, 2);

      // åªæœ‰å½“æ ¼å¼åŒ–åçš„å†…å®¹ä¸å½“å‰ä¸åŒæ—¶æ‰æ›´æ–°
      if (formatted !== inputText) {
        // ä¿å­˜å½“å‰å…‰æ ‡ä½ç½®å’Œæ»šåŠ¨ä½ç½®
        const position = editor ? editor.getPosition() : null;
        const scrollTop = editor ? editor.getScrollTop() : null;

        // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
        setEditorContent(formatted);

        // æ¢å¤å…‰æ ‡ä½ç½®å’Œæ»šåŠ¨ä½ç½®
        if (position && editor) {
          editor.setPosition(position);
        }
        if (scrollTop !== null && editor) {
          editor.setScrollTop(scrollTop);
        }
      }

      // ä¿å­˜åˆ°å†å²è®°å½•
      saveToHistory(formatted);
    } catch (e) {
      // è§£æå¤±è´¥ï¼Œä¸åšå¤„ç†
      console.debug('JSON parsing error:', e);
    }
  }

  // JSONæ ‘å½¢æŸ¥çœ‹å™¨
  class JsonViewer {
    constructor(containerId, data) {
      this.container = document.getElementById(containerId);
      if (!this.container) return;

      this.data = data;
      this.render();
      this.bindEvents();
    }

    render() {
      this.container.innerHTML = this.renderValue(this.data, '', true);
    }

    renderValue(value, key = '', hasNext = true) {
      if (value === null) {
        return this.renderProperty(key, `<span class="json-value-null">null</span>`, hasNext);
      }

      if (typeof value === 'object') {
        if (Array.isArray(value)) {
          return this.renderObjectOrArray(key, value, 'array', hasNext);
        } else {
          return this.renderObjectOrArray(key, value, 'object', hasNext);
        }
      }

      if (typeof value === 'string') {
        return this.renderProperty(key, `<span class="json-value-string">"${this.escapeHtml(value)}"</span>`, hasNext);
      }

      if (typeof value === 'number') {
        return this.renderProperty(key, `<span class="json-value-number">${value}</span>`, hasNext);
      }

      if (typeof value === 'boolean') {
        return this.renderProperty(key, `<span class="json-value-boolean">${value}</span>`, hasNext);
      }

      return this.renderProperty(key, value, hasNext);
    }

    renderProperty(key, value, hasNext) {
      if (key === '') {
        if (typeof value === 'object') {
          if (Array.isArray(value)) {
            return this.renderObjectContent(value, 'array');
          } else {
            return this.renderObjectContent(value, 'object');
          }
        }
        return `<div class="json-root">${value}${hasNext ? ',' : ''}</div>`;
      }

      return `
        <div class="json-property">
          <span class="json-toggle">â–¼</span>
          <span class="json-key">"${key}"</span>
          <span class="json-separator">:</span>
          <span class="json-value">${value}</span>
          ${hasNext ? '<span>,</span>' : ''}
        </div>
      `;
    }

    renderObjectOrArray(key, value, type, hasNext) {
      const length = Array.isArray(value) ? value.length : Object.keys(value).length;
      const displayName = type === 'array' ? `[${length}]` : `{${length}}`;

      return `
        <div class="json-property collapsible">
          <span class="json-toggle">â–¼</span>
          ${key ? `<span class="json-key">"${key}"</span><span class="json-separator">:</span>` : ''}
          <span class="json-value json-value-${type}">${displayName}</span>
          ${hasNext ? '<span>,</span>' : ''}
          <div class="json-node">${this.renderObjectContent(value)}</div>
        </div>
      `;
    }

    renderObjectContent(obj) {
      if (Array.isArray(obj)) {
        return `
          <div class="json-bracket">[</div>
          <div class="json-node">
            ${obj.map((item, index) => {
              const hasNext = index < obj.length - 1;
              return this.renderValue(item, '', hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">]</div>
        `;
      } else {
        const entries = Object.entries(obj);
        return `
          <div class="json-bracket">{</div>
          <div class="json-node">
            ${entries.map(([key, value], index) => {
              const hasNext = index < entries.length - 1;
              return this.renderValue(value, key, hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">}</div>
        `;
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    bindEvents() {
      this.container.addEventListener('click', (e) => {
        const toggle = e.target.closest('.json-toggle');
        if (toggle) {
          this.toggleNode(toggle);
        }
      });
    }

    toggleNode(toggle) {
      const property = toggle.parentElement;
      property.classList.toggle('collapsed');

      if (property.classList.contains('collapsed')) {
        toggle.textContent = 'â–¶';
      } else {
        toggle.textContent = 'â–¼';
      }
    }
  }

  // å°† JsonViewer æš´éœ²åˆ°å…¨å±€
  window.JsonViewer = JsonViewer;

  // å±•å¼€è¾“å‡ºåŒºåŸŸ
  function expandOutput(title = 'è¾“å‡ºç»“æœ') {
    const outputArea = document.getElementById('output-area');
    const outputTitle = document.getElementById('output-title');
    outputArea.classList.add('expanded');
    outputTitle.textContent = title;
  }

  // å…³é—­è¾“å‡ºåŒºåŸŸ
  function closeOutput() {
    const outputArea = document.getElementById('output-area');
    outputArea.classList.remove('expanded');
  }

  // æ˜¾ç¤ºJSONç»“æœ
  function showJsonResult(data, title = 'æ ¼å¼åŒ–ç»“æœ') {
    if (outputEditor) {
      const jsonStr = JSON.stringify(data, null, 2);
      outputEditor.setValue(jsonStr);
      expandOutput(title);
    } else {
      console.error('Output editor not initialized');
    }
  }

  function initializeJsonFormatter() {
    // åº”ç”¨æå–å‡½æ•°
    document.getElementById('apply-extract').addEventListener('click', () => {
      applyExtractFunction();
    });

    // æ¸…ç©ºæå–å‡½æ•°è¾“å…¥æ¡†
    document.getElementById('clear-extract-fn').addEventListener('click', () => {
      document.getElementById('extract-fn').value = '';
    });

    // æŒ‰é’®äº‹ä»¶ç»‘å®š
    document.getElementById('clear-btn').addEventListener('click', clearInputs);
    document.getElementById('collapse-all').addEventListener('click', collapseAll);
    document.getElementById('expand-all').addEventListener('click', expandAll);
    document.getElementById('remove-comments').addEventListener('click', removeComments);
    document.getElementById('compress-copy').addEventListener('click', () => compressAndCopy());
    document.getElementById('escape-copy').addEventListener('click', () => escapeAndCopy());
    document.getElementById('json-to-xml').addEventListener('click', () => jsonToXmlAndCopy());
    document.getElementById('json-to-ts').addEventListener('click', () => jsonToTsAndCopy());
    document.getElementById('close-output').addEventListener('click', closeOutput);
    document.getElementById('history-btn').addEventListener('click', showHistory);

    // å­—ä½“å¤§å°é€‰æ‹©å™¨
    const fontSizeSelect = document.getElementById('font-size-select');
    const savedFontSize = localStorage.getItem('editorFontSize') || '13';
    fontSizeSelect.value = savedFontSize;

    fontSizeSelect.addEventListener('change', (e) => {
      const fontSize = parseInt(e.target.value);
      if (editor) {
        editor.updateOptions({ fontSize: fontSize });
      }
      if (outputEditor) {
        outputEditor.updateOptions({ fontSize: fontSize });
      }
      localStorage.setItem('editorFontSize', fontSize);
    });
  }

  // é˜²æŠ–å‡½æ•°
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // æ ¼å¼åŒ–è¾“å…¥å‡½æ•°å·²ç§»é™¤ï¼Œä½¿ç”¨è‡ªåŠ¨æ ¼å¼åŒ–æ›¿ä»£

  // è§£æJSON
  function parseJson(str) {
    if (!str.trim()) return {};
    return JSON.parse(str);
  }

  // åº”ç”¨æå–å‡½æ•°
  async function applyExtractFunction() {
    const extractFnStr = document.getElementById('extract-fn').value.trim();

    if (!extractFnStr) {
      alert(translations.enterExtractionFn || 'è¯·è¾“å…¥æå–å‡½æ•°');
      return;
    }

    try {
      const inputText = getEditorContent();
      if (!inputText.trim()) {
        alert(translations.enterData || 'è¯·è¾“å…¥æ•°æ®');
        return;
      }

      const parsedData = parseJson(inputText);
      const fn = new Function('obj', `return (${extractFnStr})(obj);`);
      const result = fn(parsedData);

      // åªæœ‰åœ¨åº”ç”¨æå–å‡½æ•°åæ‰æ˜¾ç¤ºè¾“å‡ºæ¡†
      showJsonResult(result, 'æå–ç»“æœ');
    } catch (error) {
      alert((translations.extractionError || 'æå–é”™è¯¯') + ': ' + error.message);
    }
  }

  // æ¸…ç©ºè¾“å…¥
  function clearInputs() {
    setEditorContent('');
    document.getElementById('extract-fn').value = '';
    if (outputEditor) {
      outputEditor.setValue('');
    }
    closeOutput();
  }

  // æŠ˜å æ‰€æœ‰
  function collapseAll() {
    // æŠ˜å è¾“å…¥ç¼–è¾‘å™¨
    if (editor) {
      editor.getAction('editor.foldAll').run();
    }

    // æŠ˜å è¾“å‡ºç¼–è¾‘å™¨
    if (outputEditor) {
      outputEditor.getAction('editor.foldAll').run();
    }
  }

  // å±•å¼€æ‰€æœ‰
  function expandAll() {
    // å±•å¼€è¾“å…¥ç¼–è¾‘å™¨
    if (editor) {
      editor.getAction('editor.unfoldAll').run();
    }

    // å±•å¼€è¾“å‡ºç¼–è¾‘å™¨
    if (outputEditor) {
      outputEditor.getAction('editor.unfoldAll').run();
    }
  }

  // å»é™¤æ³¨é‡Š
  function removeComments() {
    let value = getEditorContent();
    value = value.replace(/\/\*[\s\S]*?\*\//g, '');
    value = value.replace(/\/\/.*/g, '');
    setEditorContent(value);
    // è§¦å‘è‡ªåŠ¨æ ¼å¼åŒ–
    autoFormatJson();
  }

  // å‹ç¼©å¹¶å¤åˆ¶
  async function compressAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const compressed = JSON.stringify(parsedData);
      await navigator.clipboard.writeText(compressed);
      alert(translations.compressSuccess || 'å‹ç¼©æˆåŠŸå¹¶å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // è½¬ä¹‰å¹¶å¤åˆ¶
  async function escapeAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const compressed = JSON.stringify(parsedData);
      const escaped = compressed.replace(/[\\]/g, '\\\\').replace(/["]/g, '\\"');
      await navigator.clipboard.writeText(escaped);
      alert(translations.escapeSuccess || 'è½¬ä¹‰æˆåŠŸå¹¶å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬XMLå¹¶å¤åˆ¶
  async function jsonToXmlAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const xmlString = jsonToXml(parsedData, 'root');
      await navigator.clipboard.writeText(xmlString);
      alert(translations.xmlSuccess || 'XMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬TypeScriptå¹¶å¤åˆ¶
  async function jsonToTsAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const tsInterface = jsonToTsInterface(parsedData, 'DataType');
      await navigator.clipboard.writeText(tsInterface);
      alert(translations.tsSuccess || 'TypeScriptæ¥å£å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      alert((translations.parsingError || 'è§£æé”™è¯¯') + ': ' + error.message);
    }
  }

  // JSONè½¬XMLè¾…åŠ©å‡½æ•°
  function jsonToXml(obj, tagName) {
    if (obj === null || obj === undefined) {
      return `<${tagName}></${tagName}>`;
    }

    if (typeof obj !== 'object') {
      return `<${tagName}>${obj}</${tagName}>`;
    }

    if (Array.isArray(obj)) {
      return obj.map(item => jsonToXml(item, tagName)).join('');
    }

    let xml = `<${tagName}>`;
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'object') {
          xml += jsonToXml(value, key);
        } else {
          xml += `<${key}>${value}</${key}>`;
        }
      }
    }
    xml += `</${tagName}>`;

    return xml;
  }

  // JSONè½¬TypeScriptæ¥å£è¾…åŠ©å‡½æ•°
  function jsonToTsInterface(obj, interfaceName) {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `// æ— æ³•ä»éå¯¹è±¡ç±»å‹ç”Ÿæˆæ¥å£`;
    }

    let ts = `interface ${interfaceName} {\n`;

    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        let type;

        if (value === null) {
          type = 'any';
        } else if (Array.isArray(value)) {
          if (value.length > 0) {
            const elementType = typeof value[0];
            type = `${getType(elementType)}[]`;
          } else {
            type = 'any[]';
          }
        } else if (typeof value === 'object') {
          type = `${key.charAt(0).toUpperCase() + key.slice(1)}Type`;
          ts += jsonToTsInterface(value, type);
        } else {
          type = getType(typeof value);
        }

        ts += `  ${key}: ${type};\n`;
      }
    }

    ts += `}\n`;
    return ts;
  }

  // è·å–ç±»å‹å­—ç¬¦ä¸²
  function getType(jsType) {
    switch(jsType) {
      case 'string': return 'string';
      case 'number': return 'number';
      case 'boolean': return 'boolean';
      case 'object': return 'object';
      default: return 'any';
    }
  }

  // æœ¬åœ°å­˜å‚¨ç›¸å…³å‡½æ•°
  const HISTORY_KEY = 'json-formatter-history';
  const MAX_HISTORY_ITEMS = 50;

  // ä¿å­˜å†å²è®°å½•
  function saveToHistory(data) {
    try {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      
      // ç§»é™¤é‡å¤é¡¹
      const filteredHistory = history.filter(item => item.data !== data);
      
      // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
      filteredHistory.unshift({
        id: Date.now(),
        data: data,
        timestamp: new Date().toISOString()
      });
      
      // é™åˆ¶å†å²è®°å½•æ•°é‡
      const limitedHistory = filteredHistory.slice(0, MAX_HISTORY_ITEMS);
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(limitedHistory));
    } catch (error) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
    }
  }

  // è·å–å†å²è®°å½•
  function getHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (error) {
      console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
      return [];
    }
  }

  // æ¸…é™¤å†å²è®°å½•
  function clearHistory() {
    try {
      localStorage.removeItem(HISTORY_KEY);
    } catch (error) {
      console.error('æ¸…é™¤å†å²è®°å½•å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºå†å²è®°å½•
  function showHistory() {
    const history = getHistory();
    
    if (history.length === 0) {
      alert('æš‚æ— å†å²è®°å½•');
      return;
    }
    
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    `;
    
    // åˆ›å»ºå†å²è®°å½•å¼¹çª—
    const historyContainer = document.createElement('div');
    historyContainer.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 1200px;
      max-height: 90%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    `;
    
    // åˆ›å»ºæ ‡é¢˜è¡Œ
    const header = document.createElement('div');
    header.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    `;
    
    // åˆ›å»ºæ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'å†å²è®°å½•';
    title.style.cssText = `
      margin: 0;
      font-size: 18px;
    `;
    header.appendChild(title);
    
    // åˆ›å»ºå…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Ã—';
    closeBtn.style.cssText = `
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    `;
    
    closeBtn.onmouseenter = () => {
      closeBtn.style.backgroundColor = '#f5f5f5';
    };
    
    closeBtn.onmouseleave = () => {
      closeBtn.style.backgroundColor = 'transparent';
    };
    
    closeBtn.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(historyContainer);
    };
    
    header.appendChild(closeBtn);
    historyContainer.appendChild(header);
    
    // åˆ›å»ºæœç´¢æ¡†
    const searchContainer = document.createElement('div');
    searchContainer.style.cssText = `
      margin-bottom: 15px;
    `;
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'æœç´¢å†å²è®°å½•...';
    searchInput.style.cssText = `
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    `;
    
    searchContainer.appendChild(searchInput);
    historyContainer.appendChild(searchContainer);
    
    // åˆ›å»ºæ¸…é™¤å†å²è®°å½•æŒ‰é’®
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'æ¸…é™¤æ‰€æœ‰å†å²è®°å½•';
    clearBtn.style.cssText = `
      margin-bottom: 15px;
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    `;
    
    clearBtn.onmouseenter = () => {
      clearBtn.style.backgroundColor = '#dc2626';
    };
    
    clearBtn.onmouseleave = () => {
      clearBtn.style.backgroundColor = '#ef4444';
    };
    
    clearBtn.onclick = () => {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        clearHistory();
        document.body.removeChild(overlay);
        document.body.removeChild(historyContainer);
        showToast('å†å²è®°å½•å·²æ¸…é™¤');
      }
    };
    
    historyContainer.appendChild(clearBtn);
    
    // åˆ›å»ºè¡¨æ ¼å®¹å™¨
    const tableContainer = document.createElement('div');
    tableContainer.style.cssText = `
      flex: 1;
      overflow: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    `;
    
    // åˆ›å»ºè¡¨æ ¼
    const table = document.createElement('table');
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    `;
    
    // åˆ›å»ºè¡¨å¤´
    const thead = document.createElement('thead');
    thead.style.cssText = `
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 10;
    `;
    
    const headerRow = document.createElement('tr');
    const headers = ['åºå·', 'æ—¶é—´', 'JSONæ•°æ®', 'æ“ä½œ'];
    const headerWidths = ['60px', '150px', 'auto', '120px'];
    
    headers.forEach((headerText, index) => {
      const th = document.createElement('th');
      th.textContent = headerText;
      th.style.cssText = `
        padding: 10px 8px;
        text-align: left;
        border-bottom: 2px solid #ddd;
        font-weight: 600;
        width: ${headerWidths[index]};
      `;
      headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // åˆ›å»ºè¡¨ä½“
    const tbody = document.createElement('tbody');
    
    // æ·»åŠ è®°å½•åˆ°è¡¨æ ¼çš„å‡½æ•°
    function addRecordsToTable(records) {
      tbody.innerHTML = '';
      
      records.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.style.cssText = `
          border-bottom: 1px solid #eee;
          transition: background-color 0.2s;
        `;
        
        tr.onmouseenter = () => {
          tr.style.backgroundColor = '#f5f5f5';
        };
        
        tr.onmouseleave = () => {
          tr.style.backgroundColor = 'transparent';
        };
        
        // åºå·åˆ—
        const indexTd = document.createElement('td');
        indexTd.textContent = index + 1;
        indexTd.style.cssText = `
          padding: 8px;
          text-align: center;
          font-weight: 500;
        `;
        tr.appendChild(indexTd);
        
        // æ—¶é—´åˆ—
        const timeTd = document.createElement('td');
        timeTd.textContent = new Date(item.timestamp).toLocaleString();
        timeTd.style.cssText = `
          padding: 8px;
          color: #666;
        `;
        tr.appendChild(timeTd);
        
        // JSONæ•°æ®åˆ—
        const dataTd = document.createElement('td');
        dataTd.style.cssText = `
          padding: 8px;
          max-width: 500px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
          font-size: 12px;
          cursor: pointer;
          color: #2563eb;
        `;
        
        const jsonPreview = item.data.substring(0, 150) + (item.data.length > 150 ? '...' : '');
        dataTd.textContent = jsonPreview;
        dataTd.title = 'ç‚¹å‡»å¤åˆ¶å®Œæ•´JSON';
        
        // ç‚¹å‡»JSONæ•°æ®å¤åˆ¶åˆ°å‰ªè´´æ¿
        dataTd.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(item.data).then(() => {
            showToast('JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
          });
        };
        
        tr.appendChild(dataTd);
        
        // æ“ä½œåˆ—
        const actionTd = document.createElement('td');
        actionTd.style.cssText = `
          padding: 8px;
          display: flex;
          gap: 6px;
          justify-content: center;
        `;
        
        // å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'å¤åˆ¶';
        copyBtn.style.cssText = `
          padding: 4px 8px;
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: background-color 0.2s;
        `;
        
        copyBtn.onmouseenter = () => {
          copyBtn.style.backgroundColor = '#2563eb';
        };
        
        copyBtn.onmouseleave = () => {
          copyBtn.style.backgroundColor = '#3b82f6';
        };
        
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(item.data).then(() => {
            showToast('JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
          });
        };
        
        actionTd.appendChild(copyBtn);
        
        // åˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.style.cssText = `
          padding: 4px 8px;
          background: #ef4444;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: background-color 0.2s;
        `;
        
        deleteBtn.onmouseenter = () => {
          deleteBtn.style.backgroundColor = '#dc2626';
        };
        
        deleteBtn.onmouseleave = () => {
          deleteBtn.style.backgroundColor = '#ef4444';
        };
        
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            const updatedHistory = history.filter(h => h.id !== item.id);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));
            // æ›´æ–°è¡¨æ ¼
            const filteredHistory = searchInput.value 
              ? updatedHistory.filter(h => h.data.includes(searchInput.value))
              : updatedHistory;
            addRecordsToTable(filteredHistory);
            showToast('è®°å½•å·²åˆ é™¤');
          }
        };
        
        actionTd.appendChild(deleteBtn);
        tr.appendChild(actionTd);
        
        // ç‚¹å‡»æ•´è¡Œæ¢å¤æ•°æ®
        tr.onclick = () => {
          setEditorContent(item.data);
          autoFormatJson();
          document.body.removeChild(overlay);
          document.body.removeChild(historyContainer);
        };
        
        tbody.appendChild(tr);
      });
    }
    
    // åˆå§‹åŠ è½½æ‰€æœ‰è®°å½•
    addRecordsToTable(history);
    
    table.appendChild(tbody);
    tableContainer.appendChild(table);
    historyContainer.appendChild(tableContainer);
    
    // æ·»åŠ æœç´¢åŠŸèƒ½
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredHistory = history.filter(item => 
        item.data.toLowerCase().includes(searchTerm)
      );
      addRecordsToTable(filteredHistory);
    });
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
    overlay.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(historyContainer);
    };
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(overlay);
    document.body.appendChild(historyContainer);
  }
  
  // æ˜¾ç¤ºToastæç¤º
  function showToast(message) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰Toast
    let toast = document.getElementById('toast-message');
    if (toast) {
      toast.remove();
    }
    
    toast = document.createElement('div');
    toast.id = 'toast-message';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      z-index: 1001;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease-out;
    `;
    
    // æ·»åŠ åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(toast);
    
    // 3ç§’åç§»é™¤Toast
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease-out reverse';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
        if (style.parentNode) {
          style.parentNode.removeChild(style);
        }
      }, 300);
    }, 3000);
  }
</script>
