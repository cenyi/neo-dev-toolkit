---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import zhTranslations from '../../i18n/locales/zh.js';
import LanguageSwitcher from '../../components/LanguageSwitcher.astro';

// ZH 首页，固定使用zh语言
const lang = 'zh-CN';
const t = zhTranslations;
---

<BaseLayout
  title="JSON 工具 - 格式化、转换为 ISON（节省 70% Token）、CSV | 在线"
  lang={lang}
  description="在线JSON工具集：格式化、验证、对比、转换JSON为ISON、TOON、CSV、Excel、XML、YAML。ISON格式可节省高达70%的token。快速、安全的浏览器工具。"
  keywords="JSON格式化, JSON校验, JSON解析, JSON对比, JSON转ISON, JSON转TOON, token优化, 节省token, JSON转CSV, JSON转Excel"
>
  <Sidebar slot="sidebar" t={t} />
  <div slot="header">
    <LanguageSwitcher currentLocale="zh" />
  </div>

  <!-- Schema.org Structured Data for SEO & GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "JSON 格式化与解析工具",
    "description": "免费在线JSON格式化、验证和转换工具。支持JSON、URL参数、XML、YAML转换，提供字段提取和TypeScript生成功能。",
    "url": "https://tojsons.com",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": [
      "JSON 格式化和验证",
      "ISON 格式转换（节省 70% Token）",
      "TOON 格式转换",
      "URL 参数解析",
      "XML 转 JSON 转换",
      "YAML 转 JSON 转换",
      "JavaScript 字段提取",
      "TypeScript 接口生成",
      "JSON 转 CSV 转换",
      "JSON 转 Excel 转换",
      "JSON 转 XML 转换",
      "JSON 压缩",
      "JSON 转义",
      "注释移除"
    ],
    "browserRequirements": "Requires JavaScript. Compatible with all modern browsers.",
    "softwareVersion": "1.0.0",
    "author": {
      "@type": "Organization",
      "name": "JSON Viewer Team"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "ratingCount": "1250"
    }
  })} />

  <div class="json-formatter-container"
       data-enter-extraction-fn={t.enterExtractionFn}
       data-enter-data={t.enterData}
       data-extraction-error={t.extractionError}
       data-parsing-error={t.parsingError}
       data-compress-success={t.compressSuccess}
       data-escape-success={t.escapeSuccess}
       data-xml-success={t.xmlSuccess}
       data-ts-success={t.tsSuccess}
       data-csv-success={t.csvSuccess}
       data-excel-success={t.excelSuccess}
       data-ison-success={t.isonSuccess}
       data-toon-success={t.toonSuccess}>

    <div class="editor-workspace">
      <!-- 左侧输入区域 -->
      <div class="input-area">
        <!-- 编辑器容器（用于左右布局） -->
        <div class="editors-wrapper" id="editors-wrapper">
          <!-- 两个独立编辑器 -->
          <div class="input-section">
            <div class="section-header-row">
              <h1 class="section-label">JSON 工具 - 格式化、转换为 ISON（节省 70% Token）、CSV 等</h1>
              <div class="editor-hint-inline" id="editor-hint">
                <span class="hint-icon">✨</span>
                <span class="hint-text">{t.smartInput}</span>
              </div>
            </div>
            <div class="input-editor-wrapper">
              <div id="monaco-editor-container" class="monaco-editor-container"></div>
            </div>
          </div>

          <!-- 比较模式：第二个编辑器 -->
          <div class="input-section compare-editor hidden" id="compare-section">
            <h2 class="section-label">{t.rightJson}</h2>
            <div class="input-editor-wrapper">
              <div id="monaco-compare-container" class="monaco-editor-container"></div>
            </div>
          </div>
        </div>

        <!-- JSON 校验错误提示 -->
        <div id="json-validation-error" class="validation-error hidden"></div>

        <div class="extraction-section">
          <div class="extraction-controls">
            <label for="extract-fn">📊 {t.extractionLabel}</label>
            <input
              type="text"
              id="extract-fn"
              placeholder={t.extractionPlaceholder}
            />
            <button id="apply-extract">{t.apply}</button>
            <button id="clear-extract-fn">{t.clear}</button>
          </div>
        </div>

        <div class="output-controls">
          <!-- 基础操作 -->
          <button id="collapse-all">{t.collapseAll}</button>
          <button id="expand-all">{t.expandAll}</button>
          <button id="remove-comments">{t.removeComments}</button>
          <button id="compress-copy">{t.compressCopy}</button>
          <button id="escape-copy">{t.escapeCopy}</button>

          <span class="button-separator">|</span>

          <!-- 数据格式转换 -->
          <button id="json-to-xml">{t.jsonToXml}</button>
          <button id="json-to-yaml">{t.jsonToYaml}</button>
          <button id="json-to-csv">{t.jsonToCsv}</button>
          <button id="json-to-excel">{t.jsonToExcel}</button>
          <button id="json-to-html">{t.jsonToHtml}</button>
          <button id="json-to-pdf">{t.jsonToPdf}</button>

          <span class="button-separator">|</span>

          <!-- 代码生成 -->
          <button id="json-to-ts">{t.jsonToTs}</button>
          <button id="json-to-dart">{t.jsonToDart}</button>
          <button id="json-to-c">{t.jsonToC}</button>
          <button id="json-to-go">{t.jsonToGo}</button>
          <button id="json-to-rust">{t.jsonToRust}</button>
          <button id="json-to-python">{t.jsonToPython}</button>
          <button id="json-to-schema">{t.jsonToSchema}</button>

          <span class="button-separator">|</span>

          <!-- 可视化与分析 -->
          <button id="json-to-table">{t.jsonToTable}</button>
          <button id="json-compare">{t.jsonCompare}</button>

          <span class="button-separator">|</span>

          <!-- 其他 -->
          <button id="clear-btn">{t.clear}</button>
          <button id="history-btn">{t.history}</button>
          <select id="font-size-select" title="Font Size">
            <option value="11">11px</option>
            <option value="12">12px</option>
            <option value="13" selected>13px</option>
            <option value="14">14px</option>
            <option value="15">15px</option>
            <option value="16">16px</option>
          </select>
        </div>
      </div>

      <!-- 右侧输出区域 -->
      <div class="output-area" id="output-area">
        <div class="output-header">
          <span class="output-title" id="output-title">输出结果</span>
          <button class="close-output-btn" id="close-output" title="关闭">×</button>
        </div>
        <div class="output-content" id="output-content">
          <div class="output-editor-wrapper">
            <div id="output-monaco-container" class="monaco-editor-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HowTo Tutorial Section -->
    <div class="tutorial-section">
    ... (hidden due to missing translation keys) ...
  </div>

  <!-- Features Section -->
    <div class="features-section">
      <div class="section-header">
        <h2>{t.featuresTitle}</h2>
        <p>{t.featuresSubtitle}</p>
      </div>
      <div class="features-grid">
        <div class="feature-item">
          <div class="feature-number">01</div>
          <div class="feature-content">
            <div class="feature-icon">✨</div>
            <h3>{t.feature1Title}</h3>
            <p>{t.feature1Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">02</div>
          <div class="feature-content">
            <div class="feature-icon">🔄</div>
            <h3>{t.feature2Title}</h3>
            <p>{t.feature2Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">03</div>
          <div class="feature-content">
            <div class="feature-icon">🎯</div>
            <h3>{t.feature3Title}</h3>
            <p>{t.feature3Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">04</div>
          <div class="feature-content">
            <div class="feature-icon">⚡</div>
            <h3>{t.feature4Title}</h3>
            <p>{t.feature4Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">05</div>
          <div class="feature-content">
            <div class="feature-icon">💻</div>
            <h3>{t.feature5Title}</h3>
            <p>{t.feature5Desc}</p>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-number">06</div>
          <div class="feature-content">
            <div class="feature-icon">🔒</div>
            <h3>{t.feature6Title}</h3>
            <p>{t.feature6Desc}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ISON & TOON 功能亮点 -->
    <div class="ison-feature-section">
      <div class="section-header">
        <h2>🚀 新功能：使用 ISON & TOON 节省 70% Token</h2>
        <p>专为 LLM 应用和高效数据存储优化的格式</p>
      </div>
      <div class="ison-grid">
        <div class="ison-card">
          <div class="ison-icon">📊</div>
          <h3>JSON 转 ISON</h3>
          <p>使用 LLM 优化的表格格式，节省高达 70% 的 token。非常适合 AI 应用和 RAG 系统。</p>
          <ul class="ison-features">
            <li>✓ 类型安全注解</li>
            <li>✓ 平均节省 61% token</li>
            <li>✓ 基于表格的结构</li>
            <li>✓ 双向转换</li>
          </ul>
          <a href="/zh/json-to-ison" class="ison-link">了解更多 →</a>
        </div>
        <div class="ison-card">
          <div class="ison-icon">⚙️</div>
          <h3>JSON 转 TOON</h3>
          <p>用于配置文件和结构化数据的简单键值对格式。比 JSON 高效 52%。</p>
          <ul class="ison-features">
            <li>✓ 高度可读</li>
            <li>✓ 配置文件优化</li>
            <li>✓ 简单语法</li>
            <li>✓ 无损转换</li>
          </ul>
          <a href="/zh/json-to-toon" class="ison-link">了解更多 →</a>
        </div>
      </div>
    </div>

    <!-- ISON 详细介绍 -->
    <div class="ison-detailed-section">
      <div class="section-header">
        <span class="section-tag">🚀 新功能</span>
        <h2 class="section-title">ISON 格式：节省 70% Token 的 LLM 优化格式</h2>
        <p class="section-subtitle">ISON（Interchange Simple Object Notation）是专为 LLM 应用设计的高效数据格式，通过表格结构和类型注解实现显著的 token 节省</p>
      </div>

      <div class="ison-content-grid">
        <div class="content-block">
          <h3 class="content-title">什么是 ISON？</h3>
          <p class="content-description">ISON 是一种表格格式，使用 TSV（制表符分隔值）结构，并为每列添加类型注解。这种设计专门针对 LLM（大语言模型）优化，可在保持数据完整性的同时大幅减少 token 消耗。</p>

          <div class="code-example">users.tsv
id[int]	name[str]	age[int]	email[str]
1	张三	25	zhang@example.com
2	李四	30	li@example.com
3	王五	28	wang@example.com</div>

          <p class="content-description">相比之下，相同数据的 JSON 格式需要更多的字符和 token。</p>
        </div>

        <div class="content-block">
          <h3 class="content-title">Token 节省对比</h3>
          <p class="content-description">在实际测试中，ISON 格式相比 JSON 格式平均可节省 <strong>61%</strong> 的 token，在大型数据集上最高可达 <strong>70%</strong>：</p>

          <table class="token-comparison-table">
            <thead>
              <tr>
                <th>数据集</th>
                <th>JSON Tokens</th>
                <th>ISON Tokens</th>
                <th>节省比例</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>用户数据（10条）</td>
                <td>458</td>
                <td>175</td>
                <td class="token-savings">61.8%</td>
              </tr>
              <tr>
                <td>产品目录（50条）</td>
                <td>2,340</td>
                <td>876</td>
                <td class="token-savings">62.6%</td>
              </tr>
              <tr>
                <td>订单记录（100条）</td>
                <td>5,120</td>
                <td>1,536</td>
                <td class="token-savings">70.0%</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="content-block">
          <h3 class="content-title">ISON 格式结构</h3>
          <p class="content-description">ISON 使用简洁的语法来表示数据类型和结构：</p>

          <div class="format-structure">
            <strong>类型注解：</strong><br>
            • [int] - 整数<br>
            • [str] - 字符串<br>
            • [float] - 浮点数<br>
            • [bool] - 布尔值<br>
            • [array] - 数组/列表<br>
            • ~ - null 值
          </div>

          <div class="code-example"># 数组格式（表格）
table.name[col1type]	col2[type2]	col3[type3]
value1	value2	value3

# 对象格式
object.name	key1[type1]	value1
object.name	key2[type2]	value2</div>
        </div>

        <div class="content-block">
          <h3 class="content-title">使用场景</h3>
          <ul class="use-case-list">
            <li><strong>RAG 系统：</strong>将知识库数据转换为 ISON 格式，大幅降低检索时的 token 消耗</li>
            <li><strong>AI Agent：</strong>Agent 上下文数据使用 ISON 格式，可在有限的 token 窗口内处理更多数据</li>
            <li><strong>API 响应优化：</strong>LLM 应用的 API 响应使用 ISON 格式，减少传输和处理成本</li>
            <li><strong>数据存储：</strong>长期存储结构化数据，比 JSON 更节省空间</li>
            <li><strong>日志处理：</strong>结构化日志数据转换为 ISON，便于 LLM 分析和处理</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- TOON 详细介绍 -->
    <div class="toon-detailed-section">
      <div class="section-header">
        <span class="section-tag">⚙️ 配置优化</span>
        <h2 class="section-title">TOON 格式：简洁高效的键值对格式</h2>
        <p class="section-subtitle">TOON 提供了类似 INI 的配置格式，使用键值对和缩进表示层级关系，比 JSON 节省 50% 的空间</p>
      </div>

      <div class="toon-content-grid">
        <div class="content-block">
          <h3 class="content-title">什么是 TOON？</h3>
          <p class="content-description">TOON 是一种简洁的键值对格式，专为配置文件和结构化数据设计。它使用缩进来表示层级关系，语法直观易读，同时保持高效的存储效率。</p>

          <div class="code-example"># TOON 格式示例
database
	host=localhost
	port=3306
	username=admin
	password=secret123
pool
	maxConnections=100
	minConnections=10</div>

          <p class="content-description">与 JSON 相比，TOON 更加简洁，可读性更强，特别适合配置文件场景。</p>
        </div>

        <div class="content-block">
          <h3 class="content-title">TOON 语法特点</h3>
          <p class="content-description">TOON 的语法设计简洁明了：</p>

          <div class="format-structure">
            <strong>基本规则：</strong><br>
            • 使用 key=value 格式定义键值对<br>
            • 使用缩进（两个空格）表示层级关系<br>
            • 使用 # 添加注释<br>
            • 数组使用 [item1, item2] 格式<br>
            • 字符串值自动检测，无需引号（除非包含特殊字符）
          </div>

          <div class="code-example"># 嵌套对象示例
server
	domain=example.com
	ssl=true
	certificates
		key=/path/to/key.pem
		cert=/path/to/cert.pem</div>
        </div>

        <div class="content-block">
          <h3 class="content-title">使用场景</h3>
          <ul class="use-case-list">
            <li><strong>应用配置：</strong>服务器配置、数据库连接、API 密钥等</li>
            <li><strong>环境变量：</strong>部署配置、环境特定设置</li>
            <li><strong>用户偏好：</strong>应用设置、用户配置文件</li>
            <li><strong>系统参数：</strong>系统级配置、启动参数</li>
            <li><strong>CI/CD 配置：</strong>构建脚本、部署流程配置</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 格式对比 -->
    <div class="format-comparison-section">
      <div class="section-header">
        <h2 class="section-title">选择适合您的格式</h2>
        <p class="section-subtitle">根据使用场景选择最适合的数据格式，最大化效率</p>
      </div>

      <div class="comparison-grid">
        <div class="comparison-card ison">
          <span class="comparison-badge">推荐 LLM</span>
          <h3>ISON 格式</h3>
          <div class="token-saving">节省 70%</div>
          <p>最适合 AI 应用和 RAG 系统。表格结构配合类型注解，大幅减少 token 消耗。</p>
        </div>

        <div class="comparison-card toon">
          <span class="comparison-badge">配置优化</span>
          <h3>TOON 格式</h3>
          <div class="token-saving">节省 50%</div>
          <p>最适合配置文件和结构化数据。键值对格式直观易读，维护方便。</p>
        </div>

        <div class="comparison-card json">
          <span class="comparison-badge">通用标准</span>
          <h3>JSON 格式</h3>
          <div class="token-saving">基准</div>
          <p>Web 开发的标准格式，通用性强，所有平台都支持。适合一般数据交换。</p>
        </div>
      </div>
    </div>

    <!-- FAQ 部分 -->
    <div class="faq-section">
      <div class="section-header">
        <h2 class="section-title">常见问题</h2>
        <p class="section-subtitle">关于 ISON 和 TOON 格式的常见问题解答</p>
      </div>

      <div class="faq-grid">
        <div class="faq-item">
          <div class="faq-question">ISON 和 TOON 是什么格式？</div>
          <div class="faq-answer">
            <p>ISON（Interchange Simple Object Notation）是一种表格格式，专为 LLM 优化，可节省高达 70% 的 token。TOON 是一种键值对格式，适合配置文件，可节省约 50% 的空间。两种格式都可以与 JSON 双向转换。</p>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question">如何使用 ISON/TOON 转换功能？</div>
          <div class="faq-answer">
            <p>将您的 JSON 数据粘贴到页面上的输入框中，然后点击"JSON 转 ISON & Copy"或"JSON 转 TOON & Copy"按钮。转换后的内容会自动复制到剪贴板，您可以直接粘贴使用。</p>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question">ISON 真的能节省 70% 的 token 吗？</div>
          <div class="faq-answer">
            <p>是的！根据我们的测试，在包含重复键的大型数据集上，ISON 相比 JSON 可以节省高达 70% 的 token。平均节省率约为 61%，具体节省幅度取决于数据结构。</p>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question">转换后的数据可以转回 JSON 吗？</div>
          <div class="faq-answer">
            <p>目前我们提供 JSON 转 ISON/TOON 的单向转换。双向转换功能正在开发中，敬请期待。ISON 和 TOON 格式都设计了完整的信息保留机制，确保可以无损还原。</p>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question">什么情况下应该使用 ISON？</div>
          <div class="faq-answer">
            <p>当您需要在 LLM 应用中处理大量结构化数据时，应该使用 ISON。典型场景包括：RAG 系统的知识库、AI Agent 的上下文数据、API 响应优化、日志数据分析等。任何需要将数据输入 LLM 的场景都适合使用 ISON。</p>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question">什么情况下应该使用 TOON？</div>
          <div class="faq-answer">
            <p>当您需要编写或维护配置文件时，应该使用 TOON。它比 JSON 更简洁易读，比 INI 更强大。典型场景包括：应用配置、环境变量设置、服务器配置、部署脚本等。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Supported Formats Section -->
    <div class="supported-formats-section">
      <div class="section-header">
        <h2>{t.supportedFormatsTitle}</h2>
        <p>{t.supportedFormatsSubtitle}</p>
      </div>
      <div class="formats-grid">
        <div class="format-category">
          <h3>{t.formatCat1Title}</h3>
          <ul>
            <li>{t.formatCat1Item1}</li>
            <li>{t.formatCat1Item2}</li>
            <li>{t.formatCat1Item3}</li>
            <li>{t.formatCat1Item4}</li>
            <li>{t.formatCat1Item5}</li>
            <li>{t.formatCat1Item6}</li>
          </ul>
        </div>
        <div class="format-category">
          <h3>{t.formatCat2Title}</h3>
          <ul>
            <li>{t.formatCat2Item1}</li>
            <li>{t.formatCat2Item2}</li>
            <li>{t.formatCat2Item3}</li>
            <li>{t.formatCat2Item4}</li>
            <li>{t.formatCat2Item5}</li>
            <li>{t.formatCat2Item6}</li>
            <li>{t.formatCat2Item7}</li>
            <li>{t.formatCat2Item8}</li>
          </ul>
        </div>
        <div class="format-category">
          <h3>{t.formatCat3Title}</h3>
          <ul>
            <li>{t.formatCat3Item1}</li>
            <li>{t.formatCat3Item2}</li>
            <li>{t.formatCat3Item3}</li>
            <li>{t.formatCat3Item4}</li>
            <li>{t.formatCat3Item5}</li>
            <li>{t.formatCat3Item6}</li>
          </ul>
        </div>
        <div class="format-category">
          <h3>{t.formatCat4Title}</h3>
          <ul>
            <li>{t.formatCat4Item1}</li>
            <li>{t.formatCat4Item2}</li>
            <li>{t.formatCat4Item3}</li>
            <li>{t.formatCat4Item4}</li>
            <li>{t.formatCat4Item5}</li>
            <li>{t.formatCat4Item6}</li>
          </ul>
        </div>
        <div class="format-category">
          <h3>{t.formatCat5Title}</h3>
          <ul>
            <li>{t.formatCat5Item1}</li>
            <li>{t.formatCat5Item2}</li>
            <li>{t.formatCat5Item3}</li>
            <li>{t.formatCat5Item4}</li>
            <li>{t.formatCat5Item5}</li>
            <li>{t.formatCat5Item6}</li>
          </ul>
        </div>
        <div class="format-category">
          <h3>{t.formatCat6Title}</h3>
          <ul>
            <li>{t.formatCat6Item1}</li>
            <li>{t.formatCat6Item2}</li>
            <li>{t.formatCat6Item3}</li>
            <li>{t.formatCat6Item4}</li>
            <li>{t.formatCat6Item5}</li>
            <li>{t.formatCat6Item6}</li>
          </ul>
        </div>
      </div>
      <div class="formats-note">
        <p set:html={t.formatsNote} />
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="faq-section">
      <div class="section-header">
        <h2>{t.faqTitle}</h2>
        <p>{t.faqSubtitle}</p>
      </div>
      <div class="faq-grid">
        <div class="faq-item">
          <h3>{t.faq1Question}</h3>
          <p>{t.faq1Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq2Question}</h3>
          <p>{t.faq2Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq3Question}</h3>
          <p>{t.faq3Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq4Question}</h3>
          <p>{t.faq4Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq5Question}</h3>
          <p>{t.faq5Answer}</p>
        </div>
        <div class="faq-item">
          <h3>{t.faq6Question}</h3>
          <p>{t.faq6Answer}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQPage Schema for GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": t.faq1Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq1Answer
        }
      },
      {
        "@type": "Question",
        "name": t.faq2Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq2Answer
        }
      },
      {
        "@type": "Question",
        "name": t.faq3Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq3Answer
        }
      },
      {
        "@type": "Question",
        "name": t.faq4Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq4Answer
        }
      },
      {
        "@type": "Question",
        "name": t.faq5Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq5Answer
        }
      },
      {
        "@type": "Question",
        "name": t.faq6Question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": t.faq6Answer
        }
      }
    ]
  })} />

  <!-- HowTo Schema for GEO -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "HowTo",
    "name": "How to Format and Validate JSON",
    "description": "Learn how to format, validate, and convert JSON data using our free online JSON viewer tool.",
    "step": [
      {
        "@type": "HowToStep",
        "name": "Paste Your JSON Data",
        "text": "Paste your JSON, URL parameters, XML, or YAML data into the input editor.",
        "image": "https://tojsons.com/step1.png"
      },
      {
        "@type": "HowToStep",
        "name": "Automatic Format Detection",
        "text": "The tool automatically detects your input format and converts it to JSON."
      },
      {
        "@type": "HowToStep",
        "name": "View Formatted JSON",
        "text": "See your beautifully formatted JSON with syntax highlighting and line numbers."
      },
      {
        "@type": "HowToStep",
        "name": "Validate JSON",
        "text": "Any JSON errors are highlighted with specific line numbers and error messages."
      },
      {
        "@type": "HowToStep",
        "name": "Extract or Convert",
        "text": "Use field extraction, convert to XML/YAML/TypeScript, or compress/copy the result."
      }
    ],
    "tool": [
      {
        "@type": "HowToTool",
        "name": "JSON Viewer Online"
      }
    ]
  })} />
</BaseLayout>

<style>
  :root {
    --diff-red-opacity: 239, 68, 68;
    --diff-green-opacity: 34, 197, 94;
    --diff-yellow-opacity: 234, 179, 8;
  }

  .json-formatter-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 8px;
    height: calc(100vh - var(--sidebar-height, 40px));
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  /* 主工作区 - 左右布局 */
  .editor-workspace {
    display: flex;
    gap: 0;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* 左侧输入区域 */
  .input-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0 auto;
    max-width: 75%;
  }

  /* 当输出区域展开时，调整布局 */
  .output-area.expanded {
    flex: 1;
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  /* 当输出区域展开时，输入区域也调整为50% */
  .editor-workspace:has(.output-area.expanded) .input-area {
    flex: 1;
    max-width: 50%;
    margin: 0;
  }

  .input-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .section-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }

  /* H1标签样式重置，保持布局一致 */
  h1.section-label {
    margin: 0;
    padding: 4px 0 6px 0;
    font-size: 1rem;
    font-weight: 700;
    color: #0f172a;
    flex-shrink: 0;
    display: block;
  }

  h2.section-label {
    margin: 0;
    padding: 0;
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 10px;
  }

  /* Section Header Row - 标题和提示在同一行 */
  .section-header-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }

  /* Editor Hint Inline - 内联提示 */
  .editor-hint-inline {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.08) 100%);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 6px;
    padding: 4px 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .editor-hint-inline:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(37, 99, 235, 0.12) 100%);
    border-color: rgba(59, 130, 246, 0.3);
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.1);
  }

  .editor-hint-inline.hint-hidden {
    opacity: 0;
    transform: translateX(4px);
    pointer-events: none;
  }

  .editor-hint-inline .hint-icon {
    font-size: 14px;
    flex-shrink: 0;
    animation: sparkle 2s ease-in-out infinite;
  }

  @keyframes sparkle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }

  .editor-hint-inline .hint-text {
    font-size: 0.75rem;
    font-weight: 600;
    color: #3b82f6;
    white-space: nowrap;
  }

  /* 移动端优化 */
  @media (max-width: 768px) {
    .section-header-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .editor-hint-inline {
      padding: 3px 8px;
    }

    .editor-hint-inline .hint-icon {
      font-size: 12px;
    }

    .editor-hint-inline .hint-text {
      font-size: 0.7rem;
    }
  }

  /* 比较模式下的标题优化 */
  @media (max-width: 768px) {
    .editor-hint {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
    }

    .hint-icon {
      font-size: 16px;
    }

    .hint-title {
      font-size: 0.8rem;
    }

    .hint-description {
      font-size: 0.7rem;
    }

    .hint-features {
      gap: 4px;
    }

    .hint-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
    }

    .hint-security {
      font-size: 0.65rem;
      padding: 3px 8px;
      align-self: flex-start;
    }
  }

  /* 比较模式下的标题优化 */
  .editors-wrapper.compare-mode h1.section-label,
  .editors-wrapper.compare-mode h2.section-label {
    margin-top: 0;
    margin-bottom: 6px;
    text-align: center;
  }

  /* 比较模式下添加边框区分两个编辑器 */
  .editors-wrapper.compare-mode .input-section:first-child .input-editor-wrapper {
    border: 2px solid #3b82f6;
  }

  .editors-wrapper.compare-mode .compare-editor .input-editor-wrapper {
    border: 2px solid #10b981;
  }

  /* 比较模式样式 */
  .compare-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .compare-editor.hidden {
    display: none;
  }

  /* 编辑器包装容器 */
  .editors-wrapper {
    display: flex;
    flex: 1;
    gap: 0;
    min-height: 0;
  }

  /* 比较模式下的布局调整 */
  .editors-wrapper.compare-mode {
    gap: 10px;
  }

  .editors-wrapper.compare-mode .input-section {
    flex: 1;
    min-height: 0;
    min-width: 0;
  }

  .editors-wrapper.compare-mode .compare-editor {
    flex: 1;
    min-height: 0;
    min-width: 0;
  }

  /* 移动端比较模式保持上下结构 */
  @media (max-width: 768px) {
    .editors-wrapper.compare-mode {
      flex-direction: column;
    }
  }

  /* Diff结果样式 */
  .diff-result {
    padding: 16px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
    overflow: auto;
  }

  .diff-added {
    background-color: #d4edda;
    color: #155724;
    padding: 4px 8px;
    margin: 2px 0;
    border-left: 3px solid #28a745;
  }

  .diff-removed {
    background-color: #f8d7da;
    color: #721c24;
    padding: 4px 8px;
    margin: 2px 0;
    border-left: 3px solid #dc3545;
    text-decoration: line-through;
  }

  .diff-changed {
    background-color: #fff3cd;
    color: #856404;
    padding: 4px 8px;
    margin: 2px 0;
    border-left: 3px solid #ffc107;
  }

  .diff-unchanged {
    color: #6c757d;
    padding: 4px 8px;
    margin: 2px 0;
  }

  /* Monaco Editor差异高亮装饰 - 增强视觉效果 */
  .monaco-editor .diff-removed {
    background-color: rgba(239, 68, 68, 0.25) !important;
    border-left: 4px solid #ef4444 !important;
    position: relative !important;
  }

  .monaco-editor .diff-removed::before {
    content: '' !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    bottom: 0 !important;
    width: 3px !important;
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%) !important;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.4) !important;
  }

  .monaco-editor .diff-added {
    background-color: rgba(34, 197, 94, 0.25) !important;
    border-left: 4px solid #22c55e !important;
    position: relative !important;
  }

  .monaco-editor .diff-added::before {
    content: '' !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    bottom: 0 !important;
    width: 3px !important;
    background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%) !important;
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.4) !important;
  }

  .monaco-editor .diff-changed {
    background-color: rgba(234, 179, 8, 0.25) !important;
    border-left: 4px solid #eab308 !important;
    position: relative !important;
  }

  .monaco-editor .diff-changed::before {
    content: '' !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    bottom: 0 !important;
    width: 3px !important;
    background: linear-gradient(180deg, #eab308 0%, #ca8a04 100%) !important;
    box-shadow: 0 0 8px rgba(234, 179, 8, 0.4) !important;
  }

  /* 差异高亮装饰类 - 用于Monaco Editor的deltaDecorations */
  .diff-removed-decoration {
    background-color: rgba(239, 68, 68, 0.25) !important;
    border-left: 4px solid #ef4444 !important;
  }

  .diff-added-decoration {
    background-color: rgba(34, 197, 94, 0.25) !important;
    border-left: 4px solid #22c55e !important;
  }

  .diff-changed-decoration {
    background-color: rgba(234, 179, 8, 0.25) !important;
    border-left: 4px solid #eab308 !important;
  }

  /* 增强差异高亮的可见性 */
  .monaco-editor .diff-removed-decoration,
  .monaco-editor .diff-added-decoration,
  .monaco-editor .diff-changed-decoration {
    position: relative !important;
    transition: all 0.2s ease !important;
  }

  .monaco-editor .diff-removed-decoration:hover,
  .monaco-editor .diff-added-decoration:hover,
  .monaco-editor .diff-changed-decoration:hover {
    filter: brightness(0.9) !important;
  }

  /* 移动端差异高亮增强 */
  @media (max-width: 768px) {
    .monaco-editor .diff-removed-decoration {
      background-color: rgba(var(--diff-red-opacity), 0.35) !important;
      border-left: 4px solid #ef4444 !important;
      border-right: 2px solid rgba(239, 68, 68, 0.3) !important;
    }

    .monaco-editor .diff-added-decoration {
      background-color: rgba(var(--diff-green-opacity), 0.35) !important;
      border-left: 4px solid #22c55e !important;
      border-right: 2px solid rgba(34, 197, 94, 0.3) !important;
    }

    .monaco-editor .diff-changed-decoration {
      background-color: rgba(var(--diff-yellow-opacity), 0.35) !important;
      border-left: 4px solid #eab308 !important;
      border-right: 2px solid rgba(234, 179, 8, 0.3) !important;
    }

    /* 移动端差异高亮动画 */
    .monaco-editor .diff-removed-decoration,
    .monaco-editor .diff-added-decoration,
    .monaco-editor .diff-changed-decoration {
      animation: diffPulse 2s ease-in-out;
    }

    @keyframes diffPulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
  }

  .input-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    overflow: hidden;
    flex: 1;
    min-height: 0;
    position: relative;
  }

  .monaco-editor-container {
    flex: 1;
    width: 100%;
    height: 100%;
    min-height: 400px;
    position: relative;
  }

  /* 美化Monaco Editor折叠按钮 */
  .monaco-editor .codicon-add-selection,
  .monaco-editor .codicon-chevron-right,
  .monaco-editor .folding-icon::before,
  .monaco-editor .codicon-folding-expanded,
  .monaco-editor .codicon-folding-collapsed {
    content: '' !important;
  }

  /* 自定义折叠按钮样式 */
  .monaco-editor .folding-icon {
    width: 16px !important;
    height: 16px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
  }

  /* 展开状态的折叠按钮 */
  .monaco-editor .folding-icon.collapsed::after,
  .monaco-editor .codicon-folding-collapsed::after {
    content: '▶' !important;
    font-size: 10px !important;
    color: #6b7280 !important;
    display: inline-block !important;
    margin-left: 1px !important;
  }

  /* 折叠状态的折叠按钮 */
  .monaco-editor .folding-icon:not(.collapsed)::after,
  .monaco-editor .codicon-folding-expanded::after {
    content: '▼' !important;
    font-size: 9px !important;
    color: #6b7280 !important;
    display: inline-block !important;
  }

  /* 折叠按钮hover效果 */
  .monaco-editor .folding-icon:hover::after {
    color: #3b82f6 !important;
  }

  /* JSON 校验错误提示 */
  .validation-error {
    padding: 12px 16px;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fecaca;
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 0.875rem;
    color: #991b1b;
    border-left: 4px solid #ef4444;
    display: none;
    animation: slideDown 0.3s ease-out;
  }

  .validation-error {
    padding: 12px 16px;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fecaca;
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 0.875rem;
    color: #991b1b;
    border-left: 4px solid #ef4444;
    display: none;
    animation: slideDown 0.3s ease-out;
  }

  .validation-error.show {
    display: block;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 提取区域 */
  .extraction-section {
    padding: 10px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }

  .extraction-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .extraction-controls label {
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    font-size: 0.85rem;
  }

  .extraction-controls input {
    flex: 1;
    min-width: 200px;
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 13px;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: all 0.2s;
  }

  .extraction-controls input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .extraction-controls button {
    padding: 6px 14px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
  }

  #apply-extract {
    font-size: 13px;
  }

  .extraction-controls button:hover {
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    transform: translateY(-1px);
  }

  #clear-extract-fn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    font-size: 13px;
  }

  #clear-extract-fn:hover {
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }

/* 按钮组 */
  .output-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .output-controls button {
    padding: 6px 10px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    flex: 0 0 auto;
    min-width: fit-content;
  }

  .output-controls select {
    padding: 6px 10px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .output-controls select option {
    background: white;
    color: #1f2937;
    padding: 6px 10px;
  }

  .output-controls select:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  .output-controls button:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
    transform: translateY(-1px);
  }

  /* 移动端按钮交互优化 */
  .output-controls button:active {
    transform: translateY(0) scale(0.98);
    transition: all 0.1s;
  }

  .output-controls select:active {
    transform: translateY(0) scale(0.98);
    transition: all 0.1s;
  }

  #clear-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
  }

  #clear-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
  }

  /* 按钮分隔符样式 */
  .button-separator {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-weight: bold;
    padding: 0 4px;
    user-select: none;
  }

  @media (max-width: 768px) {
    .button-separator {
      display: none; /* 移动端隐藏分隔符 */
    }
  }

  /* JSON表格样式 */
  .json-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 14px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .json-table thead {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
  }

  .json-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
  }

  .json-table td {
    padding: 10px 16px;
    border-bottom: 1px solid #f3f4f6;
  }

  .json-table tbody tr:hover {
    background-color: #f9fafb;
  }

  .json-table tbody tr:last-child td {
    border-bottom: none;
  }

  .json-table .key-column {
    background-color: #f9fafb;
    font-weight: 600;
    width: 30%;
    border-right: 1px solid #e5e7eb;
  }

  .json-table .inline-code {
    background-color: #f3f4f6;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    color: #1f2937;
    display: inline-block;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .json-table .number {
    color: #ef4444;
    font-weight: 600;
  }

  .json-table .boolean-true {
    color: #10b981;
    font-weight: 600;
  }

  .json-table .boolean-false {
    color: #ef4444;
    font-weight: 600;
  }

  .table-output {
    width: 100%;
    height: 100%;
    overflow: auto;
  }

  /* 移动端特殊按钮样式 */
  #apply-extract {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }

  #apply-extract:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
  }

  /* 移动端按钮组布局优化 */
  @media (max-width: 768px) {
    .output-controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-flow: dense;
      gap: 4px;
    }

    .output-controls button,
    .output-controls select {
      min-height: 36px;
      font-size: 12px;
      padding: 8px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 最后三个按钮（清空、历史记录、字体大小选择）在移动端小屏幕情况下并排显示 */
    #clear-btn,
    #history-btn,
    #font-size-select {
      grid-column: auto;
      grid-row: span 1;
      flex: 1;
      width: auto;
      min-width: 0;
    }
  }

  /* 中文页面按钮布局优化 - 长文字需要更多空间 */
  [lang="zh-CN"] .output-controls {
    grid-template-columns: repeat(2, 1fr);
  }

  [lang="zh-CN"] .output-controls button {
    font-size: 11px;
    padding: 6px 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  [lang="zh-CN"] #history-btn {
    grid-column: span 1;
  }

  @media (max-width: 480px) {
    .output-controls {
      gap: 3px;
    }

    .output-controls button {
      min-height: 32px;
      font-size: 11px;
      padding: 4px 6px;
    }

    .output-controls select {
      min-height: 32px;
      font-size: 11px;
      padding: 4px 6px;
    }
  }

  /* 中文页面超小屏幕优化 */
  @media (max-width: 480px) {
    [lang="zh-CN"] .output-controls button {
      font-size: 10px;
      padding: 4px 6px;
    }
  }

  /* 右侧输出区域 */
  .output-area {
    width: 0;
    opacity: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 1px solid transparent;
  }

  .output-area.expanded {
    width: 50%;
    opacity: 1;
    border-left: 1px solid #e5e7eb;
    padding-left: 0;
  }

  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
    border-radius: 6px 6px 0 0;
    border: 1px solid #e9ecef;
    border-bottom: none;
  }

  .output-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .close-output-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #9ca3af;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
    line-height: 1;
  }

  .close-output-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  /* 输出内容区域，与输入框相同样式 */
  .output-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .output-editor-wrapper {
    display: flex;
    border: 1px solid #e1e4e8;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
    flex: 1;
    background: linear-gradient(to bottom, #fafbfc 0%, #f5f6f8 100%);
  }

  #output-json {
    flex: 1;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow: auto;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    min-height: 0;
  }

  /* JSON树形查看器样式 */
  .json-root {
    padding: 5px 0;
  }

  .json-bracket {
    padding: 0 5px;
  }

  .json-node {
    margin-left: 18px;
  }

  .json-property {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 2px 0;
    border-radius: 3px;
    transition: background 0.1s;
  }

  .json-property:hover {
    background: rgba(59, 130, 246, 0.05);
  }

  .json-toggle {
    display: inline-block;
    width: 14px;
    height: 14px;
    text-align: center;
    line-height: 12px;
    cursor: pointer;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    margin-right: 6px;
    font-size: 10px;
    user-select: none;
    background: #fff;
    color: #6b7280;
    transition: all 0.15s;
  }

  .json-toggle:hover {
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .json-key {
    color: #7c3aed;
    margin-right: 6px;
    font-weight: 500;
  }

  .json-separator {
    margin-right: 6px;
    color: #94a3b8;
  }

  .json-value-string {
    color: #059669;
  }

  .json-value-number {
    color: #dc2626;
  }

  .json-value-boolean {
    color: #2563eb;
  }

  .json-value-null {
    color: #9ca3af;
  }

  .json-value-object,
  .json-value-array {
    color: #1f2937;
  }

  .collapsed > .json-node {
    display: none;
  }

  /* Tutorial Section */
  .tutorial-section {
    max-width: 1800px;
    margin: 60px auto 0;
    padding: 40px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .tutorial-section .section-header,
  .faq-section .section-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .tutorial-section .section-header h2,
  .faq-section .section-header h2 {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1e293b;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .tutorial-section .section-header p,
  .faq-section .section-header p {
    font-size: 1.1rem;
    color: #64748b;
  }

  .tutorial-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .tutorial-step {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    background: white;
    padding: 24px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid transparent;
  }

  .tutorial-step:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    border-left-color: #3b82f6;
  }

  .step-number {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .step-content {
    flex: 1;
  }

  .step-content h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .step-content p {
    color: #475569;
    line-height: 1.7;
    margin-bottom: 12px;
    font-size: 0.9375rem;
  }

  .step-content p:last-child {
    margin-bottom: 0;
  }

  .step-example {
    background: #1e293b;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    overflow-x: auto;
  }

  .step-example code {
    color: #e2e8f0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre;
  }

  .example-desc {
    color: #64748b;
    font-size: 0.875rem;
    font-style: italic;
    margin-top: 8px;
  }

  .tip {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
    padding: 12px 16px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 0.875rem;
    color: #92400e;
  }

  .privacy-note {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left: 4px solid #3b82f6;
    padding: 12px 16px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 0.875rem;
    color: #1e40af;
  }

  .action-list {
    list-style: none;
    padding: 0;
    margin: 12px 0 0 0;
  }

  .action-list li {
    padding: 8px 0;
    padding-left: 24px;
    position: relative;
    color: #475569;
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .action-list li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: 700;
  }

  .action-list li strong {
    color: #0f172a;
    font-weight: 600;
  }

  /* Features Section - 创意渐变效果 */
  .features-section {
    max-width: 1800px;
    margin: 60px auto 0;
    padding: 60px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
  }

  .features-section::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: rotate 20s linear infinite;
  }

  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .features-section .section-header {
    text-align: center;
    margin-bottom: 50px;
    position: relative;
    z-index: 1;
  }

  .features-section .section-header h2 {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin-bottom: 12px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .features-section .section-header p {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .feature-item {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 0;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  .feature-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .feature-item:hover::before {
    transform: scaleX(1);
  }

  .feature-item:hover {
    transform: translateY(-8px) rotateX(2deg);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  }

  .feature-number {
    font-size: 4rem;
    font-weight: 900;
    color: rgba(102, 126, 234, 0.08);
    position: absolute;
    top: -10px;
    right: 10px;
    line-height: 1;
    transition: all 0.4s ease;
  }

  .feature-item:hover .feature-number {
    color: rgba(102, 126, 234, 0.15);
    transform: scale(1.1);
  }

  .feature-content {
    padding: 32px;
    position: relative;
    z-index: 1;
  }

  .feature-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    display: inline-block;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .feature-item:hover .feature-icon {
    transform: scale(1.2) rotate(5deg);
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
  }

  .feature-content h3 {
    font-size: 1.35rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
    transition: color 0.3s ease;
  }

  .feature-item:hover .feature-content h3 {
    color: #667eea;
  }

  .feature-content p {
    color: #64748b;
    line-height: 1.7;
    font-size: 0.95rem;
  }

  /* Supported Formats Section */
  .supported-formats-section {
    max-width: 1800px;
    margin: 60px auto 0;
    padding: 50px 20px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  }

  .supported-formats-section .section-header {
    text-align: center;
    margin-bottom: 45px;
  }

  .supported-formats-section .section-header h2 {
    font-size: 2.2rem;
    font-weight: 800;
    color: #0f172a;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .supported-formats-section .section-header p {
    font-size: 1.1rem;
    color: #64748b;
  }

  .formats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .format-category {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #e0f2fe;
  }

  .format-category:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
    border-color: #0ea5e9;
  }

  .format-category h3 {
    font-size: 1.2rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e0f2fe;
  }

  .format-category ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .format-category li {
    padding: 8px 0;
    padding-left: 24px;
    position: relative;
    color: #475569;
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .format-category li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #0ea5e9;
    font-weight: 700;
  }

  .formats-note {
    max-width: 900px;
    margin: 35px auto 0;
    padding: 18px 24px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left: 4px solid #3b82f6;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #1e40af;
    line-height: 1.7;
  }

  .formats-note strong {
    font-weight: 700;
    color: #1e3a8a;
  }

  /* FAQ Section - 2列展开样式 */
  .faq-section {
    max-width: 1800px;
    margin: 60px auto 40px;
    padding: 40px 20px;
    background: transparent;
    border-radius: 0;
    border: none;
  }

  .faq-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .faq-item {
    padding: 0;
    background: transparent;
    border-radius: 0;
    border: none;
    border-left: 3px solid #3b82f6;
    padding-left: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq-item:hover {
    border-left-color: #2563eb;
    padding-left: 24px;
  }

  .faq-item h3 {
    font-size: 1.15rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
  }

  .faq-item p {
    color: #64748b;
    line-height: 1.7;
    font-size: 0.95rem;
  }

/* 响应式设计 */
  @media (max-width: 1200px) {
    .output-area.expanded {
      width: 60%;
    }
  }

  @media (max-width: 768px) {
    .json-formatter-container {
      padding: 6px;
      height: calc(100vh - var(--sidebar-height, 40px));
      flex-shrink: 0;
    }

    .editor-workspace {
      flex-direction: column;
    }

    .input-area {
      gap: 8px;
      min-height: 300px;
      max-width: 100%;
    }

    .monaco-editor-container {
      min-height: 250px;
    }

    /* 移动端比较模式优化 */
    .editors-wrapper.compare-mode {
      flex-direction: column;
      gap: 8px;
    }

    .editors-wrapper.compare-mode .input-section {
      min-height: 200px;
    }

    /* 移动端编辑器容器优化 */
    .input-editor-wrapper {
      min-height: 200px;
    }

    .extraction-controls {
      flex-wrap: wrap;
      gap: 6px;
    }

    .extraction-controls input {
      min-width: 100%;
      margin-bottom: 6px;
    }

    .extraction-controls label {
      width: 100%;
      margin-bottom: 4px;
    }

    .json-input {
      min-height: 200px;
    }

    .output-controls {
      gap: 4px;
      flex-wrap: wrap;
    }

    .output-controls button {
      padding: 8px 12px;
      font-size: 12px;
      flex: 1;
      min-width: 70px;
      height: 36px;
    }

    .output-controls select {
      flex: 1;
      min-width: 90px;
      height: 36px;
      padding: 8px 12px;
    }

    .output-area.expanded {
      width: 100%;
      border-left: none;
      padding-left: 0;
      margin-top: 12px;
      height: 350px;
    }

    /* 移动端Monaco Editor优化 */
    .monaco-editor-container {
      min-height: 200px;
    }

    /* 移动端差异高亮优化 */
    .monaco-editor .diff-removed-decoration,
    .monaco-editor .diff-added-decoration,
    .monaco-editor .diff-changed-decoration {
      background-color: rgba(var(--diff-opacity), 0.3) !important;
      border-left-width: 3px !important;
    }

    /* 移动端编辑器触摸优化 */
    .monaco-editor {
      touch-action: pan-y;
    }

    .monaco-editor .margin {
      touch-action: none;
    }

    /* 移动端提取区域优化 */
    .extraction-section {
      padding: 8px;
    }

    .extraction-controls {
      gap: 8px;
    }

    .extraction-controls input {
      padding: 8px 12px;
      font-size: 14px;
      min-height: 40px;
    }

    .extraction-controls button {
      min-height: 40px;
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Tutorial section 移动端优化 */
    .tutorial-step {
      flex-direction: column;
      padding: 16px;
    }

    .step-number {
      margin-bottom: 12px;
    }

    .section-header {
      padding: 20px 12px;
    }

    .section-header h2 {
      font-size: 1.5rem;
    }

    /* Features 移动端优化 */
    .features-grid {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 0 12px;
    }

    /* Supported Formats 移动端优化 */
    .formats-grid {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 0 12px;
    }

    .format-category {
      padding: 18px;
    }

    .formats-note {
      margin: 25px 12px 0;
      padding: 14px 18px;
      font-size: 0.9rem;
    }

    /* FAQ 移动端优化 */
    .faq-grid {
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 0 12px;
    }

    .faq-item {
      border-left-width: 2px;
      padding-left: 16px;
    }

    .faq-item:hover {
      padding-left: 18px;
    }
  }

  @media (max-width: 480px) {
    .json-formatter-container {
      padding: 4px;
    }

    .input-area {
      gap: 6px;
    }

    .output-controls {
      gap: 3px;
    }

    .output-controls button {
      flex: 1;
      min-width: 0;
      padding: 6px 8px;
      font-size: 11px;
      height: 32px;
    }

    .output-controls select {
      height: 32px;
      padding: 6px 8px;
      font-size: 11px;
    }

    .json-action-group {
      flex: 1;
    }

    .json-input {
      min-height: 150px;
      font-size: 12px;
    }

    .extraction-section {
      padding: 6px;
    }

    .monaco-editor-container {
      min-height: 150px;
    }

    /* 超小屏幕比较模式优化 */
    .editors-wrapper.compare-mode .input-section {
      min-height: 150px;
    }

    .input-editor-wrapper {
      min-height: 150px;
    }
  }

  /* 移动端横屏优化 */
  @media (max-width: 768px) and (orientation: landscape) {
    .json-formatter-container {
      height: calc(100vh - 20px);
    }

    .input-area {
      min-height: 200px;
    }

    .monaco-editor-container {
      min-height: 180px;
    }

    .editors-wrapper.compare-mode .input-section {
      min-height: 160px;
    }

    .output-area.expanded {
      height: 250px;
    }
  }

  /* ISON & TOON 详细部分样式 */
  .ison-detailed-section,
  .toon-detailed-section {
    padding: 80px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  .toon-detailed-section {
    background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
  }

  .section-header {
    text-align: center;
    margin-bottom: 60px;
  }

  .section-tag {
    display: inline-block;
    padding: 8px 16px;
    background: #dbeafe;
    color: #1e40af;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 16px;
  }

  .section-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 16px;
  }

  .section-subtitle {
    font-size: 1.125rem;
    color: #64748b;
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.7;
  }

  .ison-content-grid,
  .toon-content-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    gap: 60px;
  }

  .content-block {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .content-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 20px;
  }

  .content-description {
    color: #475569;
    line-height: 1.8;
    margin-bottom: 30px;
  }

  .code-example {
    background: #1e293b;
    color: #e2e8f0;
    padding: 24px;
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.875rem;
    overflow-x: auto;
    margin: 20px 0;
  }

  .token-comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin: 30px 0;
  }

  .token-comparison-table th,
  .token-comparison-table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .token-comparison-table th {
    background: #f1f5f9;
    font-weight: 700;
    color: #0f172a;
  }

  .token-savings {
    color: #16a34a;
    font-weight: 700;
  }

  .format-structure {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
  }

  .use-case-list {
    list-style: none;
    padding: 0;
  }

  .use-case-list li {
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: start;
  }

  .use-case-list li:before {
    content: "✓";
    color: #16a34a;
    font-weight: 700;
    margin-right: 12px;
    font-size: 1.25rem;
  }

  /* 格式对比部分 */
  .format-comparison-section {
    padding: 80px 20px;
    background: white;
  }

  .comparison-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
  }

  .comparison-card {
    padding: 40px 30px;
    border-radius: 16px;
    text-align: center;
    transition: transform 0.2s;
  }

  .comparison-card:hover {
    transform: translateY(-8px);
  }

  .comparison-card.ison {
    background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
  }

  .comparison-card.toon {
    background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
  }

  .comparison-card.json {
    background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
  }

  .comparison-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .comparison-card.ison .comparison-badge {
    background: #1e40af;
    color: white;
  }

  .comparison-card.toon .comparison-badge {
    background: #b45309;
    color: white;
  }

  .comparison-card.json .comparison-badge {
    background: #475569;
    color: white;
  }

  .comparison-card h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 12px;
    color: #0f172a;
  }

  .comparison-card .token-saving {
    font-size: 2rem;
    font-weight: 800;
    margin: 20px 0;
  }

  .comparison-card.ison .token-saving {
    color: #16a34a;
  }

  .comparison-card.toon .token-saving {
    color: #b45309;
  }

  .comparison-card.json .token-saving {
    color: #64748b;
  }

  .comparison-card p {
    color: #475569;
    line-height: 1.7;
  }

  /* FAQ 部分 */
  .faq-section {
    padding: 80px 20px;
    background: #f8fafc;
  }

  .faq-grid {
    max-width: 900px;
    margin: 0 auto;
  }

  .faq-item {
    background: white;
    margin-bottom: 16px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .faq-question {
    padding: 24px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: #0f172a;
    user-select: none;
    transition: background 0.2s;
  }

  .faq-question:hover {
    background: #f8fafc;
  }

  .faq-question:after {
    content: "+";
    font-size: 1.5rem;
    color: #3b82f6;
    font-weight: 700;
  }

  .faq-item.active .faq-question:after {
    content: "−";
  }

  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding: 0 24px;
  }

  .faq-item.active .faq-answer {
    max-height: 500px;
    padding: 0 24px 24px;
  }

  .faq-answer p {
    color: #475569;
    line-height: 1.7;
    padding-top: 8px;
  }

  /* 响应式样式 */
  @media (max-width: 768px) {
    .ison-detailed-section,
    .toon-detailed-section,
    .format-comparison-section,
    .faq-section {
      padding: 60px 16px;
    }

    .section-title {
      font-size: 2rem;
    }

    .content-block {
      padding: 24px;
    }

    .comparison-grid {
      grid-template-columns: 1fr;
    }

    .token-comparison-table {
      font-size: 0.875rem;
    }

    .token-comparison-table th,
    .token-comparison-table td {
      padding: 12px 8px;
    }
  }
</style>

<script type="module">
  // 配置 Monaco Editor 的资源路径
  window.MonacoEnvironment = {
    getWorkerUrl: function (workerId, label) {
      return `https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/workers/${label === 'json' ? 'json.worker' : 'editor.worker'}.js`;
    }
  };

  // 使用 CDN 导入 Monaco Editor
  import * as monaco from 'https://esm.sh/monaco-editor@0.45.0';

  // 配置 Monaco Editor
  monaco.editor.setTheme('vs');

  // 全局变量
  let editor = null;
  let outputEditor = null;
  let compareEditor = null;
  let translations = {};
  let isCompareMode = false;
  let leftDecorations = [];
  let rightDecorations = [];

  // DOM加载完成后初始化
  document.addEventListener('DOMContentLoaded', () => {
    // 从DOM元素获取翻译文本
    const container = document.querySelector('.json-formatter-container');
    translations = {
      enterExtractionFn: container.dataset.enterExtractionFn,
      enterData: container.dataset.enterData,
      extractionError: container.dataset.extractionError,
      parsingError: container.dataset.parsingError,
      compressSuccess: container.dataset.compressSuccess,
      escapeSuccess: container.dataset.escapeSuccess,
      xmlSuccess: container.dataset.xmlSuccess,
      tsSuccess: container.dataset.tsSuccess,
      csvSuccess: container.dataset.csvSuccess,
      excelSuccess: container.dataset.excelSuccess
    };

    // 初始化 Monaco Editor
    initializeMonacoEditor();

    initializeJsonFormatter();

    // 初始化 FAQ 功能
    initializeFaq();
  });

  // FAQ 交互功能
  function initializeFaq() {
    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => {
      const question = item.querySelector('.faq-question');
      if (question) {
        question.addEventListener('click', () => {
          // 关闭其他打开的 FAQ
          faqItems.forEach(otherItem => {
            if (otherItem !== item) {
              otherItem.classList.remove('active');
            }
          });
          // 切换当前 FAQ
          item.classList.toggle('active');
        });
      }
    });
  }

  // 初始化 Monaco Editor
  function initializeMonacoEditor() {
    const container = document.getElementById('monaco-editor-container');
    if (!container) {
      console.error('Monaco Editor container not found');
      return;
    }

    // 等待页面完全渲染，包括 CSS 样式应用
    // 使用双重 requestAnimationFrame 确保浏览器完成布局计算
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        // 确保容器有正确的尺寸
        console.log('Container dimensions:', {
          width: container.offsetWidth,
          height: container.offsetHeight
        });

        // 如果容器尺寸还是异常，再延迟一点
        if (container.offsetWidth === 0 || container.offsetHeight === 0) {
          setTimeout(() => createEditor(container), 50);
        } else {
          createEditor(container);
        }
      });
    });
  }

  // 创建 Monaco Editor
  function createEditor(container) {
    // 获取保存的字体大小
    const savedFontSize = localStorage.getItem('editorFontSize') || '13';

    // 创建输入编辑器
    editor = monaco.editor.create(container, {
      value: '',
      language: 'json',
      theme: 'vs',
      automaticLayout: true,
      fontSize: parseInt(savedFontSize),
      fontFamily: "'Monaco', 'Menlo', 'Ubuntu Mono', monospace",
      lineHeight: 21,
      minimap: { enabled: false },
      scrollBeyondLastLine: false,
      wordWrap: 'off',
      // 行号配置
      lineNumbers: 'on',
      lineNumbersMinChars: 3,
      // 折叠配置
      folding: true,
      foldingStrategy: 'indentation',
      foldingHighlight: true,
      showFoldingControls: 'always',
      // 其他配置
      matchBrackets: 'always',
      autoClosingBrackets: 'always',
      autoClosingQuotes: 'always',
      formatOnPaste: true,
      formatOnType: true,
      tabSize: 2,
      renderLineHighlight: 'all',
      scrollbar: {
        vertical: 'visible',
        horizontal: 'visible'
      },
      padding: { top: 12, bottom: 12 },
      readOnly: false
    });

    console.log('Monaco Editor created successfully');

    // 创建输出编辑器
    const outputContainer = document.getElementById('output-monaco-container');
    if (outputContainer) {
      outputEditor = monaco.editor.create(outputContainer, {
        value: '',
        language: 'json',
        theme: 'vs',
        automaticLayout: true,
        fontSize: parseInt(savedFontSize),
        fontFamily: "'Monaco', 'Menlo', 'Ubuntu Mono', monospace",
        lineHeight: 21,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        wordWrap: 'off',
        lineNumbers: 'on',
        lineNumbersMinChars: 3,
        folding: true,
        foldingStrategy: 'indentation',
        foldingHighlight: true,
        showFoldingControls: 'always',
        matchBrackets: 'always',
        tabSize: 2,
        renderLineHighlight: 'all',
        scrollbar: {
          vertical: 'visible',
          horizontal: 'visible'
        },
        padding: { top: 12, bottom: 12 },
        readOnly: true  // 输出编辑器只读
      });
      console.log('Output Monaco Editor created successfully');
    }

    // 创建比较编辑器
    const compareContainer = document.getElementById('monaco-compare-container');
    if (compareContainer) {
      compareEditor = monaco.editor.create(compareContainer, {
        value: '',
        language: 'json',
        theme: 'vs',
        automaticLayout: true,
        fontSize: parseInt(savedFontSize),
        fontFamily: "'Monaco', 'Menlo', 'Ubuntu Mono', monospace",
        lineHeight: 21,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        wordWrap: 'off',
        lineNumbers: 'on',
        lineNumbersMinChars: 3,
        folding: true,
        foldingStrategy: 'indentation',
        foldingHighlight: true,
        showFoldingControls: 'always',
        matchBrackets: 'always',
        autoClosingBrackets: 'always',
        autoClosingQuotes: 'always',
        formatOnPaste: true,
        formatOnType: true,
        tabSize: 2,
        renderLineHighlight: 'all',
        scrollbar: {
          vertical: 'visible',
          horizontal: 'visible'
        },
        padding: { top: 12, bottom: 12 },
        readOnly: false
      });
      console.log('Compare Monaco Editor created successfully');

      // 监听比较编辑器内容变化，自动更新差异高亮
      compareEditor.onDidChangeModelContent(() => {
        if (isCompareMode) {
          highlightDifferences();
        }
      });
    }

    // 调试：检查 DOM 结构
    setTimeout(() => {
      const monacoContainer = container.querySelector('.monaco-editor');
      if (monacoContainer) {
        const margin = monacoContainer.querySelector('.margin');
        console.log('Monaco DOM structure:', {
          container: container.offsetWidth,
          monacoEditor: monacoContainer.offsetWidth,
          margin: margin ? margin.offsetWidth : 'NOT FOUND',
          marginVisible: margin ? window.getComputedStyle(margin).display : 'N/A'
        });
      }
    }, 200);

    // 强制更新布局
    setTimeout(() => {
      if (editor) {
        editor.layout();
        console.log('Monaco Editor layout updated');
      }
    }, 100);

    // 监听内容变化，自动格式化和保存历史
    editor.onDidChangeModelContent(() => {
      clearTimeout(window.autoFormatTimeout);
      window.autoFormatTimeout = setTimeout(autoFormatJson, 500);

      // 如果在比较模式，更新差异高亮
      if (isCompareMode) {
        highlightDifferences();
      }

      // 控制提示显示/隐藏
      const hint = document.getElementById('editor-hint');
      if (hint) {
        const hasContent = getEditorContent().trim().length > 0;
        if (hasContent) {
          hint.classList.add('hint-hidden');
        } else {
          hint.classList.remove('hint-hidden');
        }
      }
    });

    // 监听 JSON 错误标记变化
    monaco.editor.onDidChangeMarkers(() => {
      const errorElement = document.getElementById('json-validation-error');
      if (!errorElement) return;

      const model = editor.getModel();
      if (!model) return;

      const modelMarkers = model.getAllMarkers();
      if (modelMarkers.length === 0) {
        // 没有错误，隐藏提示
        errorElement.classList.remove('show');
        errorElement.textContent = '';
      } else {
        // 有错误，显示第一个错误
        const firstError = modelMarkers[0];
        const line = model.getLineContent(firstError.startLineNumber);
        const errorInfo = firstError.message;

        // 获取当前语言
        const currentLang = window.appState.lang || 'en';
        const errorMessage = currentLang === 'zh'
          ? `第 ${firstError.startLineNumber} 行错误：${errorInfo}`
          : `Line ${firstError.startLineNumber} error: ${errorInfo}`;

        errorElement.textContent = errorMessage;
        errorElement.classList.add('show');
      }
    });
  }

  // 获取编辑器中的文本
  function getEditorContent() {
    return editor ? editor.getValue() : '';
  }

  // 设置编辑器中的文本
  function setEditorContent(content) {
    if (editor) {
      editor.setValue(content);
    }
  }

  // ============ 输入类型检测和解析函数 ============

  // 检测输入类型
  function detectInputType(inputText) {
    const trimmed = inputText.trim();

    // 检测是否为URL参数
    if (trimmed.includes('?') || /^\w+=/.test(trimmed)) {
      return 'urlparams';
    }

    // 检测是否为XML
    if (trimmed.startsWith('<?xml') || trimmed.startsWith('<!DOCTYPE') || /^<[\w-]+/.test(trimmed)) {
      return 'xml';
    }

    // 检测是否为YAML
    if (/^[\w-]+:\s*\n/.test(trimmed) || /^[\w-]+:\s*\S+/.test(trimmed)) {
      // 简单的YAML特征：包含键值对，使用冒号分隔
      // 排除JSON（JSON已经被JSON.parse处理过了）
      try {
        JSON.parse(trimmed);
        return 'json';
      } catch {
        return 'yaml';
      }
    }

    // 默认尝试JSON
    return 'json';
  }

  // 解析URL参数为JSON对象
  function parseUrlParams(inputText) {
    const result = {};

    // 移除URL前面的部分，只保留查询字符串
    let queryString = inputText.trim();
    const questionMarkIndex = queryString.indexOf('?');
    if (questionMarkIndex !== -1) {
      queryString = queryString.substring(questionMarkIndex + 1);
    }

    // 分割参数
    const pairs = queryString.split('&');

    for (const pair of pairs) {
      if (!pair) continue;

      let [key, value] = pair.split('=');

      // 解码URL编码
      if (key) {
        key = decodeURIComponent(key.replace(/\+/g, ' '));
      }
      if (value !== undefined) {
        value = decodeURIComponent(value.replace(/\+/g, ' '));
      } else {
        value = '';
      }

      // 尝试将值转换为数字或布尔值
      if (value === 'true') {
        value = true;
      } else if (value === 'false') {
        value = false;
      } else if (!isNaN(value) && value !== '') {
        const num = parseFloat(value);
        if (!isNaN(num)) {
          value = num;
        }
      }

      // 处理重复的键（转换为数组）
      if (key in result) {
        if (!Array.isArray(result[key])) {
          result[key] = [result[key]];
        }
        result[key].push(value);
      } else {
        result[key] = value;
      }
    }

    return result;
  }

  // 解析XML为JSON对象
  function parseXml(inputText) {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(inputText, 'text/xml');

    // 检查解析错误
    const parseError = xmlDoc.getElementsByTagName('parsererror');
    if (parseError.length > 0) {
      throw new Error('Invalid XML format');
    }

    // 递归转换XML节点为JSON
    function xmlTojson(node) {
      // 文本节点
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent.trim();
        return text;
      }

      // 元素节点
      if (node.nodeType === Node.ELEMENT_NODE) {
        const obj = {};

        // 处理属性
        if (node.attributes) {
          for (let i = 0; i < node.attributes.length; i++) {
            const attr = node.attributes[i];
            obj['@' + attr.name] = attr.value;
          }
        }

        // 处理子节点
        const children = {};
        let hasChildren = false;

        for (let i = 0; i < node.childNodes.length; i++) {
          const child = node.childNodes[i];

          if (child.nodeType === Node.TEXT_NODE) {
            const text = child.textContent.trim();
            if (text) {
              // 如果只有文本内容，直接返回
              if (Object.keys(obj).length === 0) {
                return text;
              }
              obj['#text'] = text;
            }
          } else if (child.nodeType === Node.ELEMENT_NODE) {
            hasChildren = true;
            const childName = child.nodeName;
            const childValue = xmlTojson(child);

            if (childName in children) {
              // 重复的节点转换为数组
              if (!Array.isArray(children[childName])) {
                children[childName] = [children[childName]];
              }
              children[childName].push(childValue);
            } else {
              children[childName] = childValue;
            }
          }
        }

        // 合并属性和子节点
        if (hasChildren) {
          Object.assign(obj, children);
        }

        // 如果只有属性，返回对象
        // 如果属性为空且只有一个子节点，返回子节点
        if (Object.keys(obj).length === 0) {
          return null;
        }

        return obj;
      }

      return null;
    }

    // 从根元素开始转换
    const rootElement = xmlDoc.documentElement;
    const result = {};
    result[rootElement.nodeName] = xmlTojson(rootElement);

    return result;
  }

  // 解析YAML为JSON对象（简化版，支持常用YAML语法）
  function parseYaml(inputText) {
    const lines = inputText.split('\n');
    const root = {};
    const stack = [{ obj: root, indent: -1 }];

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      const indent = line.search(/\S/);

      if (indent === -1) continue; // 空行

      // 回退到正确的层级
      while (stack.length > 1 && stack[stack.length - 1].indent >= indent) {
        stack.pop();
      }

      const current = stack[stack.length - 1].obj;

      // 移除注释
      const commentIndex = line.indexOf('#');
      if (commentIndex !== -1) {
        line = line.substring(0, commentIndex);
      }

      // 解析键值对
      const colonIndex = line.indexOf(':');
      if (colonIndex === -1) continue;

      const key = line.substring(indent, colonIndex).trim();
      let valueStr = line.substring(colonIndex + 1).trim();

      // 处理不同的值类型
      let value;
      if (!valueStr || valueStr === '') {
        // 空值，可能是对象或数组的开始
        // 检查下一行来判断
        if (i + 1 < lines.length) {
          const nextLine = lines[i + 1];
          const nextIndent = nextLine.search(/\S/);

          if (nextIndent > indent) {
            // 下一行缩进更大，表示这是一个对象/数组
            value = nextLine.trim().startsWith('-') ? [] : {};
            stack.push({ obj: value, indent: indent });
          } else {
            value = null;
          }
        } else {
          value = null;
        }
      } else if (valueStr.startsWith('[') && valueStr.endsWith(']')) {
        // 内联数组
        try {
          value = JSON.parse(valueStr);
        } catch {
          value = valueStr;
        }
      } else if (valueStr.startsWith('{') && valueStr.endsWith('}')) {
        // 内联对象
        try {
          value = JSON.parse(valueStr);
        } catch {
          value = valueStr;
        }
      } else if (valueStr === 'true' || valueStr === 'false') {
        // 布尔值
        value = valueStr === 'true';
      } else if (valueStr === 'null' || valueStr === '~') {
        // null值
        value = null;
      } else if (valueStr.startsWith('"') || valueStr.startsWith("'")) {
        // 带引号的字符串
        value = valueStr.slice(1, -1);
      } else if (!isNaN(valueStr)) {
        // 数字
        value = parseFloat(valueStr);
      } else if (valueStr.startsWith('|') || valueStr.startsWith('>')) {
        // 多行字符串
        let multiLine = '';
        let j = i + 1;
        while (j < lines.length) {
          const nextLine = lines[j];
          const nextIndent = nextLine.search(/\S/);
          if (nextIndent <= indent) break;
          multiLine += (multiLine ? '\n' : '') + nextLine.trim();
          j++;
        }
        value = multiLine;
        i = j - 1;
      } else {
        // 普通字符串
        value = valueStr;
      }

      // 处理数组项（以-开头）
      if (key.startsWith('-')) {
        const arrayKey = key.substring(1).trim();
        if (!Array.isArray(current)) {
          // 转换当前对象为数组
          const temp = {};
          Object.assign(temp, current);
          const parentArray = [];
          if (Object.keys(temp).length > 0) {
            parentArray.push(temp);
          }
          // 这里需要特殊情况处理，简化处理
          if (arrayKey) {
            if (Array.isArray(current)) {
              current.push({ [arrayKey]: value });
            } else {
              current[arrayKey] = value;
            }
          } else {
            if (Array.isArray(current)) {
              current.push(value);
            } else {
              const arr = [value];
              Object.assign(current, arr);
            }
          }
        }
      } else {
        current[key] = value;
      }
    }

    return root;
  }

  // 自动格式化函数
  function autoFormatJson() {
    const inputText = getEditorContent().trim();

    if (!inputText) {
      return;
    }

    try {
      // 检测输入类型
      const inputType = detectInputType(inputText);

      let parsed;
      let converted = false;

      // 根据类型解析
      if (inputType === 'json') {
        parsed = JSON.parse(inputText);
      } else if (inputType === 'urlparams') {
        parsed = parseUrlParams(inputText);
        converted = true;
      } else if (inputType === 'xml') {
        parsed = parseXml(inputText);
        converted = true;
      } else if (inputType === 'yaml') {
        parsed = parseYaml(inputText);
        converted = true;
      } else {
        // 默认尝试JSON
        parsed = JSON.parse(inputText);
      }

      // 格式化JSON
      const formatted = JSON.stringify(parsed, null, 2);

      // 只有当格式化后的内容与当前不同时才更新
      if (formatted !== inputText) {
        // 保存当前光标位置和滚动位置
        const position = editor ? editor.getPosition() : null;
        const scrollTop = editor ? editor.getScrollTop() : null;

        // 更新编辑器内容
        setEditorContent(formatted);

        // 恢复光标位置和滚动位置
        if (position && editor) {
          editor.setPosition(position);
        }
        if (scrollTop !== null && editor) {
          editor.setScrollTop(scrollTop);
        }

        // 如果转换成功，显示提示
        if (converted) {
          const typeNames = {
            'urlparams': 'URL Parameters',
            'xml': 'XML',
            'yaml': 'YAML'
          };
          showToast(`Converted from ${typeNames[inputType]} to JSON`);
        }
      }

      // 保存到历史记录
      saveToHistory(formatted);
    } catch (e) {
      // 解析失败，不做处理
      console.debug('Parsing error:', e);
    }
  }

  // JSON树形查看器
  class JsonViewer {
    constructor(containerId, data) {
      this.container = document.getElementById(containerId);
      if (!this.container) return;

      this.data = data;
      this.render();
      this.bindEvents();
    }

    render() {
      this.container.innerHTML = this.renderValue(this.data, '', true);
    }

    renderValue(value, key = '', hasNext = true) {
      if (value === null) {
        return this.renderProperty(key, `<span class="json-value-null">null</span>`, hasNext);
      }

      if (typeof value === 'object') {
        if (Array.isArray(value)) {
          return this.renderObjectOrArray(key, value, 'array', hasNext);
        } else {
          return this.renderObjectOrArray(key, value, 'object', hasNext);
        }
      }

      if (typeof value === 'string') {
        return this.renderProperty(key, `<span class="json-value-string">"${this.escapeHtml(value)}"</span>`, hasNext);
      }

      if (typeof value === 'number') {
        return this.renderProperty(key, `<span class="json-value-number">${value}</span>`, hasNext);
      }

      if (typeof value === 'boolean') {
        return this.renderProperty(key, `<span class="json-value-boolean">${value}</span>`, hasNext);
      }

      return this.renderProperty(key, value, hasNext);
    }

    renderProperty(key, value, hasNext) {
      if (key === '') {
        if (typeof value === 'object') {
          if (Array.isArray(value)) {
            return this.renderObjectContent(value, 'array');
          } else {
            return this.renderObjectContent(value, 'object');
          }
        }
        return `<div class="json-root">${value}${hasNext ? ',' : ''}</div>`;
      }

      return `
        <div class="json-property">
          <span class="json-toggle">▼</span>
          <span class="json-key">"${key}"</span>
          <span class="json-separator">:</span>
          <span class="json-value">${value}</span>
          ${hasNext ? '<span>,</span>' : ''}
        </div>
      `;
    }

    renderObjectOrArray(key, value, type, hasNext) {
      const length = Array.isArray(value) ? value.length : Object.keys(value).length;
      const displayName = type === 'array' ? `[${length}]` : `{${length}}`;

      return `
        <div class="json-property collapsible">
          <span class="json-toggle">▼</span>
          ${key ? `<span class="json-key">"${key}"</span><span class="json-separator">:</span>` : ''}
          <span class="json-value json-value-${type}">${displayName}</span>
          ${hasNext ? '<span>,</span>' : ''}
          <div class="json-node">${this.renderObjectContent(value)}</div>
        </div>
      `;
    }

    renderObjectContent(obj) {
      if (Array.isArray(obj)) {
        return `
          <div class="json-bracket">[</div>
          <div class="json-node">
            ${obj.map((item, index) => {
              const hasNext = index < obj.length - 1;
              return this.renderValue(item, '', hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">]</div>
        `;
      } else {
        const entries = Object.entries(obj);
        return `
          <div class="json-bracket">{</div>
          <div class="json-node">
            ${entries.map(([key, value], index) => {
              const hasNext = index < entries.length - 1;
              return this.renderValue(value, key, hasNext);
            }).join('')}
          </div>
          <div class="json-bracket">}</div>
        `;
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    bindEvents() {
      this.container.addEventListener('click', (e) => {
        const toggle = e.target.closest('.json-toggle');
        if (toggle) {
          this.toggleNode(toggle);
        }
      });
    }

    toggleNode(toggle) {
      const property = toggle.parentElement;
      property.classList.toggle('collapsed');

      if (property.classList.contains('collapsed')) {
        toggle.textContent = '▶';
      } else {
        toggle.textContent = '▼';
      }
    }
  }

  // 将 JsonViewer 暴露到全局
  window.JsonViewer = JsonViewer;

  // 展开输出区域
  function expandOutput(title = '输出结果') {
    const outputArea = document.getElementById('output-area');
    const outputTitle = document.getElementById('output-title');
    outputArea.classList.add('expanded');
    outputTitle.textContent = title;
  }

  // 关闭输出区域
  function closeOutput() {
    const outputArea = document.getElementById('output-area');
    outputArea.classList.remove('expanded');
  }

  // 显示JSON结果
  function showJsonResult(data, title = '格式化结果') {
    if (outputEditor) {
      const jsonStr = JSON.stringify(data, null, 2);
      outputEditor.setValue(jsonStr);
      expandOutput(title);
    } else {
      console.error('Output editor not initialized');
    }
  }

  function initializeJsonFormatter() {
    // 应用提取函数
    document.getElementById('apply-extract').addEventListener('click', () => {
      applyExtractFunction();
    });

    // 清空提取函数输入框
    document.getElementById('clear-extract-fn').addEventListener('click', () => {
      document.getElementById('extract-fn').value = '';
    });

    // 按钮事件绑定
    document.getElementById('clear-btn').addEventListener('click', clearInputs);
    document.getElementById('collapse-all').addEventListener('click', collapseAll);
    document.getElementById('expand-all').addEventListener('click', expandAll);
    document.getElementById('remove-comments').addEventListener('click', removeComments);
    document.getElementById('compress-copy').addEventListener('click', () => compressAndCopy());
    document.getElementById('escape-copy').addEventListener('click', () => escapeAndCopy());
    document.getElementById('json-to-xml').addEventListener('click', () => jsonToXmlAndCopy());
    document.getElementById('json-to-ts').addEventListener('click', () => jsonToTsAndCopy());
    document.getElementById('json-to-csv').addEventListener('click', () => jsonToCsvAndCopy());
    document.getElementById('json-to-excel').addEventListener('click', () => jsonToExcelAndCopy());
    document.getElementById('json-to-yaml').addEventListener('click', () => jsonToYamlAndCopy());
    document.getElementById('json-to-html').addEventListener('click', () => jsonToHtmlAndCopy());
    document.getElementById('json-to-table').addEventListener('click', () => jsonToTable());
    document.getElementById('json-to-schema').addEventListener('click', () => jsonToSchema());
    document.getElementById('json-to-pdf').addEventListener('click', () => jsonToPdf());
    document.getElementById('json-to-dart').addEventListener('click', () => jsonToDartAndCopy());
    document.getElementById('json-to-c').addEventListener('click', () => jsonToCAndCopy());
    document.getElementById('json-to-go').addEventListener('click', () => jsonToGoAndCopy());
    document.getElementById('json-to-rust').addEventListener('click', () => jsonToRustAndCopy());
    document.getElementById('json-to-python').addEventListener('click', () => jsonToPythonAndCopy());
    document.getElementById('json-compare').addEventListener('click', () => toggleCompareMode());
    document.getElementById('close-output').addEventListener('click', closeOutput);
    document.getElementById('history-btn').addEventListener('click', showHistory);

    // 字体大小选择器
    const fontSizeSelect = document.getElementById('font-size-select');
    const savedFontSize = localStorage.getItem('editorFontSize') || '13';
    fontSizeSelect.value = savedFontSize;

    fontSizeSelect.addEventListener('change', (e) => {
      const fontSize = parseInt(e.target.value);
      if (editor) {
        editor.updateOptions({ fontSize: fontSize });
      }
      if (outputEditor) {
        outputEditor.updateOptions({ fontSize: fontSize });
      }
      localStorage.setItem('editorFontSize', fontSize);
    });
  }

  // 防抖函数
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 格式化输入函数已移除，使用自动格式化替代

  // 解析JSON
  function parseJson(str) {
    if (!str.trim()) return {};
    return JSON.parse(str);
  }

  // 应用提取函数
  async function applyExtractFunction() {
    const extractFnStr = document.getElementById('extract-fn').value.trim();

    if (!extractFnStr) {
      showToast(translations.enterExtractionFn || 'Please enter an extraction function');
      return;
    }

    try {
      const inputText = getEditorContent();
      if (!inputText.trim()) {
        showToast(translations.enterData || 'Please enter data to process');
        return;
      }

      const parsedData = parseJson(inputText);
      const fn = new Function('obj', `return (${extractFnStr})(obj);`);
      const result = fn(parsedData);

      // 只有在应用提取函数后才显示输出框
      showJsonResult(result, 'Extraction Result');
    } catch (error) {
      showToast((translations.extractionError || 'Extraction error') + ': ' + error.message);
    }
  }

  // 清空输入
  function clearInputs() {
    setEditorContent('');
    document.getElementById('extract-fn').value = '';
    if (outputEditor) {
      outputEditor.setValue('');
    }
    closeOutput();

    // 重新显示提示
    const hint = document.getElementById('editor-hint');
    if (hint) {
      hint.classList.remove('hint-hidden');
    }
  }

  // 折叠所有
  function collapseAll() {
    // 折叠输入编辑器
    if (editor) {
      editor.getAction('editor.foldAll').run();
    }

    // 折叠输出编辑器
    if (outputEditor) {
      outputEditor.getAction('editor.foldAll').run();
    }
  }

  // 展开所有
  function expandAll() {
    // 展开输入编辑器
    if (editor) {
      editor.getAction('editor.unfoldAll').run();
    }

    // 展开输出编辑器
    if (outputEditor) {
      outputEditor.getAction('editor.unfoldAll').run();
    }
  }

  // 去除注释
  function removeComments() {
    let value = getEditorContent();
    value = value.replace(/\/\*[\s\S]*?\*\//g, '');
    value = value.replace(/\/\/.*/g, '');
    setEditorContent(value);
    // 触发自动格式化
    autoFormatJson();
  }

  // 压缩并复制
  async function compressAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const compressed = JSON.stringify(parsedData);
      await navigator.clipboard.writeText(compressed);
      showToast(translations.compressSuccess || 'Compressed JSON copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // 转义并复制
  async function escapeAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const compressed = JSON.stringify(parsedData);
      const escaped = compressed.replace(/[\\]/g, '\\\\').replace(/["]/g, '\\"');
      await navigator.clipboard.writeText(escaped);
      showToast(translations.escapeSuccess || 'Escaped JSON copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // JSON转XML并复制
  async function jsonToXmlAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const xmlString = jsonToXml(parsedData, 'root');
      await navigator.clipboard.writeText(xmlString);
      showToast(translations.xmlSuccess || 'XML copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // JSON转TypeScript并复制
  async function jsonToTsAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const tsInterface = jsonToTsInterface(parsedData, 'DataType');
      await navigator.clipboard.writeText(tsInterface);
      showToast(translations.tsSuccess || 'TypeScript interface copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // JSON转CSV并复制
  async function jsonToCsvAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const csvString = jsonToCsv(parsedData);
      await navigator.clipboard.writeText(csvString);
      showToast(translations.csvSuccess || 'CSV copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // JSON转Excel并复制（实际生成CSV格式，可直接导入Excel）
  async function jsonToExcelAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const csvString = jsonToCsv(parsedData);
      await navigator.clipboard.writeText(csvString);
      showToast(translations.excelSuccess || 'Excel data copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // ========== 方案1: JSON to YAML ==========
  async function jsonToYamlAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const yamlString = jsonToYaml(parsedData);
      await navigator.clipboard.writeText(yamlString);
      showToast(translations.yamlSuccess || 'YAML copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToYaml(obj, indent = 0) {
    const spaces = '  '.repeat(indent);

    if (obj === null || obj === undefined) {
      return 'null';
    }

    if (typeof obj !== 'object') {
      return String(obj);
    }

    if (Array.isArray(obj)) {
      if (obj.length === 0) return '[]';
      return obj.map(item => {
        if (typeof item === 'object' && item !== null) {
          return '-\n' + jsonToYaml(item, indent + 1).split('\n').map(line => spaces + line).join('\n').substring(2);
        } else {
          return '- ' + jsonToYaml(item, 0);
        }
      }).join('\n' + spaces);
    }

    // Object
    const entries = Object.entries(obj);
    if (entries.length === 0) return '{}';

    return entries.map(([key, value]) => {
      if (value === null) {
        return `${key}: null`;
      } else if (typeof value === 'object' && value !== null) {
        return `${key}:\n${jsonToYaml(value, indent + 1).split('\n').map(line => spaces + line).join('\n')}`;
      } else if (typeof value === 'string') {
        return `${key}: "${value}"`;
      } else {
        return `${key}: ${value}`;
      }
    }).join('\n' + spaces);
  }

  // ========== 方案1: JSON to Table ==========
  async function jsonToTable() {
    try {
      // 先重置界面到默认状态，清除其他功能的显示
      resetViewToDefault();

      const parsedData = parseJson(getEditorContent());
      const tableHtml = jsonToTableHtml(parsedData);

      // 在输出区域显示表格
      if (outputEditor) {
        const outputArea = document.getElementById('output-area');
        const outputContent = document.getElementById('output-content');

        // 创建一个临时容器来显示HTML
        const tempDiv = document.createElement('div');
        tempDiv.className = 'table-output';
        tempDiv.innerHTML = `
          <div style="padding: 20px; overflow: auto;">
            ${tableHtml}
          </div>
        `;

        // 隐藏编辑器，显示表格
        outputContent.querySelector('.monaco-editor-container')?.style.setProperty('display', 'none');
        const existingTable = outputContent.querySelector('.table-output');
        if (existingTable) {
          existingTable.remove();
        }
        outputContent.appendChild(tempDiv);

        expandOutput('JSON Table');
      }
      showToast(translations.tableSuccess || 'Table generated successfully!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToTableHtml(obj) {
    if (!obj || typeof obj !== 'object') {
      return '<p>Input is not a valid JSON object</p>';
    }

    if (Array.isArray(obj)) {
      if (obj.length === 0) {
        return '<p>Empty array</p>';
      }

      // 获取所有可能的键
      const allKeys = [...new Set(obj.flatMap(item => Object.keys(item || {})))];

      if (allKeys.length === 0) {
        return '<table class="json-table"><tbody><tr><td>Array with ' + obj.length + ' items (no properties)</td></tr></tbody></table>';
      }

      let html = '<table class="json-table"><thead><tr>';
      allKeys.forEach(key => {
        html += `<th>${escapeHtml(key)}</th>`;
      });
      html += '</tr></thead><tbody>';

      obj.forEach(item => {
        html += '<tr>';
        allKeys.forEach(key => {
          const value = item && item[key];
          html += `<td>${formatValueForTable(value)}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    // 对象转为表格
    const entries = Object.entries(obj);
    let html = '<table class="json-table"><tbody>';
    entries.forEach(([key, value]) => {
      html += '<tr>';
      html += `<td class="key-column"><strong>${escapeHtml(key)}</strong></td>`;
      html += `<td>${formatValueForTable(value)}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function formatValueForTable(value) {
    if (value === null || value === undefined) {
      return '<em>null</em>';
    }
    if (typeof value === 'object') {
      return `<code class="inline-code">${escapeHtml(JSON.stringify(value))}</code>`;
    }
    if (typeof value === 'boolean') {
      return `<span class="boolean-${value}">${value}</span>`;
    }
    if (typeof value === 'number') {
      return `<span class="number">${value}</span>`;
    }
    return escapeHtml(String(value));
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ========== 方案1: JSON Schema ==========
  async function jsonToSchema() {
    try {
      // 先重置界面到默认状态，清除其他功能的显示
      resetViewToDefault();

      const parsedData = parseJson(getEditorContent());
      const schema = generateJsonSchema(parsedData, 'RootObject');

      // 显示schema
      if (outputEditor) {
        const schemaStr = JSON.stringify(schema, null, 2);
        outputEditor.setValue(schemaStr);
        expandOutput('JSON Schema');
      }
      showToast(translations.schemaSuccess || 'JSON Schema generated successfully!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function generateJsonSchema(obj, typeName = 'Object') {
    if (obj === null || obj === undefined) {
      return { type: 'null' };
    }

    if (typeof obj === 'string') {
      return { type: 'string' };
    }

    if (typeof obj === 'number') {
      return { type: 'number' };
    }

    if (typeof obj === 'boolean') {
      return { type: 'boolean' };
    }

    if (Array.isArray(obj)) {
      if (obj.length > 0) {
        return {
          type: 'array',
          items: generateJsonSchema(obj[0])
        };
      }
      return {
        type: 'array',
        items: {}
      };
    }

    // Object
    const properties = {};
    const required = [];

    for (const [key, value] of Object.entries(obj)) {
      properties[key] = generateJsonSchema(value);
      required.push(key);
    }

    return {
      type: 'object',
      properties,
      required
    };
  }

  // ========== 方案2: JSON to HTML ==========
  async function jsonToHtmlAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const htmlString = jsonToHtml(parsedData);
      await navigator.clipboard.writeText(htmlString);
      showToast(translations.htmlSuccess || 'HTML copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToHtml(obj, indent = 0) {
    const spaces = '  '.repeat(indent);

    if (obj === null || obj === undefined) {
      return `${spaces}<span class="json-null">null</span>\n`;
    }

    if (typeof obj !== 'object') {
      const formatted = typeof obj === 'string' ? `"${obj}"` : String(obj);
      return `${spaces}<span class="json-value">${escapeHtml(formatted)}</span>\n`;
    }

    if (Array.isArray(obj)) {
      if (obj.length === 0) {
        return `${spaces}<span class="json-bracket">[]</span>\n`;
      }

      let html = `${spaces}<span class="json-bracket">[</span>\n`;
      obj.forEach((item, index) => {
        html += jsonToHtml(item, indent + 1);
        if (index < obj.length - 1) {
          html = html.trimEnd() + ',\n';
        }
      });
      html += `${spaces}<span class="json-bracket">]</span>\n`;
      return html;
    }

    // Object
    const entries = Object.entries(obj);
    if (entries.length === 0) {
      return `${spaces}<span class="json-bracket">{}</span>\n`;
    }

    let html = `${spaces}<div class="json-object">\n`;
    html += `${spaces}<span class="json-bracket">{</span>\n`;
    entries.forEach(([key, value], index) => {
      html += `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: `;
      if (typeof value === 'object' && value !== null) {
        html += '\n' + jsonToHtml(value, indent + 2);
      } else {
        html += jsonToHtml(value, 0).trim();
      }
      if (index < entries.length - 1) {
        html += ',';
      }
      html += '\n';
    });
    html += `${spaces}<span class="json-bracket">}</span>\n`;
    html += `${spaces}</div>\n`;
    return html;
  }

  // ========== 方案2: JSON to PDF ==========
  async function jsonToPdf() {
    try {
      const parsedData = parseJson(getEditorContent());

      // 使用html2pdf.js或jsPDF生成PDF
      // 这里使用简单的HTML打印方案
      const jsonStr = JSON.stringify(parsedData, null, 2);
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>JSON Export</title>
          <style>
            body { font-family: monospace; white-space: pre-wrap; padding: 20px; }
            @media print {
              body { padding: 0; }
            }
          </style>
        </head>
        <body>${escapeHtml(jsonStr)}</body>
        </html>
      `;

      // 创建新窗口并打印
      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.focus();

      setTimeout(() => {
        printWindow.print();
      }, 250);

      showToast(translations.pdfSuccess || 'PDF export initiated!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  // ========== 方案3: JSON to Dart ==========
  async function jsonToDartAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const dartCode = jsonToDart(parsedData, 'JsonObject');
      await navigator.clipboard.writeText(dartCode);
      showToast(translations.dartSuccess || 'Dart code copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToDart(obj, className = 'JsonObject') {
    if (Array.isArray(obj)) {
      if (obj.length > 0) {
        const itemClass = `${className}Item`;
        return `List<${itemClass}> ${camelCase(className)} = [${obj.map(() => `${itemClass}()`).join(', ')}];\n\n${jsonToDart(obj[0], itemClass)}`;
      }
      return `List<dynamic> ${camelCase(className)} = [];`;
    }

    if (typeof obj !== 'object' || obj === null) {
      return `final ${camelCase(className)} = ${obj === null ? 'null' : JSON.stringify(obj)};`;
    }

    let code = `class ${className} {\n`;

    // Fields
    for (const [key, value] of Object.entries(obj)) {
      const dartType = getDartType(value);
      const fieldName = camelCase(key);
      code += `  ${dartType} ${fieldName};\n`;
    }

    code += '\n';

    // Constructor
    code += `  ${className}({\n`;
    for (const [key] of Object.entries(obj)) {
      const fieldName = camelCase(key);
      code += `    this.${fieldName},\n`;
    }
    code += `  });\n\n`;

    // fromJson factory
    code += `  factory ${className}.fromJson(Map<String, dynamic> json) {\n`;
    code += `    return ${className}(\n`;
    for (const [key, value] of Object.entries(obj)) {
      const fieldName = camelCase(key);
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        code += `      ${fieldName}: ${fieldName}Class.fromJson(json['${key}']),\n`;
      } else {
        code += `      ${fieldName}: json['${key}'],\n`;
      }
    }
    code += `    );\n`;
    code += `  }\n\n`;

    // toJson method
    code += `  Map<String, dynamic> toJson() {\n`;
    code += `    return {\n`;
    for (const [key] of Object.entries(obj)) {
      const fieldName = camelCase(key);
      code += `      '${key}': this.${fieldName},\n`;
    }
    code += `    };\n`;
    code += `  }\n`;

    code += `}\n`;

    return code;
  }

  function getDartType(value) {
    if (value === null) return 'dynamic';
    if (typeof value === 'string') return 'String';
    if (typeof value === 'number') return Number.isInteger(value) ? 'int' : 'double';
    if (typeof value === 'boolean') return 'bool';
    if (Array.isArray(value)) return 'List<dynamic>';
    return 'Map<String, dynamic>';
  }

  // ========== 方案3: JSON to C ==========
  async function jsonToCAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const cCode = jsonToC(parsedData, 'JsonObject');
      await navigator.clipboard.writeText(cCode);
      showToast(translations.cSuccess || 'C code copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToC(obj, structName = 'JsonObject') {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `// Cannot generate C struct for ${typeof obj}`;
    }

    let code = `typedef struct {\n`;

    for (const [key, value] of Object.entries(obj)) {
      const cType = getCType(value);
      const fieldName = camelCase(key);
      code += `  ${cType} ${fieldName};\n`;
    }

    code += `} ${structName};\n`;

    return code;
  }

  function getCType(value) {
    if (value === null) return 'void*';
    if (typeof value === 'string') return 'char*';
    if (typeof value === 'number') return Number.isInteger(value) ? 'int' : 'double';
    if (typeof value === 'boolean') return 'bool';
    if (Array.isArray(value)) return 'void**';
    return 'void*';
  }

  // ========== 方案3: JSON to Go ==========
  async function jsonToGoAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const goCode = jsonToGo(parsedData, 'JsonObject');
      await navigator.clipboard.writeText(goCode);
      showToast(translations.goSuccess || 'Go code copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToGo(obj, structName = 'JsonObject') {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `// Cannot generate Go struct for ${typeof obj}`;
    }

    let code = `type ${structName} struct {\n`;

    for (const [key, value] of Object.entries(obj)) {
      const goType = getGoType(value);
      const fieldName = pascalCase(key);
      code += `  ${fieldName} ${goType} \`json:"${key}"\`\n`;
    }

    code += `}\n`;

    return code;
  }

  function getGoType(value) {
    if (value === null) return 'interface{}';
    if (typeof value === 'string') return 'string';
    if (typeof value === 'number') return Number.isInteger(value) ? 'int' : 'float64';
    if (typeof value === 'boolean') return 'bool';
    if (Array.isArray(value)) return '[]interface{}';
    return 'map[string]interface{}';
  }

  function pascalCase(str) {
    return str.replace(/(\w)(\w*)/g, (_, g1, g2) => g1.toUpperCase() + g2.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
  }

  // ========== 方案3: JSON to Rust ==========
  async function jsonToRustAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const rustCode = jsonToRust(parsedData, 'JsonObject');
      await navigator.clipboard.writeText(rustCode);
      showToast(translations.rustSuccess || 'Rust code copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToRust(obj, structName = 'JsonObject') {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `// Cannot generate Rust struct for ${typeof obj}`;
    }

    let code = `#[derive(Serialize, Deserialize)]\n`;
    code += `struct ${structName} {\n`;

    for (const [key, value] of Object.entries(obj)) {
      const rustType = getRustType(value);
      const fieldName = snakeCase(key);
      code += `  #[serde(rename = "${key}")]\n`;
      code += `  ${fieldName}: ${rustType},\n`;
    }

    code += `}\n`;

    return code;
  }

  function getRustType(value) {
    if (value === null) return 'Option<Value>';
    if (typeof value === 'string') return 'String';
    if (typeof value === 'number') return Number.isInteger(value) ? 'i64' : 'f64';
    if (typeof value === 'boolean') return 'bool';
    if (Array.isArray(value)) return 'Vec<Value>';
    return 'Value';
  }

  function snakeCase(str) {
    return str.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`).replace(/^_/, '').replace(/[^a-zA-Z0-9]/g, '_');
  }

  // ========== 方案3: JSON to Python ==========
  async function jsonToPythonAndCopy() {
    try {
      const parsedData = parseJson(getEditorContent());
      const pythonCode = jsonToPython(parsedData, 'JsonObject');
      await navigator.clipboard.writeText(pythonCode);
      showToast(translations.pythonSuccess || 'Python code copied to clipboard!');
    } catch (error) {
      showToast((translations.parsingError || 'Error') + ': ' + error.message);
    }
  }

  function jsonToPython(obj, className = 'JsonObject') {
    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
      return `# Cannot generate Python class for ${typeof obj}`;
    }

    let code = `from dataclasses import dataclass\nfrom typing import Optional, List, Any\n\n`;
    code += `@dataclass\nclass ${className}:\n`;

    for (const [key, value] of Object.entries(obj)) {
      const pythonType = getPythonType(value);
      const fieldName = snakeCase(key);
      code += `  ${fieldName}: ${pythonType}\n`;
    }

    return code;
  }

  function getPythonType(value) {
    if (value === null) return 'Optional[Any]';
    if (typeof value === 'string') return 'str';
    if (typeof value === 'number') return Number.isInteger(value) ? 'int' : 'float';
    if (typeof value === 'boolean') return 'bool';
    if (Array.isArray(value)) return 'List[Any]';
    return 'dict';
  }

  // 通用工具函数
  function camelCase(str) {
    return str.replace(/[-_\s]+(.)?/g, (_, c) => c ? c.toUpperCase() : '');
  }

  // JSON转XML辅助函数
  function jsonToXml(obj, tagName) {
    if (obj === null || obj === undefined) {
      return `<${tagName}></${tagName}>`;
    }

    if (typeof obj !== 'object') {
      return `<${tagName}>${obj}</${tagName}>`;
    }

    if (Array.isArray(obj)) {
      return obj.map(item => jsonToXml(item, tagName)).join('');
    }

    let xml = `<${tagName}>`;
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'object') {
          xml += jsonToXml(value, key);
        } else {
          xml += `<${key}>${value}</${key}>`;
        }
      }
    }
    xml += `</${tagName}>`;

    return xml;
  }

  // JSON转CSV辅助函数
  function jsonToCsv(obj) {
    // 处理空值
    if (obj === null || obj === undefined) {
      throw new Error('Input data cannot be empty');
    }

    // 确保输入是数组，如果是单个对象则转换为数组
    const jsonArray = Array.isArray(obj) ? obj : [obj];

    // 如果数组为空，返回空字符串
    if (jsonArray.length === 0) {
      throw new Error('Input array cannot be empty');
    }

    // 获取所有唯一的键作为CSV标题（使用Map保持插入顺序）
    const headersMap = new Map();
    let hasValidData = false;
    jsonArray.forEach(item => {
      if (typeof item === 'object' && item !== null) {
        const keys = Object.keys(item);
        if (keys.length > 0) {
          hasValidData = true;
          keys.forEach(key => headersMap.set(key, true));
        }
      }
    });

    // 如果没有有效数据，抛出错误
    if (!hasValidData) {
      throw new Error('No valid data to convert');
    }

    // 将Map的键转换为数组（保持顺序）
    const headerArray = Array.from(headersMap.keys());

    // 辅助函数：将任意值转换为CSV字符串
    function valueToCsvString(value) {
      // 处理null和undefined
      if (value === null || value === undefined) {
        return '';
      }

      // 处理对象和数组（转换为JSON字符串）
      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }

      // 转换为字符串
      let str = String(value);

      // 转义引号（将"变成""）
      str = str.replace(/"/g, '""');

      // 如果包含逗号、引号、换行符，用引号包裹
      if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
        str = `"${str}"`;
      }

      return str;
    }

    // 生成CSV内容
    let csv = headerArray.join(',') + '\n';

    // 遍历数组生成CSV行
    jsonArray.forEach(item => {
      const row = headerArray.map(header => {
        const value = item[header];
        return valueToCsvString(value);
      });
      csv += row.join(',') + '\n';
    });

    return csv;
  }

  // JSON转TypeScript接口辅助函数
  function jsonToTsInterface(obj, interfaceName) {
    if (typeof obj !== 'object' || obj === null) {
      return `// Cannot generate interface from non-object type`;
    }

    // If it's an array, use the first element to generate the interface
    let targetObj = obj;
    if (Array.isArray(obj)) {
      if (obj.length === 0) {
        return `// Cannot generate interface from empty array`;
      }
      // Use the first element of the array to generate the interface
      targetObj = obj[0];
      // If the first element is not an object, return error message
      if (typeof targetObj !== 'object' || targetObj === null) {
        return `// Cannot generate interface from non-object type`;
      }
    }

    let ts = `interface ${interfaceName} {\n`;

    for (const key in targetObj) {
      if (targetObj.hasOwnProperty(key)) {
        const value = targetObj[key];
        let type;

        if (value === null) {
          type = 'any';
        } else if (Array.isArray(value)) {
          if (value.length > 0) {
            const elementType = typeof value[0];
            if (elementType === 'object' && value[0] !== null) {
              // If array elements are objects, generate nested interface
              const nestedInterfaceName = `${key.charAt(0).toUpperCase() + key.slice(1)}Item`;
              type = `${nestedInterfaceName}[]`;
              ts += jsonToTsInterface(value[0], nestedInterfaceName);
            } else {
              // Otherwise use basic type
              type = `${getType(elementType)}[]`;
            }
          } else {
            type = 'any[]';
          }
        } else if (typeof value === 'object') {
          type = `${key.charAt(0).toUpperCase() + key.slice(1)}Type`;
          ts += jsonToTsInterface(value, type);
        } else {
          type = getType(typeof value);
        }

        ts += `  ${key}: ${type};\n`;
      }
    }

    ts += `}\n`;
    
    // If original input was an array, generate array type export
    if (Array.isArray(obj)) {
      ts += `\nexport type ${interfaceName}Array = ${interfaceName}[];\n`;
    }
    
    return ts;
  }

  // 获取类型字符串
  function getType(jsType) {
    switch(jsType) {
      case 'string': return 'string';
      case 'number': return 'number';
      case 'boolean': return 'boolean';
      case 'object': return 'object';
      default: return 'any';
    }
  }

  // 本地存储相关函数
  const HISTORY_KEY = 'json-formatter-history';
  const MAX_HISTORY_ITEMS = 50;

  // 保存历史记录
  function saveToHistory(data) {
    try {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      
      // 移除重复项
      const filteredHistory = history.filter(item => item.data !== data);
      
      // 添加到历史记录开头
      filteredHistory.unshift({
        id: Date.now(),
        data: data,
        timestamp: new Date().toISOString()
      });
      
      // 限制历史记录数量
      const limitedHistory = filteredHistory.slice(0, MAX_HISTORY_ITEMS);
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(limitedHistory));
    } catch (error) {
      console.error('保存历史记录失败:', error);
    }
  }

  // 获取历史记录
  function getHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (error) {
      console.error('获取历史记录失败:', error);
      return [];
    }
  }

  // 清除历史记录
  function clearHistory() {
    try {
      localStorage.removeItem(HISTORY_KEY);
    } catch (error) {
      console.error('清除历史记录失败:', error);
    }
  }

  // 显示历史记录
  function showHistory() {
    const history = getHistory();

    if (history.length === 0) {
      showToast(translations.noHistory || 'No history records');
      return;
    }
    
    // 创建遮罩层
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    `;
    
    // 创建历史记录弹窗
    const historyContainer = document.createElement('div');
    historyContainer.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 1200px;
      max-height: 90%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    `;
    
    // 创建标题行
    const header = document.createElement('div');
    header.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    `;
    
    // 创建标题
    const title = document.createElement('h3');
    title.textContent = 'History';
    title.style.cssText = `
      margin: 0;
      font-size: 18px;
    `;
    header.appendChild(title);
    
    // 创建关闭按钮
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '×';
    closeBtn.style.cssText = `
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    `;
    
    closeBtn.onmouseenter = () => {
      closeBtn.style.backgroundColor = '#f5f5f5';
    };
    
    closeBtn.onmouseleave = () => {
      closeBtn.style.backgroundColor = 'transparent';
    };
    
    closeBtn.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(historyContainer);
    };
    
    header.appendChild(closeBtn);
    historyContainer.appendChild(header);
    
    // 创建搜索框
    const searchContainer = document.createElement('div');
    searchContainer.style.cssText = `
      margin-bottom: 15px;
    `;
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = '搜索历史记录...';
    searchInput.style.cssText = `
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    `;
    
    searchContainer.appendChild(searchInput);
    historyContainer.appendChild(searchContainer);
    
    // 创建清除历史记录按钮
    const clearBtn = document.createElement('button');
    clearBtn.textContent = '清除所有历史记录';
    clearBtn.style.cssText = `
      margin-bottom: 15px;
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    `;
    
    clearBtn.onmouseenter = () => {
      clearBtn.style.backgroundColor = '#dc2626';
    };
    
    clearBtn.onmouseleave = () => {
      clearBtn.style.backgroundColor = '#ef4444';
    };
    
    clearBtn.onclick = () => {
      if (confirm('确定要清除所有历史记录吗？')) {
        clearHistory();
        document.body.removeChild(overlay);
        document.body.removeChild(historyContainer);
        showToast('历史记录已清除');
      }
    };
    
    historyContainer.appendChild(clearBtn);
    
    // 创建表格容器
    const tableContainer = document.createElement('div');
    tableContainer.style.cssText = `
      flex: 1;
      overflow: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    `;
    
    // 创建表格
    const table = document.createElement('table');
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    `;
    
    // 创建表头
    const thead = document.createElement('thead');
    thead.style.cssText = `
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 10;
    `;
    
    const headerRow = document.createElement('tr');
    const headers = ['序号', '时间', 'JSON数据', '操作'];
    const headerWidths = ['60px', '150px', 'auto', '120px'];
    
    headers.forEach((headerText, index) => {
      const th = document.createElement('th');
      th.textContent = headerText;
      th.style.cssText = `
        padding: 10px 8px;
        text-align: left;
        border-bottom: 2px solid #ddd;
        font-weight: 600;
        width: ${headerWidths[index]};
      `;
      headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // 创建表体
    const tbody = document.createElement('tbody');
    
    // 添加记录到表格的函数
    function addRecordsToTable(records) {
      tbody.innerHTML = '';
      
      records.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.style.cssText = `
          border-bottom: 1px solid #eee;
          transition: background-color 0.2s;
        `;
        
        tr.onmouseenter = () => {
          tr.style.backgroundColor = '#f5f5f5';
        };
        
        tr.onmouseleave = () => {
          tr.style.backgroundColor = 'transparent';
        };
        
        // 序号列
        const indexTd = document.createElement('td');
        indexTd.textContent = index + 1;
        indexTd.style.cssText = `
          padding: 8px;
          text-align: center;
          font-weight: 500;
        `;
        tr.appendChild(indexTd);
        
        // 时间列
        const timeTd = document.createElement('td');
        timeTd.textContent = new Date(item.timestamp).toLocaleString();
        timeTd.style.cssText = `
          padding: 8px;
          color: #666;
        `;
        tr.appendChild(timeTd);
        
        // JSON数据列
        const dataTd = document.createElement('td');
        dataTd.style.cssText = `
          padding: 8px;
          max-width: 500px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
          font-size: 12px;
          cursor: pointer;
          color: #2563eb;
        `;
        
        const jsonPreview = item.data.substring(0, 150) + (item.data.length > 150 ? '...' : '');
        dataTd.textContent = jsonPreview;
        dataTd.title = '点击复制完整JSON';
        
        // 点击JSON数据复制到剪贴板
        dataTd.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(item.data).then(() => {
            showToast('JSON已复制到剪贴板');
          }).catch(err => {
            console.error('复制失败:', err);
            showToast('复制失败，请重试');
          });
        };
        
        tr.appendChild(dataTd);
        
        // 操作列
        const actionTd = document.createElement('td');
        actionTd.style.cssText = `
          padding: 8px;
          display: flex;
          gap: 6px;
          justify-content: center;
        `;
        
        // 复制按钮
        const copyBtn = document.createElement('button');
        copyBtn.textContent = '复制';
        copyBtn.style.cssText = `
          padding: 4px 8px;
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: background-color 0.2s;
        `;
        
        copyBtn.onmouseenter = () => {
          copyBtn.style.backgroundColor = '#2563eb';
        };
        
        copyBtn.onmouseleave = () => {
          copyBtn.style.backgroundColor = '#3b82f6';
        };
        
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(item.data).then(() => {
            showToast('JSON已复制到剪贴板');
          }).catch(err => {
            console.error('复制失败:', err);
            showToast('复制失败，请重试');
          });
        };
        
        actionTd.appendChild(copyBtn);
        
        // 删除按钮
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '删除';
        deleteBtn.style.cssText = `
          padding: 4px 8px;
          background: #ef4444;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: background-color 0.2s;
        `;
        
        deleteBtn.onmouseenter = () => {
          deleteBtn.style.backgroundColor = '#dc2626';
        };
        
        deleteBtn.onmouseleave = () => {
          deleteBtn.style.backgroundColor = '#ef4444';
        };
        
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(translations.deleteConfirm || 'Are you sure you want to delete this record?')) {
            const updatedHistory = history.filter(h => h.id !== item.id);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));
            // 更新表格
            const filteredHistory = searchInput.value
              ? updatedHistory.filter(h => h.data.includes(searchInput.value))
              : updatedHistory;
            addRecordsToTable(filteredHistory);
            showToast(translations.recordDeleted || 'Record deleted');
          }
        };
        
        actionTd.appendChild(deleteBtn);
        tr.appendChild(actionTd);
        
        // 点击整行恢复数据
        tr.onclick = () => {
          setEditorContent(item.data);
          autoFormatJson();
          document.body.removeChild(overlay);
          document.body.removeChild(historyContainer);
        };
        
        tbody.appendChild(tr);
      });
    }
    
    // 初始加载所有记录
    addRecordsToTable(history);
    
    table.appendChild(tbody);
    tableContainer.appendChild(table);
    historyContainer.appendChild(tableContainer);
    
    // 添加搜索功能
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredHistory = history.filter(item => 
        item.data.toLowerCase().includes(searchTerm)
      );
      addRecordsToTable(filteredHistory);
    });
    
    // 点击遮罩层关闭弹窗
    overlay.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(historyContainer);
    };
    
    // 添加到页面
    document.body.appendChild(overlay);
    document.body.appendChild(historyContainer);
  }

  // 统一的界面重置函数 - 确保每次只显示一个功能
  function resetViewToDefault() {
    // 如果在比较模式，先退出
    if (isCompareMode) {
      const compareSection = document.getElementById('compare-section');
      const editorsWrapper = document.getElementById('editors-wrapper');
      const firstSection = document.querySelector('.input-section');

      isCompareMode = false;
      compareSection.classList.add('hidden');
      editorsWrapper.classList.remove('compare-mode');

      // 恢复编辑器标题
      const firstLabel = firstSection.querySelector('.section-label');
      if (firstLabel) {
        firstLabel.textContent = translations.sectionLabel || 'JSON 工具 - 格式化、转换为 ISON（节省 70% Token）、CSV 等';
      }

      // 清除高亮
      clearHighlightDecorations();

      // 清空比较编辑器
      if (compareEditor) {
        compareEditor.setValue('');
      }
    }

    // 清空所有可能的输出内容
    const outputContent = document.getElementById('output-content');
    if (outputContent) {
      // 移除所有特殊输出（表格、HTML等）
      const tableOutput = outputContent.querySelector('.table-output');
      const htmlOutput = outputContent.querySelector('.html-output');
      const schemaOutput = outputContent.querySelector('.schema-output');

      if (tableOutput) tableOutput.remove();
      if (htmlOutput) htmlOutput.remove();
      if (schemaOutput) schemaOutput.remove();

      // 恢复编辑器显示
      const editorContainer = outputContent.querySelector('.monaco-editor-container');
      if (editorContainer) {
        editorContainer.style.setProperty('display', 'block');
      }
    }

    // 重置输出区域为折叠状态
    const outputArea = document.getElementById('output-area');
    if (outputArea && outputArea.classList.contains('expanded')) {
      outputArea.classList.remove('expanded');
    }
  }

  // 切换比较模式
  function toggleCompareMode() {
    // 如果进入比较模式，先重置界面到默认状态
    if (!isCompareMode) {
      resetViewToDefault();
    }

    const compareSection = document.getElementById('compare-section');
    const editorsWrapper = document.getElementById('editors-wrapper');
    const firstSection = document.querySelector('.input-section');

    if (!isCompareMode) {
      // 进入比较模式 - 显示第二个编辑器
      isCompareMode = true;
      compareSection.classList.remove('hidden');
      editorsWrapper.classList.add('compare-mode');

      // 更新第一个编辑器标题
      const firstLabel = firstSection.querySelector('.section-label');
      if (firstLabel) {
        firstLabel.textContent = translations.leftJson || 'Left JSON';
      }

      // 立即更新差异高亮
      highlightDifferences();
    } else {
      // 退出比较模式
      isCompareMode = false;
      compareSection.classList.add('hidden');
      editorsWrapper.classList.remove('compare-mode');

      // 恢复编辑器标题
      const firstLabel = firstSection.querySelector('.section-label');
      if (firstLabel) {
        firstLabel.textContent = 'All-in-One JSON Viewer';
      }

      // 清除高亮
      clearHighlightDecorations();

      // 清空比较编辑器
      if (compareEditor) {
        compareEditor.setValue('');
      }
    }

    // 更新布局
    setTimeout(() => {
      if (editor) editor.layout();
      if (compareEditor) compareEditor.layout();
      if (outputEditor) outputEditor.layout();
    }, 100);
  }

// 在两个编辑器中高亮显示差异
  function highlightDifferences() {
    if (!editor || !compareEditor) return;

    // 清除之前的装饰
    clearHighlightDecorations();

    try {
      const leftText = editor.getValue();
      const rightText = compareEditor.getValue();

      if (!leftText.trim() || !rightText.trim()) return;

      const leftJson = JSON.parse(leftText);
      const rightJson = JSON.parse(rightText);

      // 找出差异，包含精确的行号和列号信息
      const differences = findDifferencesWithLineNumbers(leftText, rightText, leftJson, rightJson);

      // 在左侧编辑器中高亮差异
      const leftDecorationsData = differences
        .filter(d => d.type === 'removed' || d.type === 'changed')
        .map(d => ({
          range: new monaco.Range(
            d.line || 1,
            d.startColumn || 1,
            d.line || 1,
            d.endColumn || 1000
          ),
          options: {
            className: d.type === 'removed' ? 'diff-removed-decoration' : 'diff-changed-decoration',
            hoverMessage: { value: d.message },
            isWholeLine: d.isWholeLine || false
          }
        }));

      // 在右侧编辑器中高亮差异
      const rightDecorationsData = differences
        .filter(d => d.type === 'added' || d.type === 'changed')
        .map(d => ({
          range: new monaco.Range(
            d.line || 1,
            d.startColumn || 1,
            d.line || 1,
            d.endColumn || 1000
          ),
          options: {
            className: d.type === 'added' ? 'diff-added-decoration' : 'diff-changed-decoration',
            hoverMessage: { value: d.message },
            isWholeLine: d.isWholeLine || false
          }
        }));

      // 应用装饰
      if (editor && leftDecorationsData.length > 0) {
        leftDecorations = editor.deltaDecorations([], leftDecorationsData);
      }
      if (compareEditor && rightDecorationsData.length > 0) {
        rightDecorations = compareEditor.deltaDecorations([], rightDecorationsData);
      }
    } catch (error) {
      // JSON解析失败，不显示高亮
      console.debug('Highlight differences error:', error);
    }
  }

// 查找差异（返回带精确行号信息的差异）
  function findDifferencesWithLineNumbers(leftText, rightText, leftJson, rightJson) {
    const differences = [];

    // 解析文本行，用于精确定位
    const leftLines = leftText.split('\n');
    const rightLines = rightText.split('\n');

    function findKeyInLines(key, lines, startLine = 0) {
      const keyPattern = new RegExp(`"${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"\\s*:`);
      for (let i = startLine; i < lines.length; i++) {
        if (keyPattern.test(lines[i])) {
          const match = lines[i].match(keyPattern);
          if (match) {
            return {
              line: i + 1,
              startColumn: match.index + 1,
              endColumn: lines[i].length
            };
          }
        }
      }
      return { line: 1, startColumn: 1, endColumn: 1000 };
    }

    function compare(val1, val2, currentPath, parentLine = 1) {
      const type1 = typeof val1;
      const type2 = typeof val2;

      // 类型不同
      if (type1 !== type2) {
        const keyName = currentPath.split('.').pop();
        const position = findKeyInLines(keyName, leftLines, parentLine - 1);
        
        differences.push({
          type: 'changed',
          path: currentPath,
          oldValue: val1,
          newValue: val2,
          message: `${currentPath}: ${JSON.stringify(val1)} → ${JSON.stringify(val2)}`,
          line: position.line,
          startColumn: position.startColumn,
          endColumn: position.endColumn,
          isWholeLine: false
        });
        return;
      }

      // 如果是对象或数组，递归比较
      if (type1 === 'object' && val1 !== null && val2 !== null) {
        const keys1 = Object.keys(val1);
        const keys2 = Object.keys(val2);
        const allKeys = new Set([...keys1, ...keys2]);

        allKeys.forEach(key => {
          const newPath = currentPath ? `${currentPath}.${key}` : key;
          
          if (!(key in val1)) {
            // 新增 - 在右侧文本中查找位置
            const position = findKeyInLines(key, rightLines);
            differences.push({
              type: 'added',
              path: newPath,
              value: val2[key],
              message: `${newPath}: + ${JSON.stringify(val2[key])}`,
              line: position.line,
              startColumn: position.startColumn,
              endColumn: position.endColumn,
              isWholeLine: false
            });
          } else if (!(key in val2)) {
            // 删除 - 在左侧文本中查找位置
            const position = findKeyInLines(key, leftLines);
            differences.push({
              type: 'removed',
              path: newPath,
              value: val1[key],
              message: `${newPath}: - ${JSON.stringify(val1[key])}`,
              line: position.line,
              startColumn: position.startColumn,
              endColumn: position.endColumn,
              isWholeLine: false
            });
          } else {
            // 递归比较
            const keyPosition = findKeyInLines(key, leftLines);
            compare(val1[key], val2[key], newPath, keyPosition.line);
          }
        });
      } else if (val1 !== val2) {
        // 值不同
        const keyName = currentPath.split('.').pop();
        const position = findKeyInLines(keyName, leftLines);
        
        differences.push({
          type: 'changed',
          path: currentPath,
          oldValue: val1,
          newValue: val2,
          message: `${currentPath}: ${JSON.stringify(val1)} → ${JSON.stringify(val2)}`,
          line: position.line,
          startColumn: position.startColumn,
          endColumn: position.endColumn,
          isWholeLine: false
        });
      }
    }

    compare(leftJson, rightJson, '');

    return differences;
  }

// 保留原有的简单差异检测函数作为备用
  function findDifferences(obj1, obj2, path = '', depth = 0) {
    const differences = [];

    function compare(val1, val2, currentPath, currentLine = 0) {
      const type1 = typeof val1;
      const type2 = typeof val2;

      // 类型不同
      if (type1 !== type2) {
        differences.push({
          type: 'changed',
          path: currentPath,
          oldValue: val1,
          newValue: val2,
          message: `${currentPath}: ${JSON.stringify(val1)} → ${JSON.stringify(val2)}`,
          line: currentLine
        });
        return;
      }

      // 如果是对象或数组，递归比较
      if (type1 === 'object' && val1 !== null && val2 !== null) {
        const keys1 = Object.keys(val1);
        const keys2 = Object.keys(val2);
        const allKeys = new Set([...keys1, ...keys2]);

        allKeys.forEach((key, index) => {
          const newPath = currentPath ? `${currentPath}.${key}` : key;
          const lineOffset = Math.floor(index / 5); // 估算行号

          if (!(key in val1)) {
            // 新增
            differences.push({
              type: 'added',
              path: newPath,
              value: val2[key],
              message: `${newPath}: + ${JSON.stringify(val2[key])}`,
              line: currentLine + lineOffset
            });
          } else if (!(key in val2)) {
            // 删除
            differences.push({
              type: 'removed',
              path: newPath,
              value: val1[key],
              message: `${newPath}: - ${JSON.stringify(val1[key])}`,
              line: currentLine + lineOffset
            });
          } else {
            // 递归比较
            compare(val1[key], val2[key], newPath, currentLine + lineOffset);
          }
        });
      } else if (val1 !== val2) {
        // 值不同
        differences.push({
          type: 'changed',
          path: currentPath,
          oldValue: val1,
          newValue: val2,
          message: `${currentPath}: ${JSON.stringify(val1)} → ${JSON.stringify(val2)}`,
          line: currentLine
        });
      }
    }

    compare(obj1, obj2, path);

    return differences;
  }

  // 清除高亮装饰
  function clearHighlightDecorations() {
    if (editor && leftDecorations.length > 0) {
      editor.deltaDecorations(leftDecorations, []);
      leftDecorations = [];
    }
    if (compareEditor && rightDecorations.length > 0) {
      compareEditor.deltaDecorations(rightDecorations, []);
      rightDecorations = [];
    }
  }

  // 显示Toast提示
  function showToast(message) {
    // 检查是否已有Toast
    let toast = document.getElementById('toast-message');
    if (toast) {
      toast.remove();
    }
    
    toast = document.createElement('div');
    toast.id = 'toast-message';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      z-index: 1001;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease-out;
    `;
    
    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(toast);
    
    // 3秒后移除Toast
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease-out reverse';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
        if (style.parentNode) {
          style.parentNode.removeChild(style);
        }
      }, 300);
    }, 3000);
  }
</script>
